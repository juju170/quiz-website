<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buat Pertanyaan Baru - Komunitas Ceria</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Baloo 2', sans-serif; margin: 0; background-color: #f0f9ff; color: #333; }
    .container { max-width: 900px; margin: 30px auto; padding: 20px; }
    .page-header { text-align: center; margin-bottom: 30px; }
    .page-header h1 { font-size: 2.5rem; margin: 0; color: #0277bd; }
    .form-container { background-color: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
    .input-group { margin-bottom: 20px; }
    .input-group label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 1.1rem; }
    .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ccc; font-size: 1rem; box-sizing: border-box; }
    .dynamic-fields { margin-top: 20px; }
    .answer-pair { display: flex; gap: 10px; margin-bottom: 10px; }
    .answer-pair input { flex: 1; }
    .btn-small { background: #0288d1; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 700; }
    .btn-small:hover { background: #0277bd; }
    .submit-section { text-align: center; margin-top: 30px; }
    .btn-submit { padding: 15px 40px; font-size: 1.2rem; font-weight: 800; background-color: #ff8f00; border-bottom: 4px solid #e65100; cursor: pointer; border: none; border-radius: 8px; color: white; }
    .btn-submit:disabled { background-color: #9e9e9e; border-bottom: 4px solid #616161; cursor: not-allowed; }
    .message { text-align: center; padding: 15px; border-radius: 8px; font-weight: 700; margin-top: 20px; display: none; }
    .message.success { background-color: #e8f5e9; color: #2e7d32; }
    .message.error { background-color: #ffebee; color: #c62828; }
    .tombol-beranda { position: fixed; bottom: 20px; right: 20px; background-color: #FFC107; color: #333; padding: 12px 20px; border-radius: 50px; text-decoration: none; font-weight: 700; }
  </style>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <h1>Buat Pertanyaan Baru ‚úçÔ∏è</h1>
      <p>Satu pertanyaan yang kamu buat sangat berarti untuk teman sekelasmu!</p>
    </header>
    <main>
      <div id="kuota-container" class="kuota-container">Memeriksa data...</div>
      <form id="question-form" class="form-container">
        <fieldset id="form-fieldset" disabled>
          <div class="input-group">
            <label for="pertanyaan-teks">Tulis Pertanyaanmu</label>
            <textarea id="pertanyaan-teks" required rows="3"></textarea>
          </div>
          <div class="input-group">
            <label for="url-gambar">URL Gambar (Opsional)</label>
            <input type="url" id="url-gambar">
          </div>
          <div class="input-group">
            <label for="url-suara">URL Suara (Opsional)</label>
            <input type="url" id="url-suara">
          </div>
          <div class="input-group">
            <label for="kategori-pilihan">Pilih Kategori Soal</label>
            <select id="kategori-pilihan" required>
              <option value="">-- Pilih Mata Pelajaran --</option>
              <option value="matematika">Matematika</option>
              <option value="bahasa_indonesia">Bahasa Indonesia</option>
              <option value="bahasa_inggris">Bahasa Inggris</option>
              <option value="ipa">IPA</option>
              <option value="sejarah">Sejarah</option>
              <option value="ips">IPS</option>
              <option value="pkn">PKn</option>
              <option value="seni">Seni</option>
              <option value="olahraga">Olahraga</option>
              <option value="campuran_seru">Campuran Seru</option>
            </select>
          </div>
          <div class="input-group">
            <label for="tipe-soal">Tipe Soal</label>
            <select id="tipe-soal" required>
              <option value="pilihan_ganda">Pilihan Ganda</option>
              <option value="esai">Esai (jawaban bisa pakai ||)</option>
              <option value="pencocokan">Pencocokan</option>
              <option value="susun_kata">Susun Kata jadi Kalimat</option>
              <option value="multi_benar">Beberapa Jawaban Benar</option>
              <option value="benar_salah">Benar / Salah</option>
              <option value="tts_mini">TTS Mini</option>
            </select>
          </div>
          <div id="dynamic-fields" class="dynamic-fields"></div>
          <div class="submit-section">
            <button type="submit" id="submit-btn" class="btn-submit">Simpan Pertanyaan ‚úÖ</button>
          </div>
        </fieldset>
        <div id="message-box" class="message"></div>
      </form>
    </main>
  </div>
  <a href="index.html" class="tombol-beranda">üè† Beranda</a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, Timestamp, writeBatch, query, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc", authDomain: "forumwidara.firebaseapp.com", projectId: "forumwidara", storageBucket: "forumwidara.appspot.com", messagingSenderId: "216895655168", appId: "1:216895655168:web:59255f600fc3b3b44eb7e5" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const formFieldset = document.getElementById('form-fieldset');
    const questionForm = document.getElementById('question-form');
    const messageBox = document.getElementById('message-box');
    const kuotaContainer = document.getElementById('kuota-container');
    const tipeSoalSelect = document.getElementById('tipe-soal');
    const dynamicFields = document.getElementById('dynamic-fields');

    let currentUser = null;
    let userProfile = null;
    const MAX_QUOTA = 5;

    function showMessage(type, text) {
      messageBox.className = `message ${type}`;
      messageBox.textContent = text;
      messageBox.style.display = 'block';
      setTimeout(() => messageBox.style.display = 'none', 4000);
    }

    function renderDynamicFields(type) {
      dynamicFields.innerHTML = "";
      if (type === "pilihan_ganda") {
        for (let i = 0; i < 4; i++) {
          dynamicFields.innerHTML += `
            <div><input type="radio" name="correct" value="${i}" ${i===0?"checked":""}> 
              <input type="text" class="jawaban" placeholder="Pilihan ${i+1}"></div>`;
        }
      } else if (type === "esai") {
        dynamicFields.innerHTML = `<textarea id="esai-answer" placeholder="Jawaban benar, pisahkan dengan || jika variasi"></textarea>`;
      } else if (type === "pencocokan") {
        dynamicFields.innerHTML = `<div id="pairs"></div>
          <button type="button" class="btn-small" onclick="addPair()">+ Tambah Pasangan</button>`;
      } else if (type === "susun_kata") {
        dynamicFields.innerHTML = `<input id="susun-kata" placeholder="Kalimat benar">
          <textarea id="alasan-benar" placeholder="Alasan jika benar"></textarea>
          <textarea id="alasan-salah" placeholder="Alasan jika salah"></textarea>`;
      } else if (type === "multi_benar") {
        for (let i=0;i<4;i++) {
          dynamicFields.innerHTML += `<div><input type="checkbox" class="multi-check"> 
            <input type="text" class="multi-answer" placeholder="Jawaban ${i+1}">
            <input type="text" class="multi-reason" placeholder="Alasan"></div>`;
        }
      } else if (type === "benar_salah") {
        dynamicFields.innerHTML = `<label><input type="radio" name="bs" value="benar" checked> Benar</label>
          <label><input type="radio" name="bs" value="salah"> Salah</label>
          <textarea id="alasan-benar-bs" placeholder="Alasan jika benar"></textarea>
          <textarea id="alasan-salah-bs" placeholder="Alasan jika salah"></textarea>`;
      } else if (type === "tts_mini") {
        dynamicFields.innerHTML = `
          <input id="mendatar" placeholder="Jawaban Mendatar">
          <input id="menurun" placeholder="Jawaban Menurun">
          <input id="cross-index" type="number" placeholder="Index huruf yang sama (0-based)">
          <textarea id="alasan-semua-benar" placeholder="Alasan jika semua benar"></textarea>
          <textarea id="alasan-semua-salah" placeholder="Alasan jika semua salah"></textarea>
          <textarea id="alasan-mendatar" placeholder="Alasan jika mendatar saja benar"></textarea>
          <textarea id="alasan-menurun" placeholder="Alasan jika menurun saja benar"></textarea>`;
      }
    }

    window.addPair = function() {
      const div = document.createElement("div");
      div.className = "answer-pair";
      div.innerHTML = `<input placeholder="Kiri"><input placeholder="Kanan"><input placeholder="Alasan">`;
      document.getElementById("pairs").appendChild(div);
    };

    tipeSoalSelect.addEventListener("change", e => renderDynamicFields(e.target.value));

    async function checkUserData(user) {
      if (!user) return;
      const profileRef = doc(db, 'profiles', user.uid);
      const profileSnap = await getDoc(profileRef);
      if (!profileSnap.exists() || !profileSnap.data().class) {
        kuotaContainer.textContent = "Atur kelas di profil dulu!";
        formFieldset.disabled = true;
        return;
      }
      userProfile = profileSnap.data();
      formFieldset.disabled = false;
      kuotaContainer.textContent = "Kamu bisa membuat soal!";
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await checkUserData(user);
        renderDynamicFields(tipeSoalSelect.value);
      } else {
        window.location.href = 'index.html';
      }
    });

    questionForm.addEventListener("submit", async e => {
      e.preventDefault();
      const tipe = tipeSoalSelect.value;
      const data = {
        untukKelas: userProfile.class,
        teksPertanyaan: document.getElementById("pertanyaan-teks").value,
        kategori: document.getElementById("kategori-pilihan").value,
        dibuatOleh: currentUser.uid,
        dibuatPada: Timestamp.now(),
        tipeSoal: tipe,
        urlGambar: document.getElementById("url-gambar").value.trim() || null,
        urlSuara: document.getElementById("url-suara").value.trim() || null
      };

      if (tipe==="pilihan_ganda") {
        const opts = [...document.querySelectorAll(".jawaban")].map(i=>i.value);
        const correct = document.querySelector("input[name='correct']:checked").value;
        data.pilihanJawaban = opts;
        data.jawabanBenar = opts[correct];
      } else if (tipe==="esai") {
        data.jawabanBenar = document.getElementById("esai-answer").value;
      } else if (tipe==="pencocokan") {
        const pairs = [...document.querySelectorAll("#pairs .answer-pair")].map(div=>{
          const [l,r,a] = [...div.querySelectorAll("input")].map(i=>i.value);
          return {kiri:l, kanan:r, alasan:a};
        });
        data.pasangan = pairs;
      } else if (tipe==="susun_kata") {
        data.jawabanBenar = document.getElementById("susun-kata").value;
        data.alasan = {
          benar: document.getElementById("alasan-benar").value,
          salah: document.getElementById("alasan-salah").value
        };
      } else if (tipe==="multi_benar") {
        const rows = [...dynamicFields.querySelectorAll("div")];
        data.pilihan = rows.map(r=>{
          return {
            teks: r.querySelector(".multi-answer").value,
            benar: r.querySelector(".multi-check").checked,
            alasan: r.querySelector(".multi-reason").value
          };
        });
      } else if (tipe==="benar_salah") {
        data.jawabanBenar = document.querySelector("input[name='bs']:checked").value;
        data.alasan = {
          benar: document.getElementById("alasan-benar-bs").value,
          salah: document.getElementById("alasan-salah-bs").value
        };
      } else if (tipe==="tts_mini") {
        data.jawaban = {
          mendatar: document.getElementById("mendatar").value,
          menurun: document.getElementById("menurun").value,
          crossIndex: parseInt(document.getElementById("cross-index").value)
        };
        data.alasan = {
          semua_benar: document.getElementById("alasan-semua-benar").value,
          semua_salah: document.getElementById("alasan-semua-salah").value,
          mendatar: document.getElementById("alasan-mendatar").value,
          menurun: document.getElementById("alasan-menurun").value
        };
      }

      try {
        const batch = writeBatch(db);
        const pertanyaanRef = doc(collection(db, "pertanyaan"));
        batch.set(pertanyaanRef, data);
        await batch.commit();
        showMessage("success","Pertanyaan berhasil disimpan!");
        questionForm.reset();
        renderDynamicFields(tipeSoalSelect.value);
      } catch(err) {
        console.error(err);
        showMessage("error","Gagal simpan soal");
      }
    });
  </script>
</body>
</html>
