<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buat Kuis & Tantangan - Komunitas Ceria 2SD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Baloo 2', sans-serif; margin: 0; background-color: #f0f9ff; color: #333; }
        .container { max-width: 800px; margin: 30px auto; padding: 20px; }
        .page-header { text-align: center; margin-bottom: 30px; }
        .page-header h1 { font-size: 2.5rem; margin: 0; color: #0277bd; }
        .form-container { background-color: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 700; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ccc; box-sizing: border-box; font-size: 1rem; }
        .kuota-container { text-align: center; padding: 15px; background-color: #e3f2fd; border-radius: 10px; margin-bottom: 25px; font-weight: 700; }
        .kuota-container.no-quota { background-color: #ffebee; color: #c62828; }
        .submit-section { text-align: center; margin-top: 30px; }
        .btn-submit { padding: 15px 40px; font-size: 1.2rem; font-weight: 800; background-color: #ff8f00; border-bottom: 4px solid #e65100; cursor: pointer; border: none; border-radius: 8px; color: white; }
        .message { padding: 15px; border-radius: 8px; font-weight: 700; margin-top: 20px; display: none; }
        .message.success { background-color: #e8f5e9; color: #2e7d32; }
        .message.error { background-color: #ffebee; color: #c62828; }
        .tombol-beranda { position: fixed; bottom: 20px; right: 20px; background-color: #FFC107; color: #333; padding: 12px 20px; border-radius: 50px; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 1000; }
        /* ADMIN SECTION */
        #admin-panel { display: none; margin-top: 40px; border-top: 5px solid #0277bd; padding-top: 20px; }
        #admin-panel h2 { text-align: center; color: #0277bd; }
        .admin-form-container { background-color: #fffde7; border: 2px dashed #fbc02d; padding: 25px; border-radius: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header"><h1>Buat Konten Edukasi ‚úçÔ∏è</h1></header>
        <main>
            <!-- Bagian untuk Pengguna Biasa -->
            <div id="user-panel">
                <div id="kuota-container" class="kuota-container">Memeriksa kuota...</div>
                <form id="question-form" class="form-container">
                    <fieldset id="form-fieldset" disabled>
                        <h3>Buat Pertanyaan Baru</h3>
                        <div class="input-group">
                            <label for="kategori-pilihan">Pilih Kategori Soal</label>
                            <select id="kategori-pilihan" required>
                                <option value="">-- Pilih --</option>
                                <option value="matematika">Matematika</option>
                                <option value="bahasa_indonesia">Bahasa Indonesia</option>
                                <option value="ipa">IPA</option>
                                <option value="ips">IPS</option>
                                <option value="campuran_seru">Teka Teki Seru</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="pertanyaan-teks">Tulis Pertanyaan</label>
                            <textarea id="pertanyaan-teks" required rows="3"></textarea>
                        </div>
                        <div class="input-group">
                            <label>Tulis 4 Pilihan Jawaban (Pilihan pertama adalah jawaban benar)</label>
                            <input type="text" id="jawaban-benar" placeholder="Jawaban Benar" required style="margin-bottom:10px;">
                            <input type="text" id="pilihan-salah1" placeholder="Pilihan Salah 1" required style="margin-bottom:10px;">
                            <input type="text" id="pilihan-salah2" placeholder="Pilihan Salah 2" required style="margin-bottom:10px;">
                            <input type="text" id="pilihan-salah3" placeholder="Pilihan Salah 3" required>
                        </div>
                        <div class="submit-section">
                            <button type="submit" class="btn-submit">Simpan Pertanyaan</button>
                        </div>
                    </fieldset>
                    <div id="user-message-box" class="message"></div>
                </form>
            </div>

            <!-- Bagian Khusus Admin -->
            <div id="admin-panel">
                <form id="challenge-form" class="admin-form-container">
                    <h2>Panel Admin: Buat Tantangan Mingguan</h2>
                    <div class="input-group">
                        <label for="challenge-tema">Tema Tantangan</label>
                        <input type="text" id="challenge-tema" placeholder="Contoh: Petualangan Sains" required>
                    </div>
                    <div class="input-group">
                        <label for="challenge-kategori">Kategori Soal</label>
                        <select id="challenge-kategori" required>
                            <option value="">-- Pilih Kategori Soal --</option>
                            <option value="matematika">Matematika</option>
                            <option value="bahasa_indonesia">Bahasa Indonesia</option>
                            <option value="ipa">IPA</option>
                            <option value="ips">IPS</option>
                            <option value="campuran_seru">Teka Teki Seru</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="challenge-lencana">Pilih Lencana Hadiah</label>
                        <select id="challenge-lencana" required></select>
                    </div>
                    <div class="input-group">
                        <label for="challenge-timer">Total Waktu Pengerjaan (Menit)</label>
                        <input type="number" id="challenge-timer" min="1" placeholder="Contoh: 5" required>
                    </div>
                    <div class="input-group">
                        <label for="challenge-skor">Syarat Skor Minimum Lulus (%)</label>
                        <input type="number" id="challenge-skor" min="1" max="100" placeholder="Contoh: 80" required>
                    </div>
                    <div class="submit-section">
                        <button type="submit" class="btn-submit" style="background-color: #2e7d32; border-bottom-color: #1b5e20;">Aktifkan Tantangan Ini</button>
                    </div>
                </form>
                 <div id="admin-message-box" class="message"></div>
            </div>
        </main>
    </div>
    <a href="index.html" class="tombol-beranda">üè†</a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, doc, Timestamp, writeBatch, query, where, getDocs, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.firebasestorage.app",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const ADMIN_UIDS = ["iEko5tJpuMhywhA3dv63WAeqGw82"]; // <<< GANTI INI
        let currentUser = null;
        const MAX_QUOTA = 5;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if (ADMIN_UIDS.includes(user.uid)) {
                    document.getElementById('admin-panel').style.display = 'block';
                    await loadLencanaDropdown();
                }
                await checkAndDisplayQuota(user);
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- LOGIKA UNTUK PENGGUNA BIASA ---
        async function checkAndDisplayQuota(user) {
            const kuotaContainer = document.getElementById('kuota-container');
            const formFieldset = document.getElementById('form-fieldset');
            const startOfToday = new Date();
            startOfToday.setHours(0, 0, 0, 0);
            const q = query(collection(db, "userData", user.uid, "questionCreationTimestamp"), where("timestamp", ">=", Timestamp.fromDate(startOfToday)));
            const snapshot = await getDocs(q);
            const sisaKuota = MAX_QUOTA - snapshot.size;

            if (sisaKuota > 0) {
                kuotaContainer.textContent = `Sisa kuota membuat pertanyaan hari ini: ${sisaKuota}`;
                formFieldset.disabled = false;
            } else {
                kuotaContainer.textContent = `Kuota harian Anda sudah habis. Coba lagi besok!`;
                formFieldset.disabled = true;
            }
        }

        document.getElementById('question-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('form-fieldset').disabled = true;
            try {
                // Double check kuota before submitting
                const startOfToday = new Date();
                startOfToday.setHours(0, 0, 0, 0);
                const qCheck = query(collection(db, "userData", currentUser.uid, "questionCreationTimestamp"), where("timestamp", ">=", Timestamp.fromDate(startOfToday)));
                const snapshot = await getDocs(qCheck);
                if (snapshot.size >= MAX_QUOTA) throw new Error("Kuota harian Anda sudah habis.");

                const batch = writeBatch(db);
                const pertanyaanRef = doc(collection(db, "pertanyaan"));
                
                const pilihanJawaban = [
                    document.getElementById('jawaban-benar').value,
                    document.getElementById('pilihan-salah1').value,
                    document.getElementById('pilihan-salah2').value,
                    document.getElementById('pilihan-salah3').value
                ];

                const dataPertanyaan = {
                    teksPertanyaan: document.getElementById('pertanyaan-teks').value,
                    kategori: document.getElementById('kategori-pilihan').value,
                    dibuatOleh: currentUser.uid,
                    dibuatPada: Timestamp.now(),
                    pilihanJawaban: pilihanJawaban.sort(() => Math.random() - 0.5), // Acak posisi jawaban
                    jawabanBenar: document.getElementById('jawaban-benar').value
                };
                batch.set(pertanyaanRef, dataPertanyaan);

                const creationRecordRef = doc(collection(db, "userData", currentUser.uid, "questionCreationTimestamp"));
                batch.set(creationRecordRef, { timestamp: Timestamp.now() });
                
                await batch.commit();
                showMessage('user-message-box', 'success', 'Pertanyaan berhasil disimpan!');
                e.target.reset();
            } catch (error) {
                showMessage('user-message-box', 'error', error.message);
            } finally {
                await checkAndDisplayQuota(currentUser);
            }
        });

        // --- LOGIKA KHUSUS ADMIN ---
        async function loadLencanaDropdown() {
            const dropdown = document.getElementById('challenge-lencana');
            const q = query(collection(db, "lencana"));
            const snapshot = await getDocs(q);
            dropdown.innerHTML = '<option value="">-- Pilih Lencana --</option>';
            snapshot.forEach(doc => {
                dropdown.innerHTML += `<option value="${doc.id}">${doc.data().nama}</option>`;
            });
        }

        document.getElementById('challenge-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                // 1. Nonaktifkan tantangan lama
                const q = query(collection(db, "tantanganMingguan"), where("aktif", "==", true));
                const activeChallenges = await getDocs(q);
                for (const docSnap of activeChallenges.docs) {
                    await updateDoc(doc(db, "tantanganMingguan", docSnap.id), { aktif: false });
                }
            
                // 2. Buat tantangan baru
                await addDoc(collection(db, "tantanganMingguan"), {
                    tema: document.getElementById('challenge-tema').value,
                    kategori: document.getElementById('challenge-kategori').value,
                    lencanaId: document.getElementById('challenge-lencana').value,
                    timerMenit: parseInt(document.getElementById('challenge-timer').value),
                    syaratSkor: parseInt(document.getElementById('challenge-skor').value),
                    aktif: true,
                    createdAt: serverTimestamp()
                });
                showMessage('admin-message-box', 'success', 'Tantangan baru berhasil diaktifkan!');
                e.target.reset();
            } catch (error) {
                showMessage('admin-message-box', 'error', 'Gagal mengaktifkan tantangan.');
            }
        });

        function showMessage(boxId, type, text) {
            const messageBox = document.getElementById(boxId);
            messageBox.className = `message ${type}`;
            messageBox.textContent = text;
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, 4000);
        }
    </script>
</body>
</html>

