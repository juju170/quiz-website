<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis Tantangan Mingguan - Komunitas Ceria 2SD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Baloo 2', sans-serif; margin: 0; background-color: #ede7f6; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 800px; background-color: white; padding: 30px 40px; border-radius: 25px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .timer-display { font-size: 1.8rem; font-weight: 800; color: #c62828; background-color: #ffebee; padding: 5px 15px; border-radius: 10px; }
        .question-counter { font-size: 1.2rem; font-weight: 700; }
        .question-text { font-size: 1.5rem; margin-bottom: 30px; text-align: center; min-height: 60px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn { width: 100%; padding: 20px; font-size: 1.2rem; font-weight: 700; border-radius: 15px; border: 3px solid #d1c4e9; cursor: pointer; }
        .option-btn.correct { background-color: #a5d6a7; border-color: #388e3c; }
        .option-btn.wrong { background-color: #ef9a9a; border-color: #c62828; }
        .btn-next { padding: 12px 30px; font-size: 1.2rem; font-weight: 800; border: none; border-radius: 30px; background-color: #ffc107; cursor: pointer; display: none; }
        .result-title { font-size: 2.8rem; font-weight: 800; color: #673ab7; }
        .badge-unlocked { background-color: #fff9c4; padding: 25px; border-radius: 20px; margin-bottom: 30px; border: 3px solid #ffecb3; }
        .badge-info { display: flex; align-items: center; justify-content: center; gap: 20px; }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div id="loading-state" style="text-align: center;"><h1>Mempersiapkan Tantangan...</h1></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
        authDomain: "forumwidara.firebaseapp.com",
        projectId: "forumwidara",
        storageBucket: "forumwidara.firebasestorage.app",
        messagingSenderId: "216895655168",
        appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const container = document.getElementById('container');
    let currentUser, questions = [], currentQuestionIndex = 0, userAnswers = [], activeChallenge = null, questionTimerInterval;

    onAuthStateChanged(auth, (user) => user ? (currentUser = user, startQuiz()) : (window.location.href = 'login.html'));
    
    async function startQuiz() {
        const challengeQuery = query(collection(db, "tantanganMingguan"), where("aktif", "==", true));
        const challengeSnapshot = await getDocs(challengeQuery);
        if (challengeSnapshot.empty) {
            container.innerHTML = "<h1 style='text-align: center;'>Oops! Belum ada tantangan aktif.</h1>";
            return;
        }
        activeChallenge = { id: challengeSnapshot.docs[0].id, ...challengeSnapshot.docs[0].data() };

        const questionsQuery = query(collection(db, "pertanyaan"), where("kategori", "==", activeChallenge.kategori), where("isTantangan", "==", true), limit(10));
        const questionsSnapshot = await getDocs(questionsQuery);
        if (questionsSnapshot.empty) {
            container.innerHTML = `<h1 style='text-align: center;'>Oops! Belum ada soal tantangan untuk kategori "${activeChallenge.kategori}".</h1>`;
            return;
        }
        questions = questionsSnapshot.docs.map(doc => doc.data()).sort(() => 0.5 - Math.random());
        displayQuestion();
    }

    function displayQuestion() {
        const question = questions[currentQuestionIndex];
        container.innerHTML = `
            <div class="quiz-header">
                <div class="question-counter">Soal ${currentQuestionIndex + 1}/${questions.length}</div>
                <div id="timer-display" class="timer-display">--</div>
            </div>
            <p class="question-text">${question.teksPertanyaan}</p>
            <div id="options-grid" class="options-grid"></div>
            <div style="text-align:center; margin-top:20px;"><button id="next-button" class="btn-next">Lanjut</button></div>
        `;
        const optionsGrid = document.getElementById('options-grid');
        question.pilihanJawaban.forEach(option => {
            const button = document.createElement('button');
            button.className = 'option-btn';
            button.textContent = option;
            button.onclick = () => checkAnswer(button, option);
            optionsGrid.appendChild(button);
        });
        document.getElementById('next-button').onclick = () => {
            currentQuestionIndex++;
            currentQuestionIndex < questions.length ? displayQuestion() : showResults();
        };
        startTimer(question.timerDetik || 30);
    }

    function startTimer(duration) {
        let timeLeft = duration;
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.textContent = timeLeft;
        questionTimerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(questionTimerInterval);
                checkAnswer(null, "waktu_habis"); // Jawaban salah karena waktu habis
            }
        }, 1000);
    }

    function checkAnswer(selectedButton, selectedAnswer) {
        clearInterval(questionTimerInterval);
        const question = questions[currentQuestionIndex];
        userAnswers[currentQuestionIndex] = selectedAnswer;
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.disabled = true;
            if (btn.textContent === question.jawabanBenar) btn.classList.add('correct');
        });
        if (selectedButton && selectedAnswer !== question.jawabanBenar) {
            selectedButton.classList.add('wrong');
        }
        document.getElementById('next-button').style.display = 'inline-block';
    }

    async function showResults() {
        let correctAnswers = questions.filter((q, i) => userAnswers[i] === q.jawabanBenar).length;
        const score = Math.round((correctAnswers / questions.length) * 100);
        
        let resultHTML = `<div style="text-align:center;">
            <h1 class="result-title">Kuis Selesai!</h1>
            <p>Skor Kamu: <span style="font-size: 2rem; font-weight: 800;">${score}%</span></p>`;

        if (score >= activeChallenge.syaratSkor) {
            const badge = await getDoc(doc(db, "lencana", activeChallenge.lencanaId));
            if (badge.exists()) {
                const badgeData = badge.data();
                await setDoc(doc(db, `users/${currentUser.uid}/lencanaKu`, activeChallenge.lencanaId), {
                    namaLencana: badgeData.nama, ikonLencana: badgeData.ikon, diperolehPada: serverTimestamp()
                });
                resultHTML += `<div class="badge-unlocked">
                    <h3>Selamat, Kamu Lulus & Mendapat Lencana!</h3>
                    <div class="badge-info">
                        <img src="${badgeData.ikon}" alt="${badgeData.nama}" width="80" height="80" style="border-radius:50%;">
                        <p>${badgeData.nama}</p>
                    </div>
                </div>`;
            }
        } else {
            resultHTML += `<p>Skor kamu belum mencapai syarat kelulusan (${activeChallenge.syaratSkor}%). Coba lagi di tantangan berikutnya!</p>`;
        }
        resultHTML += `<a href="index.html" style="text-decoration:none; padding:15px 25px; background-color: #4caf50; color:white; border-radius:30px;">Kembali ke Beranda</a></div>`;
        container.innerHTML = resultHTML;
    }
</script>
</body>
</html>


