<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayo Main Kuis Ceria!</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #F0F9FF;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2393C5FD' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .quiz-card { background: white; border-radius: 24px; padding: 1.5rem 1rem; md:padding: 2.5rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); border: 2px solid white; transition: all 0.3s ease; }
        .btn-action { font-weight: 900; padding: 1rem; border-radius: 9999px; width: 100%; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 1.125rem; }
        .btn-action:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .btn-action:disabled { background: #D1D5DB !important; cursor: not-allowed; box-shadow: none; }
        
        /* === Gaya Tombol Jawaban === */
        .option-btn { border: 3px solid transparent; padding: 1rem; border-radius: 16px; font-size: 1.1rem; font-weight: 700; text-align: center; transition: all 0.2s ease-in-out; background-size: 200% auto; }
        .option-btn:hover:not(:disabled) { transform: scale(1.03); }
        .option-btn.selected { border-color: #1d4ed8; transform: scale(1.05); }
        .option-btn.correct { background-image: linear-gradient(to right, #34D399, #10B981, #34D399) !important; color: white !important; border-color: #047857 !important; animation: tada 0.8s; }
        .option-btn.incorrect { background-image: linear-gradient(to right, #F87171, #EF4444, #F87171) !important; color: white !important; border-color: #B91C1C !important; animation: shake 0.5s; }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.7; }

        /* === Animasi === */
        @keyframes tada { 0%{transform:scale(1)}10%,20%{transform:scale(.9) rotate(-3deg)}30%,50%,70%,90%{transform:scale(1.1) rotate(3deg)}40%,60%,80%{transform:scale(1.1) rotate(-3deg)}100%{transform:scale(1) rotate(0)} }
        @keyframes shake { 0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-10px)}20%,40%,60%,80%{transform:translateX(10px)} }
        @keyframes pop-in { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* === Gaya Spesifik Tipe Soal === */
        /* Susun Huruf */
        .letter-scramble { user-select: none; }
        .letter-scramble span { display: inline-block; padding: 0.5rem 1rem; margin: 0.25rem; background: linear-gradient(135deg, #fde68a, #f59e0b); color: #92400e; border-radius: 12px; font-weight: 900; font-size: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Pencocokkan */
        .matching-item { border: 2px dashed #9ca3af; padding: 0.75rem; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .matching-item.selected { border-style: solid; border-color: #3b82f6; background-color: #dbeafe; }
        
        /* TTS Mini */
        .tts-grid { display: grid; gap: 4px; }
        .tts-cell { width: 40px; height: 40px; text-align: center; font-size: 1.5rem; font-weight: 900; border-radius: 8px; border: 2px solid #cbd5e1; text-transform: uppercase; }
        .tts-cell:disabled { background-color: #f1f5f9; }
        .tts-cell.correct { background-color: #a7f3d0; border-color: #059669; }
        .tts-cell.incorrect { background-color: #fecaca; border-color: #dc2626; }
        
        /* Progress Bar */
        #progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 text-gray-800">
        
    <div id="loading-container" class="text-center">
        <h1 class="text-3xl font-black text-blue-600">Memuat Kuis Seru... ðŸŽ²</h1>
        <p class="text-gray-500 mt-2">Sebentar lagi kita mulai!</p>
    </div>

    <div id="quiz-container" class="hidden w-full max-w-2xl">
        <div class="w-full bg-gray-200 rounded-full h-4 mb-4 border-2 border-white shadow-inner">
            <div id="progress-bar" class="bg-gradient-to-r from-green-400 to-blue-500 h-full rounded-full" style="width: 0%"></div>
        </div>
        <main class="quiz-card" style="animation: pop-in 0.5s ease-out;">
            <p id="question-counter" class="text-right font-bold text-gray-400 mb-2">Soal 1/10</p>
            <h1 id="quiz-title" class="text-2xl font-black text-center mb-4 bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-pink-500">Judul Kuis</h1>
            
            <div id="question-area" class="min-h-[250px] flex flex-col justify-center">
                <p id="question-text" class="text-xl font-bold text-gray-700 mb-6 text-center">Teks Pertanyaan...</p>
                <div id="answer-options" class="space-y-3 mb-4"></div>
            </div>
            
            <div id="feedback-box" class="hidden p-4 rounded-lg text-center font-bold text-white my-4 transition-all duration-300"></div>

            <button id="action-btn" class="btn-action bg-gradient-to-r from-cyan-400 to-blue-500 text-white">Periksa Jawaban</button>
        </main>
    </div>
    
    <div id="results-container" class="hidden w-full max-w-md">
         <main class="quiz-card text-center" style="animation: pop-in 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;">
            <h1 class="text-4xl font-black text-gray-800">Hore, Selesai!</h1>
            <div class="bg-gradient-to-br from-yellow-200 to-orange-300 p-6 rounded-2xl my-8">
                <p class="text-lg font-bold text-yellow-800">SKOR AKHIR</p>
                <p id="score-text" class="text-7xl font-black text-white" style="-webkit-text-stroke: 3px #f97316;">0</p>
            </div>
            <p id="score-summary" class="text-lg text-gray-600 font-semibold"></p>
            <button onclick="location.reload()" class="btn-action mt-8 !bg-gradient-to-r from-green-500 to-emerald-500 text-white">Main Lagi!</button>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.appspot.com",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- State & Elemen Global ---
        let quizTitleText = '';
        let questions = [];
        let currentQuestionIndex = 0;
        let correctAnswersCount = 0;
        let isAnswerChecked = false;

        const loadingContainer = document.getElementById('loading-container');
        const quizContainer = document.getElementById('quiz-container');
        const resultsContainer = document.getElementById('results-container');
        const quizTitle = document.getElementById('quiz-title');
        const questionText = document.getElementById('question-text');
        const answerOptionsContainer = document.getElementById('answer-options');
        const feedbackBox = document.getElementById('feedback-box');
        const actionBtn = document.getElementById('action-btn');
        const progressBar = document.getElementById('progress-bar');
        const questionCounter = document.getElementById('question-counter');

        // --- Fungsi Helper ---
        const shuffleArray = (array) => array.sort(() => Math.random() - 0.5);

        // --- Fungsi Logika Kuis ---
        async function loadQuiz() {
            const params = new URLSearchParams(window.location.search);
            const quizId = params.get('quizId');

            if (!quizId) {
                loadingContainer.innerHTML = '<h1 class="text-2xl font-bold text-red-600">Kuis tidak ditemukan!</h1>';
                return;
            }

            try {
                const quizDocRef = doc(db, 'quizzes', quizId);
                const quizDoc = await getDoc(quizDocRef);

                if (quizDoc.exists()) {
                    quizTitleText = quizDoc.data().title;
                    const questionsSnapshot = await getDocs(collection(quizDocRef, 'questions'));
                    questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    shuffleArray(questions); // Acak urutan soal
                    startQuiz();
                } else {
                     loadingContainer.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Error: Kuis tidak ada.</h1>`;
                }
            } catch (error) {
                console.error("Gagal memuat kuis:", error);
                loadingContainer.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Gagal memuat kuis.</h1>`;
            }
        }
        
        function startQuiz() {
            currentQuestionIndex = 0;
            correctAnswersCount = 0;
            loadingContainer.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            quizTitle.textContent = quizTitleText;
            showQuestion();
        }

        function showQuestion() {
            isAnswerChecked = false;
            feedbackBox.classList.add('hidden');
            actionBtn.disabled = true;
            actionBtn.textContent = 'Periksa Jawaban';
            
            progressBar.style.width = `${((currentQuestionIndex) / questions.length) * 100}%`;
            questionCounter.textContent = `Soal ${currentQuestionIndex + 1}/${questions.length}`;

            const q = questions[currentQuestionIndex];
            questionText.textContent = q.question;
            answerOptionsContainer.innerHTML = '';
            
            renderAnswerOptions(q);
        }

        function handleActionClick() {
            if (!isAnswerChecked) {
                checkAnswer();
            } else {
                nextQuestion();
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                showQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            quizContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            const finalScore = Math.round((correctAnswersCount / questions.length) * 100);
            document.getElementById('score-text').textContent = finalScore;
            document.getElementById('score-summary').textContent = `Kamu berhasil menjawab ${correctAnswersCount} dari ${questions.length} soal dengan benar!`;
        }

        // --- Fungsi Render & Pengecekan Jawaban ---

        function renderAnswerOptions(q) {
            const optionColors = [
                'bg-gradient-to-r from-blue-400 to-cyan-400 text-white',
                'bg-gradient-to-r from-purple-400 to-pink-400 text-white',
                'bg-gradient-to-r from-yellow-400 to-orange-400 text-white',
                'bg-gradient-to-r from-lime-400 to-green-400 text-white'
            ];
            
            switch (q.type) {
                case 'pilihan-ganda':
                    shuffleArray(q.options).forEach((opt, i) => {
                        const btn = document.createElement('button');
                        btn.innerHTML = opt.text;
                        btn.className = `option-btn w-full ${optionColors[i % 4]}`;
                        btn.onclick = () => {
                            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            actionBtn.disabled = false;
                        };
                        answerOptionsContainer.appendChild(btn);
                    });
                    break;
                case 'benar-salah':
                    ['Benar', 'Salah'].forEach((opt, i) => {
                        const btn = document.createElement('button');
                        btn.textContent = opt;
                        btn.className = `option-btn w-full ${i === 0 ? optionColors[0] : optionColors[1]}`;
                        btn.onclick = () => {
                            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            actionBtn.disabled = false;
                        };
                        answerOptionsContainer.appendChild(btn);
                    });
                    break;
                case 'susun-huruf':
                    const scrambled = shuffleArray(q.answer.split('')).join('');
                    answerOptionsContainer.innerHTML = `
                        <div class="text-center mb-4 letter-scramble">
                            ${scrambled.split('').map(letter => `<span>${letter}</span>`).join('')}
                        </div>
                        <input type="text" id="susun-huruf-input" class="w-full p-3 text-center text-xl tracking-widest font-bold border-2 rounded-xl border-gray-300 focus:border-blue-500 outline-none uppercase" placeholder="Ketik jawabanmu...">
                    `;
                    document.getElementById('susun-huruf-input').oninput = (e) => actionBtn.disabled = e.target.value.trim() === '';
                    break;
                case 'pencocokkan':
                    const prompts = shuffleArray(q.matchingPairs.map(p => p.prompt));
                    const matches = shuffleArray(q.matchingPairs.map(p => p.match));
                    let selected = { prompt: null, match: null };
                    
                    answerOptionsContainer.innerHTML = `
                        <div class="grid grid-cols-2 gap-4" id="matching-grid">
                            <div class="space-y-2" id="matching-prompts"></div>
                            <div class="space-y-2" id="matching-matches"></div>
                        </div>
                    `;
                    const promptsContainer = document.getElementById('matching-prompts');
                    const matchesContainer = document.getElementById('matching-matches');

                    prompts.forEach(p => {
                        const item = document.createElement('div');
                        item.textContent = p;
                        item.className = 'matching-item prompt-item';
                        item.onclick = () => {
                            document.querySelectorAll('.prompt-item').forEach(i => i.classList.remove('selected'));
                            item.classList.add('selected');
                            selected.prompt = item;
                            if (selected.match) pairItems();
                        };
                        promptsContainer.appendChild(item);
                    });

                    matches.forEach(m => {
                        const item = document.createElement('div');
                        item.textContent = m;
                        item.className = 'matching-item match-item';
                        item.onclick = () => {
                             document.querySelectorAll('.match-item').forEach(i => i.classList.remove('selected'));
                            item.classList.add('selected');
                            selected.match = item;
                            if (selected.prompt) pairItems();
                        };
                        matchesContainer.appendChild(item);
                    });

                    const pairItems = () => {
                        selected.prompt.style.visibility = 'hidden';
                        selected.match.style.visibility = 'hidden';
                        selected.prompt.dataset.pairedWith = selected.match.textContent;
                        selected = { prompt: null, match: null };
                        if (document.querySelectorAll('.prompt-item[style*="visibility: hidden"]').length === prompts.length) {
                             actionBtn.disabled = false;
                        }
                    };
                    break;

                case 'susun-kalimat':
                    shuffleArray(q.sentenceOptions).forEach((opt, i) => {
                         const btn = document.createElement('button');
                        btn.textContent = opt;
                        btn.className = `option-btn w-full ${optionColors[i % 4]}`;
                        btn.onclick = () => {
                             document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            actionBtn.disabled = false;
                        };
                        answerOptionsContainer.appendChild(btn);
                    });
                    break;
                
                case 'tts-mini':
                    const { horizontal, vertical } = q.crossword;
                    let intersection = null;
                    // Cari titik potong
                    for (let i = 0; i < horizontal.length; i++) {
                        for (let j = 0; j < vertical.length; j++) {
                            if (horizontal[i] === vertical[j]) {
                                intersection = { char: horizontal[i], hIndex: i, vIndex: j };
                                break;
                            }
                        }
                        if (intersection) break;
                    }
                    if (!intersection) { 
                        answerOptionsContainer.innerHTML = '<p class="text-red-500">Soal TTS ini rusak.</p>'; 
                        return; 
                    }

                    const gridCols = horizontal.length;
                    const gridRows = vertical.length;
                    
                    const grid = document.createElement('div');
                    grid.className = 'tts-grid justify-center';
                    grid.style.gridTemplateColumns = `repeat(${gridCols}, 40px)`;

                    for (let row = 0; row < gridRows; row++) {
                        for (let col = 0; col < gridCols; col++) {
                            const cell = document.createElement('input');
                            cell.maxLength = 1;
                            cell.className = 'tts-cell';
                            cell.disabled = true;
                            
                            if (row === intersection.vIndex && col < horizontal.length) {
                                cell.disabled = false;
                                cell.dataset.word = 'h';
                                cell.dataset.index = col;
                            }
                            if (col === intersection.hIndex && row < vertical.length) {
                                cell.disabled = false;
                                cell.dataset.word = (cell.dataset.word || '') + 'v';
                                cell.dataset.indexV = row;
                            }
                            grid.appendChild(cell);
                        }
                    }
                    answerOptionsContainer.appendChild(grid);
                    grid.oninput = () => {
                        const inputs = grid.querySelectorAll('input:not(:disabled)');
                        const allFilled = [...inputs].every(i => i.value !== '');
                        actionBtn.disabled = !allFilled;
                    }
                    break;
                
                default:
                    answerOptionsContainer.innerHTML = `<p>Tipe soal tidak dikenali: ${q.type}</p>`;
            }
        }
        
        function checkAnswer() {
            isAnswerChecked = true;
            actionBtn.disabled = false;
            actionBtn.textContent = currentQuestionIndex === questions.length - 1 ? 'Lihat Hasil' : 'Lanjut';
            progressBar.style.width = `${((currentQuestionIndex + 1) / questions.length) * 100}%`;

            let isCorrect = false;
            const q = questions[currentQuestionIndex];
            
            // Disable all inputs
            answerOptionsContainer.querySelectorAll('button, input, .matching-item').forEach(el => el.disabled = true);

            switch (q.type) {
                case 'pilihan-ganda':
                    const selectedPgBtn = answerOptionsContainer.querySelector('.option-btn.selected');
                    const correctOption = q.options.find(opt => opt.isCorrect);
                    isCorrect = selectedPgBtn.textContent === correctOption.text;
                    answerOptionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.textContent === correctOption.text) btn.classList.add('correct');
                        else if (btn.classList.contains('selected')) btn.classList.add('incorrect');
                    });
                    break;
                case 'benar-salah':
                    const selectedBsBtn = answerOptionsContainer.querySelector('.option-btn.selected');
                    const answerText = q.answer ? 'Benar' : 'Salah';
                    isCorrect = selectedBsBtn.textContent === answerText;
                    answerOptionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.textContent === answerText) btn.classList.add('correct');
                        else if (btn.classList.contains('selected')) btn.classList.add('incorrect');
                    });
                    break;
                 case 'susun-huruf':
                    const input = document.getElementById('susun-huruf-input');
                    isCorrect = input.value.toUpperCase() === q.answer;
                    input.classList.add(isCorrect ? 'bg-green-100' : 'bg-red-100');
                    break;
                 case 'pencocokkan':
                    let correctPairs = 0;
                    const pairedItems = document.querySelectorAll('.prompt-item[data-paired-with]');
                    pairedItems.forEach(promptItem => {
                        const correctMatch = q.matchingPairs.find(p => p.prompt === promptItem.textContent).match;
                        if (promptItem.dataset.pairedWith === correctMatch) {
                            correctPairs++;
                        }
                    });
                    isCorrect = correctPairs === q.matchingPairs.length;
                    break;
                case 'susun-kalimat':
                    const selectedSentenceBtn = answerOptionsContainer.querySelector('.option-btn.selected');
                    isCorrect = selectedSentenceBtn.textContent === q.answer;
                    answerOptionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.textContent === q.answer) btn.classList.add('correct');
                        else if (btn.classList.contains('selected')) btn.classList.add('incorrect');
                    });
                    break;
                case 'tts-mini':
                    let allCorrect = true;
                    const inputs = answerOptionsContainer.querySelectorAll('input:not(:disabled)');
                    inputs.forEach(cell => {
                        let correctChar = '';
                        let cellIsCorrect = false;
                        if (cell.dataset.word.includes('h')) {
                            correctChar = q.crossword.horizontal[cell.dataset.index];
                        }
                        if (cell.dataset.word.includes('v')) {
                           correctChar = q.crossword.vertical[cell.dataset.indexV];
                        }

                        if (cell.value.toUpperCase() === correctChar) {
                            cell.classList.add('correct');
                            cellIsCorrect = true;
                        } else {
                            cell.classList.add('incorrect');
                            cellIsCorrect = false;
                        }
                        if (!cellIsCorrect) allCorrect = false;
                    });
                    isCorrect = allCorrect;
                    break;
            }

            if (isCorrect) {
                correctAnswersCount++;
                feedbackBox.className = 'p-4 rounded-lg text-center font-bold text-white bg-gradient-to-r from-green-400 to-emerald-500';
                feedbackBox.textContent = 'Benar! Kamu Hebat! âœ¨';
            } else {
                feedbackBox.className = 'p-4 rounded-lg text-center font-bold text-white bg-gradient-to-r from-red-400 to-rose-500';
                feedbackBox.textContent = 'Oops, coba lagi nanti ya!';
            }
            feedbackBox.style.animation = 'pop-in 0.3s';
        }

        actionBtn.addEventListener('click', handleActionClick);
        document.addEventListener('DOMContentLoaded', loadQuiz);
    </script>
</body>
</html>

