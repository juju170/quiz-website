<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayo Main Kuis Ceria!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #F0F9FF;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2393C5FD'%3E%3Cpath d='M0 7.5A7.5 7.5 0 0 1 7.5 0h45A7.5 7.5 0 0 1 60 7.5v45A7.5 7.5 0 0 1 52.5 60h-45A7.5 7.5 0 0 1 0 52.5v-45z' fill-opacity='.07'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .quiz-card { background: white; border-radius: 24px; padding: 1.5rem 1rem; md:padding: 2.5rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); border: 2px solid white; transition: all 0.3s ease; }
        .btn-action { font-weight: 900; padding: 1rem; border-radius: 9999px; width: 100%; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 1.1rem;}
        .btn-action:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .btn-action:disabled { background: #D1D5DB !important; cursor: not-allowed; box-shadow: none; }
        .option-btn { border: 3px solid transparent; padding: 1rem; border-radius: 16px; font-size: 1.1rem; font-weight: 700; text-align: center; transition: all 0.2s ease-in-out; background-size: 200% 100%; }
        .option-btn:hover:not(:disabled) { transform: scale(1.03); }
        .option-btn.selected { border-color: #1d4ed8; transform: scale(1.05); }
        .option-btn.correct { background-image: linear-gradient(to right, #34D399, #10B981, #34D399) !important; color: white !important; border-color: #047857 !important; animation: tada 0.8s; }
        .option-btn.incorrect { background-image: linear-gradient(to right, #F87171, #EF4444, #F87171) !important; color: white !important; border-color: #B91C1C !important; animation: shake 0.5s; }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        @keyframes tada { 0%{transform:scale(1)}10%,20%{transform:.9) rotate(-3deg)}30%,50%,70%,90%{transform:scale(1.1) rotate(3deg)}40%,60%,80%{transform:scale(1.1) rotate(-3deg)}100%{transform:scale(1) rotate(0)} }
        @keyframes shake { 0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-10px)}20%,40%,60%,80%{transform:translateX(10px)} }
        @keyframes pop-in { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .scramble-answer-box, .word-scramble-answer-box { min-height: 50px; background: #f3f4f6; border-radius: 12px; padding: 0.5rem; display: flex; flex-wrap: wrap; align-items: center; justify-content: flex-start; border: 2px solid #d1d5db; }
        .scramble-letter, .scramble-word { padding: 0.5rem 1rem; background: linear-gradient(135deg, #fde68a, #f59e0b); color: #92400e; border-radius: 8px; font-weight: 900; cursor: pointer; transition: all 0.2s; border: none; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .scramble-bank { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        .matching-item { border: 2px dashed #9ca3af; padding: 0.75rem; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .matching-item.selected-blue { border-style: solid; border-color: #3b82f6; background-color: #dbeafe; transform: scale(1.05); }
        .matching-item.selected-pink { border-style: solid; border-color: #ec4899; background-color: #fce7f3; transform: scale(1.05); }
        .matching-item.paired { border-style: solid; border-color: #10b981; background-color: #d1fae5; cursor: not-allowed; opacity: 0.8; }
        .tts-grid { display: grid; gap: 4px; }
        .tts-cell { width: 40px; height: 40px; text-align: center; font-size: 1.5rem; font-weight: 900; border-radius: 8px; border: 2px solid #cbd5e1; text-transform: uppercase; }
        .tts-cell.active { border-color: #3b82f6; background-color: #dbeafe; }
        .tts-cell:disabled { background-color: #f1f5f9; }
        .tts-cell.correct { background-color: #a7f3d0; border-color: #059669; }
        .tts-cell.incorrect { background-color: #fecaca; border-color: #dc2626; }
        #progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 text-gray-800">

    <div id="loading-container" class="text-center">
        <h1 class="text-3xl font-black text-blue-600">Memuat Kuis Seru... ðŸŽ²</h1>
        <p class="text-gray-500 mt-2">Sebentar lagi kita mulai!</p>
    </div>

    <div id="quiz-container" class="hidden w-full max-w-2xl">
        <div class="w-full bg-gray-200 rounded-full h-4 mb-4 border-2 border-white shadow-inner">
            <div id="progress-bar" class="bg-gradient-to-r from-green-400 to-blue-500 h-full rounded-full" style="width: 0%"></div>
        </div>
        <main class="quiz-card" style="animation: pop-in 0.5s ease-out;">
            <div class="flex justify-between items-center mb-2">
                <div id="timer-display" class="flex items-center gap-2 font-bold text-blue-600 text-lg">
                    <i data-lucide="clock" class="w-5 h-5"></i>
                    <span>--:--</span>
                </div>
                <p id="question-counter" class="font-bold text-gray-400">Soal 1/10</p>
            </div>            
            <h1 id="quiz-title" class="text-2xl font-black text-center mb-4 bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-pink-500">Judul Kuis</h1>
            <div id="question-area" class="min-h-[250px] flex flex-col justify-center">
                <p id="question-text" class="text-xl font-bold text-gray-700 mb-6 text-center">Teks Pertanyaan...</p>
                <div id="answer-options" class="space-y-3 mb-4"></div>
            </div>
            <div id="feedback-box" class="hidden p-4 rounded-lg text-center font-semibold my-4 transition-all duration-300"></div>
            <button id="action-btn" class="btn-action bg-gradient-to-r from-cyan-400 to-blue-500 text-white">Periksa Jawaban</button>
        </main>
    </div>

    <div id="results-container" class="hidden w-full max-w-md">
         <main class="quiz-card text-center" style="animation: pop-in 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;">
            <h1 class="text-4xl font-black text-gray-800">Hore, Selesai!</h1>
            <div class="bg-gradient-to-br from-yellow-200 to-orange-300 p-6 rounded-2xl my-8">
                <p class="text-lg font-bold text-yellow-800">SKOR AKHIR</p>
                <p id="score-text" class="text-7xl font-black text-white" style="-webkit-text-stroke: 3px #f97316;">0</p>
            </div>
            <p id="score-summary" class="text-lg text-gray-600 font-semibold"></p>
            <p class="mt-8 text-gray-500 animate-pulse">Kamu akan diarahkan ke halaman profil...</p>             
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, setDoc, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.appspot.com",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let quizId = '', announcementId = '', quizTitleText = '', questions = [], currentQuestionIndex = 0, correctAnswersCount = 0, isAnswerChecked = false;
        let quizBadgeThresholds = {};
        let timerInterval = null;
        let quizDurationInSeconds = 0;

        const loadingContainer = document.getElementById('loading-container');
        const quizContainer = document.getElementById('quiz-container');
        const resultsContainer = document.getElementById('results-container');
        const quizTitle = document.getElementById('quiz-title');
        const questionText = document.getElementById('question-text');
        const answerOptionsContainer = document.getElementById('answer-options');
        const feedbackBox = document.getElementById('feedback-box');
        const actionBtn = document.getElementById('action-btn');
        const progressBar = document.getElementById('progress-bar');
        const questionCounter = document.getElementById('question-counter');

        const shuffleArray = (array) => [...array].sort(() => Math.random() - 0.5);

        async function loadQuiz(userId) {
            quizId = new URLSearchParams(window.location.search).get('quizId');
            announcementId = new URLSearchParams(window.location.search).get('announcementId');
            if (!quizId) {
                loadingContainer.innerHTML = '<h1 class="text-2xl font-bold text-red-600">Kuis tidak ditemukan!</h1><p>Pastikan URL Anda memiliki `?quizId=...`</p>';
                return;
            }
            try {
                const quizDoc = await getDoc(doc(db, 'quizzes', quizId));
                if (quizDoc.exists()) {
                    const quizData = quizDoc.data();
                    quizDurationInSeconds = (quizData.duration || 10) * 60;
                    quizTitleText = quizData.title;
                    quizBadgeThresholds = quizData.badgeThresholds || {
                        gold: 90, silver: 75, bronze: 60
                    };
                    const questionsSnapshot = await getDocs(collection(quizDoc.ref, 'questions'));
                    questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    questions = shuffleArray(questions);
                    startQuiz(userId);
                } else {
                    loadingContainer.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Error: Kuis tidak ada.</h1>`;
                }
            } catch (error) {
                console.error("Gagal memuat kuis:", error);
                loadingContainer.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Gagal memuat kuis. Cek konsol untuk detail.</h1>`;
            }
        }

        function startQuiz(userId) {
            loadingContainer.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            quizTitle.textContent = quizTitleText;
            lucide.createIcons();
            startTimer(quizDurationInSeconds, userId);
            showQuestion();
        }

        function showQuestion() {
            isAnswerChecked = false;
            feedbackBox.classList.add('hidden');
            actionBtn.disabled = true;
            actionBtn.textContent = 'Periksa Jawaban';
            progressBar.style.width = `${((currentQuestionIndex) / questions.length) * 100}%`;
            questionCounter.textContent = `Soal ${currentQuestionIndex + 1}/${questions.length}`;
            const q = questions[currentQuestionIndex];
            questionText.textContent = q.question;
            answerOptionsContainer.innerHTML = '';
            renderAnswerOptions(q);
        }

        function handleActionClick(userId) {
            if (!isAnswerChecked) {
                checkAnswer();
            } else {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    showQuestion();
                } else {
                    showResults(userId);
                }
            }
        }

        function startTimer(durationInSeconds, userId) {
            const timerDisplay = document.querySelector("#timer-display span");
            let timer = durationInSeconds;
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                timerDisplay.textContent = minutes + ":" + seconds;
                if (--timer < 0) {
                    clearInterval(timerInterval);
                    feedbackBox.className = 'p-4 rounded-lg text-center font-semibold text-white bg-gradient-to-r from-orange-400 to-red-500';
                    feedbackBox.innerHTML = 'Waktu Habis!';
                    feedbackBox.classList.remove('hidden');
                    setTimeout(() => { showResults(userId); }, 1500);
                }
            }, 1000);
        }

        async function saveResultAndAwardBadges(score, userId) {
            try {
                await addDoc(collection(db, 'results'), {
                    userId: userId,
                    quizId: quizId,
                    announcementId: announcementId,
                    quizTitle: quizTitleText,
                    score: score,
                    completedAt: serverTimestamp()
                });
                let badgeType = null;
                let badgeMessage = "";
                if (score >= quizBadgeThresholds.gold) {
                    badgeType = 'gold';
                    badgeMessage = "îžé†‡ Kamu dapat Lencana Emas!";
                } else if (score >= quizBadgeThresholds.silver) {
                    badgeType = 'silver';
                    badgeMessage = "îžï½¥Kamu dapat Lencana Perak!";
                } else if (score >= quizBadgeThresholds.bronze) {
                    badgeType = 'bronze';
                    badgeMessage = "îžï½¥Kamu dapat Lencana Perunggu!";
                }
                if (badgeType) {
                    const profileRef = doc(db, 'profiles', userId);    
                    await setDoc(profileRef, {
                        badges: { [badgeType]: increment(1) },
                        name: "Siswa Keren"
                    }, { merge: true });
                    const badgeTextEl = document.getElementById('badge-award-text');
                    if(badgeTextEl) {
                        badgeTextEl.textContent = badgeMessage;
                        badgeTextEl.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error("Gagal menyimpan hasil atau memberi lencana:", error);
            }
        }

        async function showResults(userId) { 
            clearInterval(timerInterval);
            quizContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            const finalScore = Math.round((correctAnswersCount / questions.length) * 100);
            document.getElementById('score-text').textContent = finalScore;
            document.getElementById('score-summary').textContent = `Kamu berhasil menjawab ${correctAnswersCount} dari ${questions.length} soal dengan benar!`;
            await saveResultAndAwardBadges(finalScore, userId);
            setTimeout(() => { window.location.href = 'profile.html'; }, 4000); 
        }

        function renderAnswerOptions(q) {
            const optionColors = ['from-blue-400 to-cyan-400', 'from-purple-400 to-pink-400', 'from-yellow-400 to-orange-400', 'from-lime-400 to-green-400', 'from-red-400 to-rose-400'];

            switch (q.type) {
                case 'pilihan-ganda':
                    shuffleArray(q.options).forEach((opt, i) => {
                        const btn = document.createElement('button');
                        btn.innerHTML = opt.text;
                        btn.className = `option-btn w-full bg-gradient-to-r ${optionColors[i % 5]} text-white`;
                        btn.dataset.explanation = opt.explanation;
                        btn.onclick = () => {
                            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            actionBtn.disabled = false;
                        };
                        answerOptionsContainer.appendChild(btn);
                    });
                    break;
                case 'benar-salah':
                    ['Benar', 'Salah'].forEach((opt, i) => {
                        const btn = document.createElement('button');
                        btn.textContent = opt;
                        btn.className = `option-btn w-full bg-gradient-to-r ${i === 0 ? optionColors[0] : optionColors[4]} text-white`;
                        btn.onclick = () => {
                            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                            btn.classList.add('selected');
                            actionBtn.disabled = false;
                        };
                        answerOptionsContainer.appendChild(btn);
                    });
                    break;
                case 'esai':
    answerOptionsContainer.innerHTML = `
        <textarea id="esai-input" class="input-field w-full" rows="3" placeholder="Tulis jawabanmu di sini..."></textarea>
    `;
    // Aktifkan tombol jika ada input
    document.getElementById('esai-input').addEventListener('input', (e) => {
        actionBtn.disabled = !e.target.value.trim();
    });
    break;
                case 'susun-huruf':
                    const decoys = q.decoys || [];
                    const letters = shuffleArray([...q.answer.split(''), ...decoys]);
                    answerOptionsContainer.innerHTML = `
                        <div id="susun-huruf-answer-display" class="scramble-answer-box text-2xl tracking-widest uppercase"></div>
                        <div id="susun-huruf-letters" class="scramble-bank mt-4"></div>
                    `;
                    const answerBox = document.getElementById('susun-huruf-answer-display');
                    const letterBank = document.getElementById('susun-huruf-letters');

                    letters.forEach(letter => {
                        const btn = document.createElement('button');
                        btn.textContent = letter;
                        btn.className = 'scramble-letter text-2xl';
                        btn.onclick = () => {
                            answerBox.appendChild(btn);
                            actionBtn.disabled = answerBox.children.length === 0;
                        };
                        letterBank.appendChild(btn);
                    });

                    answerBox.onclick = (e) => {
                        if (e.target.classList.contains('scramble-letter')) {
                            letterBank.appendChild(e.target);
                            actionBtn.disabled = answerBox.children.length === 0;
                        }
                    };
                    break;
                case 'susun-kalimat':
                    const wordsToShuffle = Array.isArray(q.words) && q.words.length > 0
                        ? q.words
                        : (q.correctAnswers && q.correctAnswers[0] ? q.correctAnswers[0].split(' ') : []);

                    const words = shuffleArray(wordsToShuffle);
                    answerOptionsContainer.innerHTML = `
                        <div id="susun-kalimat-answer-display" class="word-scramble-answer-box text-xl"></div>
                        <div id="susun-kalimat-words" class="scramble-bank mt-4"></div>
                    `;
                    const sentenceAnswerBox = document.getElementById('susun-kalimat-answer-display');
                    const wordBank = document.getElementById('susun-kalimat-words');

                    words.forEach(word => {
                        const btn = document.createElement('button');
                        btn.textContent = word;
                        btn.className = 'scramble-word text-lg';
                        btn.onclick = () => {
                            sentenceAnswerBox.appendChild(btn);
                            actionBtn.disabled = sentenceAnswerBox.children.length === 0;
                        };
                        wordBank.appendChild(btn);
                    });

                    sentenceAnswerBox.onclick = (e) => {
                        if (e.target.classList.contains('scramble-word')) {
                            wordBank.appendChild(e.target);
                            actionBtn.disabled = sentenceAnswerBox.children.length === 0;
                        }
                    };
                    break;
                case 'pencocokkan':
                    const prompts = shuffleArray(q.matchingPairs.map(p => p.prompt));
                    const matches = shuffleArray(q.matchingPairs.map(p => p.match));
                    let selected = { prompt: null, match: null };

                    answerOptionsContainer.innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div id="matching-prompts" class="space-y-2"></div>
                            <div id="matching-matches" class="space-y-2"></div>
                        </div>
                    `;
                    const promptsContainer = document.getElementById('matching-prompts');
                    const matchesContainer = document.getElementById('matching-matches');

                    prompts.forEach((p, i) => {
                        const item = document.createElement('div');
                        item.textContent = p;
                        item.className = 'matching-item prompt-item';
                        item.dataset.id = i;
                        item.onclick = () => handleSelect(item, 'prompt');
                        promptsContainer.appendChild(item);
                    });

                    matches.forEach((m, i) => {
                        const item = document.createElement('div');
                        item.textContent = m;
                        item.className = 'matching-item match-item';
                        item.dataset.id = i;
                        item.onclick = () => handleSelect(item, 'match');
                        matchesContainer.appendChild(item);
                    });

                    function handleSelect(item, type) {
                        if (item.classList.contains('paired')) {
                            let promptItem, matchItem;
                            if (item.classList.contains('prompt-item')) {
                                promptItem = item;
                                const partnerText = item.dataset.pairedWith;
                                matchItem = Array.from(document.querySelectorAll('.match-item.paired'))
                                                .find(el => el.textContent === partnerText);
                            } else {
                                matchItem = item;
                                const partnerText = item.textContent;
                                promptItem = Array.from(document.querySelectorAll('.prompt-item.paired'))
                                                    .find(el => el.dataset.pairedWith === partnerText);
                            }
                            if (promptItem && matchItem) {
                                promptItem.classList.remove('paired');
                                matchItem.classList.remove('paired');
                                delete promptItem.dataset.pairedWith;
                                actionBtn.disabled = true;
                            }
                            return;
                        }
                        if (item.classList.contains('selected-blue') || item.classList.contains('selected-pink')) {
                            item.classList.remove('selected-blue', 'selected-pink');
                            selected[type] = null;
                            return;
                        }
                        document.querySelectorAll(`.${type}-item`).forEach(i => i.classList.remove(type === 'prompt' ? 'selected-blue' : 'selected-pink'));
                        item.classList.add(type === 'prompt' ? 'selected-blue' : 'selected-pink');
                        selected[type] = item;
                        if (selected.prompt && selected.match) {
                            selected.prompt.classList.add('paired');
                            selected.match.classList.add('paired');
                            selected.prompt.classList.remove('selected-blue');
                            selected.match.classList.remove('selected-pink');
                            selected.prompt.dataset.pairedWith = selected.match.textContent;
                            selected = { prompt: null, match: null };
                            if (document.querySelectorAll('.prompt-item.paired').length === prompts.length) {
                                actionBtn.disabled = false;
                            }
                        }
                    }
                    break;
                case 'tts-mini':
                    const { horizontal, vertical } = q.crossword;
                    let intersection = null;
                    for (let i = 0; i < horizontal.length; i++) {
                        for (let j = 0; j < vertical.length; j++) {
                            if (horizontal[i] === vertical[j]) {
                                intersection = { hIndex: i, vIndex: j }; break;
                            }
                        }
                        if (intersection) break;
                    }
                    if (!intersection) { 
                        answerOptionsContainer.innerHTML = '<p class="text-red-500">Soal TTS ini rusak.</p>'; return; 
                    }
                    const gridCols = Math.max(horizontal.length, intersection.vIndex + 1);
                    const gridRows = Math.max(vertical.length, intersection.hIndex + 1);
                    const ttsLetters = shuffleArray([...new Set((horizontal + vertical).split(''))]);
                    answerOptionsContainer.innerHTML = `
                        <div class="flex justify-center">
                            <div id="tts-grid-container" class="tts-grid" style="grid-template-columns: repeat(${gridCols}, 40px);"></div>
                        </div>
                        <div id="tts-letter-bank" class="scramble-bank mt-4"></div>
                    `;
                    const grid = document.getElementById('tts-grid-container');
                    for (let r = 0; r < gridRows; r++) {
                        for (let c = 0; c < gridCols; c++) {
                            const isHorizontal = r === intersection.vIndex && c < horizontal.length;
                            const isVertical = c === intersection.hIndex && r < vertical.length;
                            if (isHorizontal || isVertical) {
                                const cell = document.createElement('div');
                                cell.className = 'tts-cell cursor-pointer';
                                cell.dataset.row = r;
                                cell.dataset.col = c;
                                if (isHorizontal) { cell.dataset.hIndex = c; }
                                if (isVertical) { cell.dataset.vIndex = r; }
                                cell.onclick = () => {
                                    document.querySelectorAll('.tts-cell').forEach(c => c.classList.remove('active'));
                                    cell.classList.add('active');
                                };
                                grid.appendChild(cell);
                            } else {
                                grid.appendChild(document.createElement('div'));
                            }
                        }
                    }
                    const ttsLetterBank = document.getElementById('tts-letter-bank');
                    ttsLetters.forEach(letter => {
                        const btn = document.createElement('button');
                        btn.textContent = letter;
                        btn.className = 'scramble-letter text-2xl';
                        btn.onclick = () => {
                            const activeCell = grid.querySelector('.tts-cell.active');
                            if (activeCell) {
                                activeCell.textContent = letter;
                                let nextCell = findNextEmpty(activeCell);
                                if(nextCell) {
                                    activeCell.classList.remove('active');
                                    nextCell.classList.add('active');
                                }
                            }
                            actionBtn.disabled = [...grid.querySelectorAll('.tts-cell')].some(c => !c.textContent);
                        };
                        ttsLetterBank.appendChild(btn);
                    });
                    const findNextEmpty = (el) => {
                        let current = el;
                        while(current.nextElementSibling) {
                            current = current.nextElementSibling;
                            if(current.matches('.tts-cell') && !current.textContent) return current;
                        }
                        current = grid.querySelector('.tts-cell');
                        while(current && current !== el) {
                            if(!current.textContent) return current;
                            current = current.nextElementSibling;
                        }
                        return null;
                    };
                    break;
                default:
                    answerOptionsContainer.innerHTML = `<p>Tipe soal tidak dikenali: ${q.type}</p>`;
            }
        }

        function checkAnswer() {
            isAnswerChecked = true;
            actionBtn.disabled = false;
            actionBtn.textContent = currentQuestionIndex === questions.length - 1 ? 'Lihat Hasil' : 'Lanjut';
            progressBar.style.width = `${((currentQuestionIndex + 1) / questions.length) * 100}%`;

            let isCorrect = false;
            let feedbackText = '';
            const q = questions[currentQuestionIndex];

            answerOptionsContainer.querySelectorAll('button, input, textarea, .matching-item, .tts-cell').forEach(el => el.style.pointerEvents = 'none');

            switch (q.type) {
                case 'pilihan-ganda': {
                    const selectedBtn = answerOptionsContainer.querySelector('.option-btn.selected');
                    const correctOption = q.options.find(opt => opt.isCorrect);
                    isCorrect = selectedBtn.textContent === correctOption.text;
                    feedbackText = selectedBtn ? `Penjelasan: ${selectedBtn.dataset.explanation}` : '';
                    answerOptionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.textContent === correctOption.text) btn.classList.add('correct');
                        else if (btn.classList.contains('selected')) btn.classList.add('incorrect');
                    });
                    break;
                }
                case 'benar-salah': {
                    const selectedBtn = answerOptionsContainer.querySelector('.option-btn.selected');
                    const answerText = q.answer ? 'Benar' : 'Salah';
                    isCorrect = selectedBtn.textContent === answerText;
                    let alasan = '';
                    if (q.explanation && typeof q.explanation === 'object') {
                        if (isCorrect && q.explanation.right) alasan = q.explanation.right;
                        else if (!isCorrect && q.explanation.wrong) alasan = q.explanation.wrong;
                    }
                    feedbackText = alasan ? `Penjelasan: ${alasan}` : '';
                    answerOptionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.textContent === answerText) btn.classList.add('correct');
                        else if (btn.classList.contains('selected')) btn.classList.add('incorrect');
                    });
                    break;
                }
                case 'esai': {
    const userAnswer = document.getElementById('esai-input').value.trim().toLowerCase();
    let possibleAnswers = Array.isArray(q.answer) ? q.answer : [q.answer];
    possibleAnswers = possibleAnswers.map(a => a.trim().toLowerCase());
    isCorrect = possibleAnswers.includes(userAnswer);
    let alasan = '';
    if (q.explanation && typeof q.explanation === 'object') {
        if (isCorrect && q.explanation.right) alasan = q.explanation.right;
        else if (!isCorrect && q.explanation.wrong) alasan = q.explanation.wrong;
    }
    feedbackText = alasan ? `Penjelasan: ${alasan}` : (isCorrect ? '' : `Jawaban yang benar: <strong>${possibleAnswers[0]}</strong>`);
    break;
                }
                case 'susun-huruf': {
                    const userAnswer = [...document.getElementById('susun-huruf-answer-display').children].map(c => c.textContent).join('');
                    isCorrect = userAnswer === q.answer;
                    let alasan = '';
                    if (q.explanation && typeof q.explanation === 'object') {
                        if (isCorrect && q.explanation.right) alasan = q.explanation.right;
                        else if (!isCorrect && q.explanation.wrong) alasan = q.explanation.wrong;
                    }
                    feedbackText = alasan ? `Penjelasan: ${alasan}` : (isCorrect ? '' : `Jawaban yang benar: <strong>${q.answer}</strong>`);
                    document.getElementById('susun-huruf-answer-display').parentElement.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    break;
                }
                case 'susun-kalimat': {
                    const userAnswer = [...document.getElementById('susun-kalimat-answer-display').children].map(c => c.textContent).join(' ');
                    isCorrect = q.correctAnswers.includes(userAnswer);
                    let alasan = '';
                    if (q.explanation && typeof q.explanation === 'object') {
                        if (isCorrect && q.explanation.right) alasan = q.explanation.right;
                        else if (!isCorrect && q.explanation.wrong) alasan = q.explanation.wrong;
                    }
                    feedbackText = alasan ? `Penjelasan: ${alasan}` : (isCorrect ? '' : `Salah satu jawaban yang benar: <strong>${q.correctAnswers[0]}</strong>`);
                    document.getElementById('susun-kalimat-answer-display').parentElement.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    break;
                }
                case 'pencocokkan': {
                    let correctPairs = 0;
                    let feedbackList = [];
                    document.querySelectorAll('.prompt-item.paired').forEach(promptItem => {
                        const pasangan = q.matchingPairs.find(p => p.prompt === promptItem.textContent);
                        const userMatch = promptItem.dataset.pairedWith;
                        let benar = userMatch === pasangan.match;
                        if (benar) correctPairs++;
                        let alasan = pasangan.explanation && (benar ? pasangan.explanation.right : pasangan.explanation.wrong);
                        feedbackList.push(`<li>${pasangan.prompt} = <b>${userMatch}</b> &mdash; <span class="text-${benar ? 'green' : 'red'}-600">${benar ? 'Benar' : 'Salah'}</span>${alasan ? ': '+alasan : ''}</li>`);
                    });
                    isCorrect = correctPairs === q.matchingPairs.length;
                    feedbackText = `<ul class="text-left ml-4">${feedbackList.join('')}</ul>`;
                    break;
                }
                case 'tts-mini': {
                    const { horizontal, vertical, explanations } = q.crossword;
                    let userHorizontal = '', userVertical = '';
                    let intersection = null;
                    for (let i = 0; i < horizontal.length; i++) {
                        for (let j = 0; j < vertical.length; j++) {
                            if (horizontal[i] === vertical[j]) {
                                intersection = { hIndex: i, vIndex: j }; break;
                            }
                        }
                        if (intersection) break;
                    }
                    const grid = document.getElementById('tts-grid-container');
                    for (let i = 0; i < horizontal.length; i++) {
                        const cell = grid.querySelector(`.tts-cell[data-row='${intersection.vIndex}'][data-col='${i}']`);
                        userHorizontal += (cell && cell.textContent) ? cell.textContent.toUpperCase() : '';
                    }
                    for (let j = 0; j < vertical.length; j++) {
                        const cell = grid.querySelector(`.tts-cell[data-row='${j}'][data-col='${intersection.hIndex}']`);
                        userVertical += (cell && cell.textContent) ? cell.textContent.toUpperCase() : '';
                    }
                    const horCorrect = userHorizontal === horizontal;
                    const verCorrect = userVertical === vertical;
                    let alasan = '';
                    if (horCorrect && verCorrect && explanations.bothCorrect) alasan = explanations.bothCorrect;
                    else if (!horCorrect && !verCorrect && explanations.bothWrong) alasan = explanations.bothWrong;
                    else if (horCorrect && !verCorrect && explanations.horizontalCorrect) alasan = explanations.horizontalCorrect;
                    else if (!horCorrect && verCorrect && explanations.verticalCorrect) alasan = explanations.verticalCorrect;
                    isCorrect = horCorrect && verCorrect;
                    feedbackText = alasan ? `Penjelasan: ${alasan}` : '';
                    for (let i = 0; i < horizontal.length; i++) {
                        const cell = grid.querySelector(`.tts-cell[data-row='${intersection.vIndex}'][data-col='${i}']`);
                        if (cell) cell.classList.add(horCorrect ? 'correct' : 'incorrect');
                    }
                    for (let j = 0; j < vertical.length; j++) {
                        if(j === intersection.vIndex) continue;
                        const cell = grid.querySelector(`.tts-cell[data-row='${j}'][data-col='${intersection.hIndex}']`);
                        if (cell) cell.classList.add(verCorrect ? 'correct' : 'incorrect');
                    }
                    break;
                }
            }
            if (isCorrect) {
                correctAnswersCount++;
                feedbackBox.className = 'p-4 rounded-lg text-center font-semibold text-white bg-gradient-to-r from-green-400 to-emerald-500';
                feedbackBox.innerHTML = 'Benar! Kamu Hebat! âœ¨<br>' + feedbackText;
            } else {
                feedbackBox.className = 'p-4 rounded-lg text-center font-semibold text-white bg-gradient-to-r from-red-400 to-rose-500';
                feedbackBox.innerHTML = 'Oops, belum tepat. <br>' + feedbackText;
            }
            feedbackBox.classList.remove('hidden');
            feedbackBox.style.animation = 'pop-in 0.3s';
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const realUserId = user.uid;
                loadQuiz(realUserId);
                actionBtn.addEventListener('click', () => handleActionClick(realUserId));
            } else {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
