<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Pertanyaan Saya - Komunitas Ceria 2SD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Baloo 2', sans-serif; margin: 0; background-color: #f0f9ff; color: #333; }
        .container { max-width: 900px; margin: 30px auto; padding: 20px; }
        .page-header { text-align: center; margin-bottom: 30px; }
        .page-header h1 { font-size: 2.5rem; margin: 0; color: #0277bd; }
        .header-actions { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
        .header-actions a { color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 700; display: inline-block; transition: background-color 0.2s; }
        .btn-add { background-color: #388e3c; }
        .btn-add:hover { background-color: #4caf50; }
        .btn-back { background-color: #78909c; }
        .btn-back:hover { background-color: #90a4ae; }
        
        #question-list-container { display: grid; gap: 20px; }
        .question-card { display: flex; justify-content: space-between; align-items: center; background-color: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); flex-wrap: wrap; gap: 15px; }
        .question-info p { margin: 0; font-size: 1.2rem; font-weight: 700; flex-grow: 1; }
        .question-info .tags { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .question-info .tag { font-size: 0.9rem; font-weight: 700; padding: 4px 12px; border-radius: 15px; display: inline-block; }
        .tag.kategori { background-color: #e3f2fd; color: #1e88e5; }
        .tag.tipe-pg { background-color: #ede7f6; color: #5e35b1; }
        .tag.tipe-esai { background-color: #e0f2f1; color: #00796b; }
        
        .btn-delete-question { background-color: #e57373; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; padding: 10px 15px; }
        #loader { text-align: center; padding: 50px; font-size: 1.5rem; font-weight: 700; color: #0277bd; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; width: 90%; }
        .modal-content h4 { margin-top: 0; }
        .modal-actions { margin-top: 20px; display: flex; gap: 15px; justify-content: center; }
        .modal-actions button { padding: 10px 25px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; }
        .btn-confirm-delete { background-color: #f44336; color: white; }
        .btn-cancel { background-color: #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <h1>Kelola Pertanyaan Saya</h1>
            <p>Lihat atau hapus pertanyaan yang pernah Anda buat.</p>
            <!-- Tombol Kembali dan Buat Baru -->
            <div class="header-actions">
                <a href="buat-kuis.html" class="btn-add">‚ûï Buat Pertanyaan Baru</a>
                <a href="index.html" class="btn-back">üè† Kembali ke Beranda</a>
            </div>
        </header>
        <main id="question-list-container">
            <div id="loader">Memuat pertanyaan Anda...</div>
        </main>
    </div>
    <div id="delete-modal" class="modal-backdrop">
        <div class="modal-content">
            <h4>Hapus Pertanyaan Ini?</h4>
            <p>Tindakan ini akan menghapus pertanyaan dan semua jawabannya secara permanen.</p>
            <div class="modal-actions">
                <button id="cancel-delete-btn" class="btn-cancel">Batal</button>
                <button id="confirm-delete-btn" class="btn-confirm-delete">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, writeBatch } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.firebasestorage.app",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loader = document.getElementById('loader');
        const questionListContainer = document.getElementById('question-list-container');
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        let currentUser = null;
        let questionIdToDelete = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserQuestions(user.uid);
            } else {
                loader.innerHTML = '<h2>Anda harus login untuk melihat halaman ini.</h2><a href="login.html">Login Sekarang</a>';
            }
        });

        async function loadUserQuestions(userId) {
            loader.style.display = 'block';
            questionListContainer.innerHTML = '';
            try {
                const q = query(collection(db, 'pertanyaan'), where('dibuatOleh', '==', userId));
                const querySnapshot = await getDocs(q);

                loader.style.display = 'none';

                if (querySnapshot.empty) {
                    questionListContainer.innerHTML = '<p style="text-align:center;">Anda belum pernah membuat pertanyaan.</p>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const question = doc.data();
                    
                    // --- PERBAIKAN: Identifikasi tipe soal ---
                    const isEsai = question.tipeSoal === 'esai';
                    const tipeSoalTeks = isEsai ? 'Esai' : 'Pilihan Ganda';
                    const tipeSoalClass = isEsai ? 'tipe-esai' : 'tipe-pg';
                    
                    const questionCard = document.createElement('div');
                    questionCard.className = 'question-card';
                    questionCard.innerHTML = `
                        <div class="question-info">
                            <p>${question.teksPertanyaan}</p>
                            <div class="tags">
                                <span class="tag kategori">Kategori: ${question.kategori}</span>
                                <span class="tag ${tipeSoalClass}">${tipeSoalTeks}</span>
                            </div>
                        </div>
                        <button class="btn-delete-question" data-question-id="${doc.id}">Hapus</button>
                    `;
                    questionListContainer.appendChild(questionCard);
                });

            } catch (error)
             {
                console.error("Error memuat pertanyaan:", error);
                loader.innerHTML = '<h2>Oops! Terjadi kesalahan.</h2>';
            }
        }
        
        questionListContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-delete-question')) {
                questionIdToDelete = e.target.dataset.questionId;
                deleteModal.style.display = 'flex';
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            questionIdToDelete = null;
            deleteModal.style.display = 'none';
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!questionIdToDelete) return;

            confirmDeleteBtn.textContent = 'Menghapus...';
            confirmDeleteBtn.disabled = true;

            try {
                const batch = writeBatch(db);
                const answersRef = collection(db, `pertanyaan/${questionIdToDelete}/jawaban`);
                const answersSnapshot = await getDocs(answersRef);
                answersSnapshot.forEach(answerDoc => batch.delete(answerDoc.ref));
                
                const questionRef = doc(db, 'pertanyaan', questionIdToDelete);
                batch.delete(questionRef);
                
                await batch.commit();
                await loadUserQuestions(currentUser.uid);

            } catch (error) {
                console.error("Gagal menghapus pertanyaan:", error);
                alert('Terjadi kesalahan saat menghapus.');
            } finally {
                questionIdToDelete = null;
                deleteModal.style.display = 'none';
                confirmDeleteBtn.textContent = 'Ya, Hapus';
                confirmDeleteBtn.disabled = false;
            }
        });
    </script>
</body>
</html>

