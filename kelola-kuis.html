<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Kuis Saya - Komunitas Ceria 2SD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Baloo 2', sans-serif;
            margin: 0;
            background-color: #f0f9ff;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
        }
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .page-header h1 {
            font-size: 2.5rem;
            margin: 0;
            color: #0277bd;
        }
        .page-header .btn-add {
            background-color: #388e3c;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 700;
            display: inline-block;
            margin-top: 15px;
            transition: background-color 0.2s;
        }
        .page-header .btn-add:hover {
            background-color: #4caf50;
        }
        #quiz-list-container {
            display: grid;
            gap: 20px;
        }
        .quiz-card {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: box-shadow 0.3s;
        }
        .quiz-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .quiz-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.4rem;
        }
        .quiz-info p {
            margin: 0;
            color: #555;
            font-size: 0.9rem;
        }
        .btn-toggle-details {
            background-color: #64b5f6;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
        }
        /* Detail Pertanyaan (Accordion Content) */
        .question-details {
            margin-top: 20px;
            border-top: 2px dashed #eee;
            padding-top: 20px;
            display: none; /* Awalnya disembunyikan */
        }
        .question-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #fafafa;
        }
        .question-item p {
            margin: 0;
            flex-grow: 1;
        }
        .btn-delete-question {
            background-color: #e57373;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            padding: 5px 10px;
            margin-left: 15px;
        }
        #loader {
            text-align: center;
            padding: 50px;
            font-size: 1.5rem;
            font-weight: 700;
            color: #0277bd;
        }
        /* Modal Konfirmasi */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 30px; border-radius: 15px;
            text-align: center; max-width: 400px;
        }
        .modal-content h4 { margin-top: 0; }
        .modal-actions { margin-top: 20px; display: flex; gap: 15px; justify-content: center; }
        .modal-actions button {
            padding: 10px 25px; border-radius: 8px; border: none;
            font-weight: 700; cursor: pointer;
        }
        .btn-confirm-delete { background-color: #f44336; color: white; }
        .btn-cancel { background-color: #ccc; }
    </style>
</head>
<body>

    <div class="container">
        <header class="page-header">
            <h1>Kelola Kuis Saya</h1>
            <p>Lihat atau hapus pertanyaan yang pernah Anda buat.</p>
            <a href="buat-kuis.html" class="btn-add">âž• Buat Kuis Baru</a>
        </header>

        <main id="quiz-list-container">
            <div id="loader">Memuat kuis Anda...</div>
        </main>
    </div>

    <div id="delete-modal" class="modal-backdrop">
        <div class="modal-content">
            <h4>Hapus Pertanyaan Ini?</h4>
            <p>Tindakan ini akan menghapus pertanyaan dan semua jawabannya secara permanen. Ini tidak dapat diurungkan.</p>
            <div class="modal-actions">
                <button id="cancel-delete-btn" class="btn-cancel">Batal</button>
                <button id="confirm-delete-btn" class="btn-confirm-delete">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.firebasestorage.app",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loader = document.getElementById('loader');
        const quizListContainer = document.getElementById('quiz-list-container');
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        let currentUser = null;
        let itemToDelete = { quizId: null, questionId: null };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserQuizzes(user.uid);
            } else {
                loader.innerHTML = '<h2>Anda harus login untuk melihat halaman ini.</h2><a href="login.html">Login Sekarang</a>';
            }
        });

        async function loadUserQuizzes(userId) {
            loader.style.display = 'block';
            quizListContainer.innerHTML = ''; // Kosongkan daftar sebelum diisi
            try {
                const q = query(collection(db, 'quizzes'), where('dibuatOleh', '==', userId));
                const querySnapshot = await getDocs(q);

                loader.style.display = 'none';

                if (querySnapshot.empty) {
                    quizListContainer.innerHTML = '<p style="text-align:center;">Anda belum pernah membuat kuis.</p>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const quiz = doc.data();
                    const quizCard = document.createElement('div');
                    quizCard.className = 'quiz-card';
                    quizCard.innerHTML = `
                        <div class="quiz-summary">
                            <div class="quiz-info">
                                <h3>${quiz.judul || 'Tanpa Judul'}</h3>
                                <p>Dibuat pada: ${new Date(quiz.dibuatPada.seconds * 1000).toLocaleDateString('id-ID')} | Tipe: ${quiz.tipe || 'N/A'}</p>
                            </div>
                            <button class="btn-toggle-details" data-quiz-id="${doc.id}">Lihat Pertanyaan</button>
                        </div>
                        <div class="question-details" id="details-${doc.id}">
                            <p>Memuat pertanyaan...</p>
                        </div>
                    `;
                    quizListContainer.appendChild(quizCard);
                });

            } catch (error) {
                console.error("Error memuat kuis:", error);
                loader.innerHTML = '<h2>Oops! Terjadi kesalahan.</h2>';
            }
        }
        
        // --- Event Listener Utama untuk semua aksi di dalam daftar ---
        quizListContainer.addEventListener('click', async (e) => {
            // Aksi untuk membuka/menutup detail pertanyaan
            if (e.target.classList.contains('btn-toggle-details')) {
                const button = e.target;
                const quizId = button.dataset.quizId;
                const detailsContainer = document.getElementById(`details-${quizId}`);
                
                // Toggle tampilan
                const isHidden = detailsContainer.style.display === 'none' || detailsContainer.style.display === '';
                detailsContainer.style.display = isHidden ? 'block' : 'none';
                button.textContent = isHidden ? 'Tutup Pertanyaan' : 'Lihat Pertanyaan';

                // Jika container dibuka dan isinya masih default, muat data pertanyaan
                if (isHidden && detailsContainer.dataset.loaded !== 'true') {
                    await loadQuestionsForQuiz(quizId, detailsContainer);
                }
            }

            // Aksi untuk tombol hapus pertanyaan
            if (e.target.classList.contains('btn-delete-question')) {
                itemToDelete.quizId = e.target.dataset.quizId;
                itemToDelete.questionId = e.target.dataset.questionId;
                deleteModal.style.display = 'flex';
            }
        });

        async function loadQuestionsForQuiz(quizId, container) {
            container.innerHTML = '<p>Memuat pertanyaan...</p>';
            const q = query(collection(db, `quizzes/${quizId}/pertanyaan`));
            const questionsSnapshot = await getDocs(q);

            if (questionsSnapshot.empty) {
                container.innerHTML = '<p>Kuis ini tidak memiliki pertanyaan.</p>';
                return;
            }

            container.innerHTML = ''; // Kosongkan kontainer
            questionsSnapshot.forEach(doc => {
                const question = doc.data();
                const questionItem = document.createElement('div');
                questionItem.className = 'question-item';
                questionItem.innerHTML = `
                    <p>${question.teksPertanyaan}</p>
                    <button class="btn-delete-question" data-quiz-id="${quizId}" data-question-id="${doc.id}">Hapus</button>
                `;
                container.appendChild(questionItem);
            });
            container.dataset.loaded = 'true';
        }

        // --- Logika untuk Modal Konfirmasi ---
        cancelDeleteBtn.addEventListener('click', () => {
            itemToDelete = { quizId: null, questionId: null };
            deleteModal.style.display = 'none';
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!itemToDelete.quizId || !itemToDelete.questionId) return;

            confirmDeleteBtn.textContent = 'Menghapus...';
            confirmDeleteBtn.disabled = true;

            try {
                const { quizId, questionId } = itemToDelete;
                const batch = writeBatch(db);

                // Cek dulu apakah ini pertanyaan terakhir
                const allQuestionsRef = collection(db, `quizzes/${quizId}/pertanyaan`);
                const allQuestionsSnapshot = await getDocs(allQuestionsRef);
                const isLastQuestion = allQuestionsSnapshot.size === 1;

                // 1. Hapus semua jawaban di dalam pertanyaan
                const answersRef = collection(db, `quizzes/${quizId}/pertanyaan/${questionId}/jawaban`);
                const answersSnapshot = await getDocs(answersRef);
                answersSnapshot.forEach(answerDoc => batch.delete(answerDoc.ref));
                
                // 2. Hapus pertanyaan itu sendiri
                const questionRef = doc(db, `quizzes/${quizId}/pertanyaan`, questionId);
                batch.delete(questionRef);
                
                // 3. Jika ini adalah pertanyaan terakhir, hapus juga kuis utamanya
                if (isLastQuestion) {
                    const quizRef = doc(db, 'quizzes', quizId);
                    batch.delete(quizRef);
                }
                
                await batch.commit();

                // Muat ulang seluruh daftar untuk menampilkan perubahan
                await loadUserQuizzes(currentUser.uid);

            } catch (error) {
                console.error("Gagal menghapus pertanyaan:", error);
                alert('Terjadi kesalahan saat menghapus.');
            } finally {
                itemToDelete = { quizId: null, questionId: null };
                deleteModal.style.display = 'none';
                confirmDeleteBtn.textContent = 'Ya, Hapus';
                confirmDeleteBtn.disabled = false;
            }
        });

    </script>
</body>
</html>


