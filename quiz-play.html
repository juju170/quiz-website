<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waktunya Kuis! - Komunitas Ceria 2SD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --blue-light: #e3f2fd; --blue-main: #0288d1; --green-correct: #4caf50; --red-wrong: #f44336; --orange-next: #ff9800; }
        body { font-family: 'Baloo 2', sans-serif; margin: 0; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .quiz-container { position: relative; background-color: white; padding: 20px 30px 30px 30px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 600px; text-align: center; }
        .btn-quit-quiz { position: absolute; top: 15px; right: 15px; background-color: #f1f1f1; color: #888; border: 2px solid #ddd; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; text-decoration: none; font-size: 1.2rem; font-weight: 700; transition: all 0.2s ease; z-index: 10; }
        .btn-quit-quiz:hover { transform: scale(1.1) rotate(90deg); }
        .question-box { background-color: var(--blue-light); padding: 20px; border-radius: 15px; margin-bottom: 25px; min-height: 80px; display: flex; justify-content: center; align-items: center; border-left: 8px solid var(--blue-main); }
        .question-text { font-size: 1.8rem; font-weight: 800; color: var(--blue-main); margin: 0; }
        .answer-options { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .answer-btn, .btn-action-word { border: none; padding: 15px; border-radius: 15px; font-family: 'Baloo 2', sans-serif; font-weight: 700; cursor: pointer; }
        .answer-btn { font-size: 1.5rem; border-bottom: 6px solid; }
        .answer-btn.correct { background-color: var(--green-correct); color: white; border-color: #388e3c; animation: pulse 0.5s; }
        .answer-btn.wrong { background-color: var(--red-wrong); color: white; border-color: #c62828; }
        .next-btn { margin-top: 15px; background-color: var(--orange-next); color: white; border: none; padding: 15px 40px; font-size: 1.2rem; font-weight: 800; border-radius: 30px; cursor: pointer; visibility: hidden; border-bottom: 4px solid #f57c00; }
        .susun-huruf-wrapper { margin-top: 15px; }
        .answer-slots-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; min-height: 60px; }
        .answer-slot { width: 50px; height: 60px; background-color: #e0e0e0; border-bottom: 5px solid #bdbdbd; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: 800; }
        .letter-choices-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .letter-choice-btn { width: 55px; height: 55px; font-size: 1.8rem; background-color: #81d4fa; border: none; border-bottom: 5px solid #29b6f6; border-radius: 15px; font-family: 'Baloo 2', sans-serif; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .susun-huruf-actions { display: flex; justify-content: center; gap: 15px; margin-top: 10px; }
        .btn-action-word { background-color: #ffb74d; color: white; padding: 10px 25px; font-size: 1rem; border-radius: 20px; }
        .btn-check-word { background-color: #66bb6a; }
        .esai-wrapper textarea { width: 100%; padding: 15px; font-family: 'Baloo 2', sans-serif; font-size: 1.2rem; border-radius: 10px; border: 3px solid #ccc; box-sizing: border-box; min-height: 120px; }
        .feedback-box { min-height: 40px; font-size: 1.6rem; font-weight: 700; margin-top: 15px; }
        .results-screen h2 { font-size: 2.5rem; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="quiz-container" class="quiz-container">
        <h2>Memuat Kuis...</h2>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, limit } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.firebasestorage.app",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const quizContainer = document.getElementById('quiz-container');
        let allQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        async function fetchQuestions(quizQuery) {
            const snapshot = await getDocs(quizQuery);
            const questions = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                const type = data.tipeSoal || 'pilihan_ganda';
                const questionData = {
                    id: doc.id,
                    type: type,
                    question: data.teksPertanyaan,
                    answer: data.jawabanBenar,
                };
                if (type === 'pilihan_ganda') {
                    questionData.options = data.pilihanJawaban;
                }
                questions.push(questionData);
            });
            return questions;
        }

        function loadQuizUI() {
            quizContainer.innerHTML = `
                <a href="index.html" class="btn-quit-quiz">&times;</a>
                <div class="progress-container">
                    <p>Pertanyaan <span id="question-number"></span> dari <span id="total-questions"></span></p>
                    <p>Skor: <span id="score">0</span></p>
                </div>
                <div class="question-box">
                    <h2 id="question-text" class="question-text"></h2>
                </div>
                <div id="answer-options" class="answer-options"></div>
                <div id="feedback-box" class="feedback-box"></div>
                <button id="next-btn" class="next-btn">Lanjut</button>
            `;
            document.getElementById('next-btn').addEventListener('click', () => {
                currentQuestionIndex++;
                if (currentQuestionIndex < allQuestions.length) {
                    loadQuestion();
                } else {
                    showResults();
                }
            });
        }
        
        async function startQuiz() {
            loadQuizUI();
            const params = new URLSearchParams(window.location.search);
            const category = params.get('kategori');
            const isHarian = params.get('harian') === 'true';
            
            let q;
            const pertanyaanRef = collection(db, "pertanyaan");
            if (isHarian) {
                q = query(pertanyaanRef, where("isHarian", "==", true), limit(10));
            } else if (category) {
                q = query(pertanyaanRef, where("kategori", "==", category), limit(10));
            } else {
                q = query(pertanyaanRef, limit(10));
            }

            try {
                allQuestions = await fetchQuestions(q);
                if (allQuestions.length === 0) {
                    quizContainer.innerHTML = '<h2>Oops! Tidak ada pertanyaan untuk kategori ini.</h2><a href="index.html">Kembali</a>';
                    return;
                }
                allQuestions = shuffle(allQuestions);
                loadQuestion();
            } catch(error) {
                console.error("Gagal memuat pertanyaan:", error);
                quizContainer.innerHTML = '<h2>Terjadi kesalahan saat memuat kuis. Coba lagi nanti.</h2>';
            }
        }

        function loadQuestion() {
            const questionData = allQuestions[currentQuestionIndex];
            document.getElementById('question-number').textContent = currentQuestionIndex + 1;
            document.getElementById('total-questions').textContent = allQuestions.length;
            document.getElementById('score').textContent = score;
            document.getElementById('question-text').textContent = questionData.question;
            document.getElementById('answer-options').innerHTML = '';
            document.getElementById('feedback-box').innerHTML = '';
            document.getElementById('next-btn').style.visibility = 'hidden';

            if (questionData.type === 'pilihan_ganda') {
                renderPilihanGandaUI(questionData);
            } else if (questionData.type === 'susun_huruf') {
                renderSusunHurufUI(questionData);
            } else if (questionData.type === 'esai') {
                renderEsaiUI(questionData);
            }
        }

        function renderPilihanGandaUI(question) {
            const answerOptions = document.getElementById('answer-options');
            const options = shuffle([...question.options]);
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'answer-btn';
                button.onclick = () => checkMultipleChoiceAnswer(button, option, question.answer);
                answerOptions.appendChild(button);
            });
        }
        
        function renderSusunHurufUI(question) {
             const answerOptions = document.getElementById('answer-options');
            const wrapper = document.createElement('div');
            wrapper.className = 'susun-huruf-wrapper';
            
            const slotsContainer = document.createElement('div');
            slotsContainer.className = 'answer-slots-container';
            for (let i = 0; i < question.answer.length; i++) {
                slotsContainer.innerHTML += `<div class="answer-slot"></div>`;
            }

            const choicesContainer = document.createElement('div');
            choicesContainer.className = 'letter-choices-container';
            
            const letterChoices = shuffle(question.answer.split(''));

            letterChoices.forEach((letter, index) => {
                const btn = document.createElement('button');
                const btnId = `choice-btn-${index}`;
                btn.id = btnId;
                btn.textContent = letter;
                btn.className = 'letter-choice-btn';
                btn.onclick = () => {
                    const emptySlot = slotsContainer.querySelector('.answer-slot:not(.filled)');
                    if (emptySlot) {
                        emptySlot.textContent = letter;
                        emptySlot.classList.add('filled');
                        emptySlot.dataset.sourceBtnId = btnId;
                        btn.style.visibility = 'hidden';
                    }
                };
                choicesContainer.appendChild(btn);
            });

            const actions = document.createElement('div');
            actions.className = 'susun-huruf-actions';
            
            const backspaceBtn = document.createElement('button');
            backspaceBtn.textContent = 'Hapus';
            backspaceBtn.className = 'btn-action-word';
            backspaceBtn.onclick = () => {
                const filledSlots = slotsContainer.querySelectorAll('.answer-slot.filled');
                if (filledSlots.length > 0) {
                    const lastFilledSlot = filledSlots[filledSlots.length - 1];
                    const sourceBtnId = lastFilledSlot.dataset.sourceBtnId;
                    if (sourceBtnId && document.getElementById(sourceBtnId)) {
                        document.getElementById(sourceBtnId).style.visibility = 'visible';
                    }
                    lastFilledSlot.textContent = '';
                    lastFilledSlot.classList.remove('filled');
                    delete lastFilledSlot.dataset.sourceBtnId;
                }
            };

            const checkBtn = document.createElement('button');
            checkBtn.textContent = 'Periksa';
            checkBtn.className = 'btn-action-word btn-check-word';
            checkBtn.onclick = () => checkWordAnswer(question.answer);
            
            actions.append(backspaceBtn, checkBtn);
            wrapper.append(slotsContainer, choicesContainer, actions);
            answerOptions.appendChild(wrapper);
        }

        function renderEsaiUI(question) {
            const answerOptions = document.getElementById('answer-options');
            answerOptions.innerHTML = `
                <div class="esai-wrapper">
                    <textarea id="esai-answer" placeholder="Ketik jawabanmu di sini..."></textarea>
                    <button id="check-esai-btn" class="btn-action-word btn-check-word" style="margin-top: 10px;">Periksa Jawaban</button>
                </div>
            `;
            document.getElementById('check-esai-btn').onclick = () => checkEsaiAnswer(question.answer);
        }

        // --- AWAL FUNGSI BARU ---
        function checkMultipleChoiceAnswer(button, selectedAnswer, correctAnswer) {
            const allButtons = document.querySelectorAll('.answer-btn');
            allButtons.forEach(btn => btn.disabled = true); // Nonaktifkan semua tombol

            if (selectedAnswer === correctAnswer) {
                button.classList.add('correct');
                showFeedback(true, "Jawaban Benar!");
            } else {
                button.classList.add('wrong');
                // Tandai jawaban yang benar
                allButtons.forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
                showFeedback(false, `Salah! Jawaban yang benar adalah "${correctAnswer}"`);
            }
        }
        // --- AKHIR FUNGSI BARU ---

        function checkWordAnswer(correctAnswer) {
            const slots = document.querySelectorAll('.answer-slots-container .answer-slot');
            const userAnswer = Array.from(slots).map(slot => slot.textContent).join('');
            
            if (userAnswer.toUpperCase() === correctAnswer.toUpperCase()) {
                slots.forEach(slot => slot.style.backgroundColor = 'var(--green-correct)');
                showFeedback(true, "Jawaban Benar!");
            } else {
                slots.forEach(slot => slot.style.backgroundColor = 'var(--red-wrong)');
                showFeedback(false, `Salah! Jawaban: ${correctAnswer}`);
            }
             document.querySelectorAll('.letter-choice-btn, .btn-action-word').forEach(btn => btn.disabled = true);
        }
        
        function checkEsaiAnswer(correctAnswer) {
            const userAnswer = document.getElementById('esai-answer').value;
            if (userAnswer.toLowerCase().includes(correctAnswer.toLowerCase())) {
                 showFeedback(true, "Jawabanmu Tepat!");
            } else {
                 showFeedback(false, `Kurang Tepat. Jawaban yang diharapkan: ${correctAnswer}`);
            }
             document.getElementById('check-esai-btn').disabled = true;
        }

        function showFeedback(isCorrect, message) {
            if (isCorrect) {
                score += 10;
                document.getElementById('score').textContent = score;
            }
            const feedbackBox = document.getElementById('feedback-box');
            feedbackBox.textContent = message;
            feedbackBox.style.color = isCorrect ? 'var(--green-correct)' : 'var(--red-wrong)';
            document.getElementById('next-btn').style.visibility = 'visible';
        }

        function showResults() {
            const percentage = Math.round((score / (allQuestions.length * 10)) * 100);
            let message = "Kerja bagus!";
            if (percentage < 50) message = "Jangan menyerah, coba lagi ya!";
            if (percentage > 80) message = "Luar biasa, kamu hebat!";

            quizContainer.innerHTML = `
                <div class="results-screen">
                    <h2>Kuis Selesai!</h2>
                    <p style="font-size: 1.5rem;">${message}</p>
                    <p>Skor Akhir Kamu:</p>
                    <h1 style="font-size: 4rem; margin: 0; color: var(--blue-main);">${score}</h1>
                    <p>Kamu benar ${score / 10} dari ${allQuestions.length} pertanyaan (${percentage}%)!</p>
                    <div style="margin-top: 20px; display: grid; gap: 10px;">
                        <a href="${window.location.href}" class="btn" style="background-color:var(--green-correct); color:white; display:block; text-decoration: none;">Main Lagi Kategori Ini</a>
                        <a href="index.html" class="btn" style="background-color:#f1f1f1; display:block; text-decoration: none;">Kembali ke Menu Utama</a>
                    </div>
                </div>
            `;
        }
        
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex > 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        startQuiz();
    </script>
</body>
</html>


