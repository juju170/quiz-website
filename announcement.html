<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buat Pengumuman Lomba Ceria!</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleApis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.coapiKeym/lucide@latest"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFFBEB; }
        .form-container { background: white; border-radius: 24px; padding: 32px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); border: 2px solid #FEF3C7; }
        .input-field { width: 100%; padding: 12px 16px; border: 2px solid #E5E7EB; border-radius: 12px; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: #FBBF24; box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3); }
        .label-text { display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .btn-primary { background: linear-gradient(135deg, #F9A825, #F57F17); color: white; font-weight: 700; padding: 16px; border-radius: 9999px; width: 100%; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(249, 168, 37, 0.4); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(249, 168, 37, 0.5); }
        nav a.active { background-color: #D97706; color: white; }
        nav a:not(.active):hover { background-color: #FEF3C7; color: #D97706; }
    </style>
</head>
<body class="text-gray-800">
    <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-50 shadow-sm py-3">
        <div class="container mx-auto flex justify-between items-center px-4">
            <nav id="navbar" class="bg-gray-100 p-2 rounded-full"></nav>
            <div id="role-switcher" class="flex items-center gap-2">
                <span id="role-label" class="font-semibold text-sm text-gray-600"></span>
                <button onclick="toggleRole()" class="bg-indigo-500 text-white px-3 py-1 rounded-full text-sm hover:bg-indigo-600 transition-colors"></button>
            </div>
        </div>
    </header>

    <div id="page-content" class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-600">Umumkan Lomba Kuis Seru! ðŸ“£</h1>
            <p class="text-gray-500 mt-2">Atur detail lomba, lencana, dan jadwal untuk para siswa.</p>
        </header>

        <main class="form-container mb-12">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Buat Pengumuman Baru</h2>
            <form id="announcementForm">
                <div class="input-group"><label for="judul" class="label-text"><i data-lucide="edit"></i>Judul Pengumuman</label><input type="text" id="judul" class="input-field" placeholder="Contoh: Lomba Cerdas Cermat Sains" required></div>
                <div class="input-group"><label for="deskripsi" class="label-text"><i data-lucide="file-text"></i>Deskripsi Lomba</label><textarea id="deskripsi" rows="3" class="input-field" placeholder="Jelaskan tentang lomba..."></textarea></div>
                
                <fieldset class="border-2 border-dashed border-gray-300 p-4 rounded-xl mb-6">
                    <legend class="text-lg font-bold px-2 text-gray-600 flex items-center gap-2"><i data-lucide="award"></i>Hadiah Lencana Juara</legend>
                    <div class="grid md:grid-cols-3 gap-6 mt-4">
                        <div><h4 class="font-bold text-lg mb-2 text-yellow-500">Emas</h4><input type="text" id="badge-gold" class="input-field" placeholder="Cth: Juara Sains"></div>
                        <div><h4 class="font-bold text-lg mb-2 text-gray-400">Perak</h4><input type="text" id="badge-silver" class="input-field" placeholder="Cth: Ahli Sains"></div>
                        <div><h4 class="font-bold text-lg mb-2 text-orange-400">Perunggu</h4><input type="text" id="badge-bronze" class="input-field" placeholder="Cth: Bakat Sains"></div>
                    </div>
                </fieldset>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="input-group"><label for="quiz-select" class="label-text"><i data-lucide="link"></i>Hubungkan Kuis</label><select id="quiz-select" class="input-field bg-white" required><option value="">Memuat kuis...</option></select></div>
                    <div class="input-group"><label for="start-time" class="label-text"><i data-lucide="calendar-clock"></i>Waktu Mulai Lomba</label><input type="datetime-local" id="start-time" class="input-field" required></div>
                </div>

                <div class="mt-6"><button type="submit" class="btn-primary flex items-center justify-center gap-2"><i data-lucide="send"></i>Terbitkan Pengumuman</button></div>
            </form>
        </main>
    </div>
    
    <div id="access-denied" class="hidden text-center p-10">
         <h1 class="text-4xl font-bold text-red-500">ðŸš« Akses Ditolak!</h1>
         <p class="text-gray-600 mt-4">Maaf, halaman ini hanya bisa diakses oleh Guru.</p>
         <a href="see-info.html" class="mt-6 inline-block bg-blue-500 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-600">Kembali ke Papan Info</a>
    </div>

    <script src="role-manager.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
    authDomain: "forumwidara.firebaseapp.com",
    projectId: "forumwidara",
    storageBucket: "forumwidara.firebasestorage.app",
    messagingSenderId: "216895655168",
    appId: "1:216895655168:web:59255f600fc3b3b44eb7e5" };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const announcementsCollection = collection(db, 'announcements');
        const quizzesCollection = collection(db, 'quizzes');

        const form = document.getElementById('announcementForm');
        const quizSelect = document.getElementById('quiz-select');

        async function populateQuizzes() {
            try {
                const snapshot = await getDocs(quizzesCollection);
                quizSelect.innerHTML = '<option value="">-- Pilih Kuis --</option>';
                if (snapshot.empty) { quizSelect.innerHTML = '<option value="">Belum ada kuis</option>'; quizSelect.disabled = true; }
                else { snapshot.forEach(doc => { const opt = new Option(doc.data().title, doc.id); quizSelect.add(opt); }); quizSelect.disabled = false; }
            } catch (error) { console.error("Error getting quizzes: ", error); quizSelect.innerHTML = '<option value="">Gagal memuat</option>'; }
        }

        async function saveAnnouncement(e) {
            e.preventDefault();
            const title = form.judul.value;
            const description = form.deskripsi.value;
            const quizId = form['quiz-select'].value;
            const startTimeValue = form['start-time'].value;
            
            if (!title || !quizId || !startTimeValue) {
                alert('Judul, Kuis, dan Waktu Mulai wajib diisi!');
                return;
            }

            const badges = {
                gold: form['badge-gold'].value.trim(),
                silver: form['badge-silver'].value.trim(),
                bronze: form['badge-bronze'].value.trim(),
            };
            
            const startTime = Timestamp.fromDate(new Date(startTimeValue));

            const newAnnouncement = { title, description, quizId, startTime, badges, createdAt: serverTimestamp() };
            
            try {
                await addDoc(announcementsCollection, newAnnouncement);
                form.reset();
                alert('Pengumuman berhasil diterbitkan!');
            } catch (error) {
                console.error("Error adding document: ", error);
                alert('Gagal menerbitkan pengumuman.');
            }
        }
        
        function initializePage() {
            if (window.userRole !== 'admin') {
                document.getElementById('page-content').classList.add('hidden');
                document.getElementById('access-denied').classList.remove('hidden');
            } else {
                document.getElementById('page-content').classList.remove('hidden');
                document.getElementById('access-denied').classList.add('hidden');
                form.addEventListener('submit', saveAnnouncement);
                lucide.createIcons();
                populateQuizzes();
            }
        }

        document.addEventListener('roleChanged', initializePage);
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>


