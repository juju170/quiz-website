<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buat Soal Kuis — Gabungan BK + Buat-Kuis</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-space: #0f0c29;
      --card-bg: rgba(255, 255, 255, 0.06);
      --border-color: rgba(255, 255, 255, 0.12);
      --accent1: #ff7e5f;
      --accent2: #feb47b;
      --accent3: #8697ff;
      --accent4: #48dbfb;
      --muted-light: rgba(255,255,255,0.7);
    }
    *{box-sizing:border-box; scroll-behavior: smooth;}
    body{
      font-family:'Baloo 2',sans-serif;
      margin:0;
      background: radial-gradient(circle at 10% 10%, rgba(72,219,251,0.08), transparent 20%),
                  linear-gradient(180deg, #071023 0%, #0f0c29 100%);
      color: var(--muted-light);
      min-height:100vh; 
      padding:20px;
      overflow-x: hidden;
    }
    #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .wrap{max-width:980px;margin:20px auto}
    header{display:flex;justify-content:space-between; align-items:center;margin-bottom:20px;flex-wrap:wrap;gap: 15px;}
    .header-title{display:flex;gap:15px;align-items:center;}
    .logo-icon{background:linear-gradient(45deg, var(--accent3), var(--accent4));padding:12px;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,0.2);}
    h1{margin:0;font-size:1.6rem; color: white;}
    .card{
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        backdrop-filter: blur(8px);
        border-radius:16px;
        padding:20px;
        box-shadow:0 8px 32px 0 rgba(0,0,0,0.3);
        margin-bottom:18px
    }
    label{display:block;font-weight:700;margin-bottom:8px;font-size: 1rem;color:var(--muted-light)}
    input[type=text], input[type=url], input[type=number], textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.03);
      font-size:1rem;
      color: var(--muted-light);
    }
    textarea{min-height:70px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:20px}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;border:none;font-weight:800;cursor:pointer;font-size:0.95rem}
    .btn-submit{background:linear-gradient(45deg,var(--accent1),var(--accent2)); color:white}
    .btn-neutral{background:rgba(255,255,255,0.06); color:var(--muted-light)}
    .btn-ghost{background:transparent;border:2px dashed rgba(255,255,255,0.06);color:var(--muted-light)}
    .section-title{font-weight:800;font-size: 1.1rem; margin-bottom:10px; color:white}
    .submit-row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap}
    .file-attach-area { border: 2px dashed rgba(255,255,255,0.04); border-radius: 12px; padding: 12px; text-align: center; background: rgba(0,0,0,0.05) }
    input[type=file] { display: none; }
    .file-label { cursor: pointer; background: var(--accent3); color: white; padding: 8px 12px; border-radius: 8px; display: inline-block; }
    .file-name { margin-top: 8px; font-size: 0.9rem; color: rgba(255,255,255,0.7); }
    .answer-card { padding: 12px; background: rgba(255,255,255,0.02); border-radius: 10px; margin-bottom: 10px; position: relative; color:var(--muted-light) }
    .choices{display:grid;gap:8px}
    .choice-row{display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap}
    .preview-media{border-radius:12px;min-height:48px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02); color:var(--muted-light)}
    .note{font-size:0.9rem;color:rgba(255,255,255,0.6);margin-top:6px}
    .message{padding:10px;border-radius:10px;margin-top:10px;font-weight:800;font-size:0.95rem;display:none}
    .message.success{background:rgba(46, 204, 113, 0.12);color:#bff1c6}
    .message.error{background:rgba(231, 76, 60, 0.12);color:#ffd6d6}
    @media(max-width:780px){.grid{grid-template-columns:1fr}.right-column{order:-1}}
    .fab-home { position: fixed; bottom: 22px; right: 22px; width:56px;height:56px;border-radius:50%;background:var(--accent4);display:flex;align-items:center;justify-content:center;color:#052;box-shadow:0 6px 18px rgba(0,0,0,0.3); text-decoration:none; font-size:1.2rem; }
  </style>
</head>
<body>
  <canvas id="starfield"></canvas>

  <div class="wrap">
    <header>
      <div class="header-title">
        <div class="logo-icon"><svg width="36" height="36" viewBox="0 0 24 24" fill="none"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="white"/></svg></div>
        <div>
          <h1>Buat Soal Kuis — BK + BuatKuis</h1>
          <div style="font-size:0.9rem;color:rgba(255,255,255,0.7)">UI & file upload dari BK, fungsionalitas lengkap dari Buat-Kuis</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <main>
        <form id="question-form" class="card" autocomplete="off">
            <div class="section-title">Informasi Soal</div>
            <label for="pertanyaan-teks">Tulis Pertanyaan</label>
            <textarea id="pertanyaan-teks" placeholder="Contoh: Planet manakah yang paling dekat dengan Matahari?"></textarea>

            <div style="display:flex; gap: 16px; margin-top:12px; flex-wrap:wrap;">
              <div style="flex:1; min-width:160px;">
                <label for="kategori-pilihan">Kategori Mata Pelajaran</label>
                <select id="kategori-pilihan">
                  <option value="">-- Pilih Mata Pelajaran --</option>
                  <option value="matematika">Matematika</option>
                  <option value="bahasa_indonesia">Bahasa Indonesia</option>
                  <option value="bahasa_inggris">Bahasa Inggris</option>
                  <option value="ipa">Ilmu Pengetahuan Alam</option>
                  <option value="agama_islam">Agama Islam</option>
                  <option value="ips">Ilmu Sosial</option>
                  <option value="sejarah">Sejarah</option>
                  <option value="pkn">Kewarganegaraan</option>
                  <option value="basa_sunda">Basa Sunda</option>
                  <option value="olahraga">Olahraga</option>
                  <option value="seni">Seni</option>
                  <option value="campuran_seru">Campuran Seru</option>
                </select>
              </div>
              <div style="flex:1; min-width:160px;">
                <label for="tipe-soal">Tipe Soal</label>
                <select id="tipe-soal">
                  <option value="pilihan_ganda">Pilihan Ganda</option>
                  <option value="esai">Esai</option>
                  <option value="pencocokan">Pencocokan</option>
                  <option value="susun_kata">Susun Kata</option>
                  <option value="multi_benar">Beberapa Jawaban Benar</option>
                  <option value="benar_salah">Benar / Salah</option>
                  <option value="tts_mini">TTS Mini</option>
                </select>
                <div style="margin-top:8px;"><label><input type="checkbox" id="is-harian"> Tandai sebagai Kuis Harian</label></div>
              </div>
            </div>

            <hr style="border:none;height:1px;background:rgba(255,255,255,0.04);margin:18px 0">

            <div class="section-title">Media — Cloudinary atau URL (opsional)</div>
            <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
              
                </div>
              </div>
              <div style="width:220px">
                <label>Preview Media</label>
                <div id="preview-media" class="preview-media">Tidak ada media</div>
              </div>
            </div>

            <div style="display:flex;gap:12px;margin-bottom:12px;align-items:flex-start;flex-wrap:wrap">
              <div style="flex:1;min-width:220px">
                <label>Attach Gambar (soal)</label>
                <div class="file-attach-area">
                  <label for="file-image" class="file-label">Pilih Gambar</label>
                  <input type="file" id="file-image" accept="image/*" />
                  <div class="file-name" id="file-image-name">Belum ada file dipilih</div>
                  <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
                    <button type="button" id="upload-image-btn" class="btn btn-neutral">Upload ke Cloudinary</button>
                    <button type="button" id="use-github-image" class="btn-ghost">Gunakan URL</button>
                  </div>
                  <input type="url" id="github-image-url" placeholder="Tempel URL gambar (opsional)" style="margin-top:8px" />
                </div>
              </div>

              <div style="flex:1;min-width:220px">
                <label>Attach Audio (soal)</label>
                <div class="file-attach-area">
                  <label for="file-audio" class="file-label">Pilih Audio</label>
                  <input type="file" id="file-audio" accept="audio/*" />
                  <div class="file-name" id="file-audio-name">Belum ada file dipilih</div>
                  <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
                    <button type="button" id="upload-audio-btn" class="btn btn-neutral">Upload ke Cloudinary</button>
                    <button type="button" id="use-github-audio" class="btn-ghost">Gunakan URL</button>
                  </div>
                  <input type="url" id="github-audio-url" placeholder="Tempel URL audio (opsional)" style="margin-top:8px" />
                </div>
              </div>
            </div>

            <hr style="margin:12px 0;border:none;height:1px;background:rgba(255,255,255,0.03)">

            <div id="dynamic-area"></div>

            <div class="submit-row">
              <button type="button" id="btn-preview" class="btn btn-neutral">Pratinjau</button>
              <div>
                <button type="button" id="btn-reset" class="btn btn-neutral" style="margin-right:8px">Reset</button>
                <button type="submit" id="btn-save" class="btn btn-submit">Simpan Pertanyaan</button>
              </div>
            </div>
            <div id="form-message" class="message"></div>
        </form>
      </main>

      <aside class="right-column">
        <div class="card">
          <div class="section-title">Status & Panduan</div>
          <div id="quota-display" style="font-weight:bold; margin-bottom:10px; color:var(--accent4)">Memeriksa kuota...</div>
          <div id="guide-text" class="note">Pilih tipe soal untuk melihat panduan.</div>
          <hr style="border-color: var(--border-color); margin: 12px 0;">
          <div class="section-title">Preview</div>
          <div id="preview-card" class="answer-card">Pratinjau akan muncul di sini</div>
        </div>
      </aside>
    </div>
  </div>

  <a href="index.html" class="fab-home">🏠</a>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, doc, Timestamp, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ---------- STARFIELD ----------
  const canvas = document.getElementById('starfield');
  const ctx = canvas.getContext('2d');
  function initStarfield(){
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let stars = [];
    for (let i = 0; i < 180; i++) stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*1.5, vx: (Math.random()-0.5)*20, vy:(Math.random()-0.5)*20 });
    function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.globalCompositeOperation='lighter'; for(const s of stars){ ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,2*Math.PI); ctx.fill(); s.x+=s.vx/60; s.y+=s.vy/60; if(s.x<0||s.x>canvas.width) s.vx=-s.vx; if(s.y<0||s.y>canvas.height) s.vy=-s.vy; } requestAnimationFrame(draw); }
    draw(); window.addEventListener('resize',()=>{ canvas.width=window.innerWidth; canvas.height=window.innerHeight; });
  }
  initStarfield();

  // ---------- FIREBASE ----------
  const firebaseConfig = { apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc", authDomain: "forumwidara.firebaseapp.com", projectId: "forumwidara", storageBucket: "forumwidara.appspot.com", messagingSenderId: "216895655168", appId: "1:216895655168:web:59255f600fc3b3b44eb7e5" };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  
  // ---------- CLOUDINARY CONFIG (placeholder) ----------
  const CLOUDINARY_CLOUD_NAME = "YOUR_CLOUD_NAME"; // TODO: ganti di kode
  const CLOUDINARY_UPLOAD_PRESET = "YOUR_UPLOAD_PRESET"; // opsional

  // DOM
  const tipeSoal = document.getElementById('tipe-soal');
  const dynamicArea = document.getElementById('dynamic-area');
  const previewMedia = document.getElementById('preview-media');
  const previewCard = document.getElementById('preview-card');
  const fileImage = document.getElementById('file-image');
  const fileAudio = document.getElementById('file-audio');
  const uploadImageBtn = document.getElementById('upload-image-btn');
  const uploadAudioBtn = document.getElementById('upload-audio-btn');  const githubImageUrl = document.getElementById('github-image-url');
  const githubAudioUrl = document.getElementById('github-audio-url');
  const useGithubImage = document.getElementById('use-github-image');
  const useGithubAudio = document.getElementById('use-github-audio');
  const btnSave = document.getElementById('btn-save');
  const btnPreview = document.getElementById('btn-preview');
  const btnReset = document.getElementById('btn-reset');
  const formMessage = document.getElementById('form-message');

  // state
  let currentUser = null;
  let userProfile = null;
  let uploadedImageUrl = null;
  let uploadedAudioUrl = null;
  let pendingUploads = { questionImage: null, questionAudio: null, optionImages: {} };

  function showFormMessage(type, text, persist=false){
    formMessage.className = 'message '+(type==='ok'?'success':'error');
    formMessage.textContent = text; formMessage.style.display='block';
    if(!persist) setTimeout(()=>formMessage.style.display='none',4500);
  }

  function setPreview(mediaType, url){
    if(!url){ previewMedia.textContent='Tidak ada media'; return; }
    if(mediaType==='image'){ previewMedia.innerHTML = `<img src="${url}" alt="preview" style="max-width:100%;border-radius:8px">`; }
    if(mediaType==='audio'){ previewMedia.innerHTML = `<audio controls src="${url}" style="width:100%;margin-top:8px"></audio>`; }
  }

  async function uploadToCloudinary(file, resourceType='image'){
    if(!CLOUDINARY_CLOUD_NAME) throw new Error('Cloudinary config belum diisi di kode.');
    const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;
    const fd = new FormData();
    fd.append('file', file);
    if(CLOUDINARY_UPLOAD_PRESET) fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    const res = await fetch(url, { method:'POST', body: fd });
    if(!res.ok) throw new Error('Upload gagal: '+res.statusText);
    const j = await res.json();
    return j.secure_url || j.url;
  }/${resourceType}/upload`;
    const fd = new FormData();
    fd.append('file', file);
    if(preset) fd.append('upload_preset', preset);
    const res = await fetch(url, { method:'POST', body: fd });
    if(!res.ok) throw new Error('Upload gagal: '+res.statusText);
    const j = await res.json();
    return j.secure_url || j.url;
  }

  useGithubImage.addEventListener('click', ()=>{ uploadedImageUrl = githubImageUrl.value.trim() || null; setPreview('image', uploadedImageUrl); showFormMessage('ok','Menggunakan URL gambar langsung'); });
  useGithubAudio.addEventListener('click', ()=>{ uploadedAudioUrl = githubAudioUrl.value.trim() || null; setPreview('audio', uploadedAudioUrl); showFormMessage('ok','Menggunakan URL audio langsung'); });

  uploadImageBtn.addEventListener('click', async ()=>{
    if(!fileImage.files[0]){ showFormMessage('err','Pilih file gambar terlebih dahulu'); return; }
    try{ uploadImageBtn.disabled=true; uploadImageBtn.textContent='Uploading...';
      const url = await uploadToCloudinary(fileImage.files[0],'image'); uploadedImageUrl = url; setPreview('image', url); showFormMessage('ok','Gambar terupload ke Cloudinary'); pendingUploads.questionImage = fileImage.files[0];
    }catch(e){ console.error(e); showFormMessage('err', e.message||'Gagal upload gambar'); }finally{ uploadImageBtn.disabled=false; uploadImageBtn.textContent='Upload ke Cloudinary'; }
  });

  uploadAudioBtn.addEventListener('click', async ()=>{
    if(!fileAudio.files[0]){ showFormMessage('err','Pilih file audio terlebih dahulu'); return; }
    try{ uploadAudioBtn.disabled=true; uploadAudioBtn.textContent='Uploading...';
      const url = await uploadToCloudinary(fileAudio.files[0],'video'); uploadedAudioUrl = url; setPreview('audio', url); showFormMessage('ok','Audio terupload ke Cloudinary'); pendingUploads.questionAudio = fileAudio.files[0];
    }catch(e){ console.error(e); showFormMessage('err', e.message||'Gagal upload audio'); }finally{ uploadAudioBtn.disabled=false; uploadAudioBtn.textContent='Upload ke Cloudinary'; }
  });

  // file name display for native selects
  fileImage.addEventListener('change', ()=>{ document.getElementById('file-image-name').textContent = fileImage.files[0]?.name || 'Belum ada file dipilih'; pendingUploads.questionImage = fileImage.files[0]||null; });
  fileAudio.addEventListener('change', ()=>{ document.getElementById('file-audio-name').textContent = fileAudio.files[0]?.name || 'Belum ada file dipilih'; pendingUploads.questionAudio = fileAudio.files[0]||null; });

  // ---------- DYNAMIC FORM RENDERING (from buat-kuis) ----------
  
  function renderPilihanGanda(){
    dynamicArea.innerHTML = `
      <div class="section-title">Pilihan Ganda — Isi jawaban & alasan per pilihan</div>
      <div class="note">Centang minimal <strong>1</strong> dan maksimal <strong>4</strong> jawaban benar.</div>
      <div class="choices">
        ${[0,1,2,3].map(i=>`
          <div class="answer-card choice-row" data-choice-index="${i}">
            <div style="width:36px;text-align:center"><input type="checkbox" class="pg-check" data-index="${i}"></div>
            <div style="flex:1">
              <input type="text" class="jawaban" placeholder="Pilihan ${i+1}">
              <textarea class="jawaban-alasan" placeholder="Alasan jika pilihan ini BENAR atau mengapa SALAH (ringkas)"></textarea>
            </div>
            <div style="width:140px;text-align:center">
              <label class="file-label" data-target="opt-img-${i}">Pilih Gambar</label>
              <input type="file" accept="image/*" id="opt-img-${i}" style="display:none">
              <div id="opt-img-name-${i}" class="file-name">Belum ada</div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
    // attach listeners for option images
    [0,1,2,3].forEach(i=>{
      const f = document.getElementById(`opt-img-${i}`);
      f?.addEventListener('change', ()=>{ const file = f.files[0]; if(file){ pendingUploads.optionImages[i]=file; document.getElementById(`opt-img-name-${i}`).textContent = file.name; } else { delete pendingUploads.optionImages[i]; document.getElementById(`opt-img-name-${i}`).textContent='Belum ada'; } });
      const label = document.querySelector(`label.file-label[data-target="opt-img-${i}"]`);
      label?.addEventListener('click', ()=> f.click());
    });
  }
      </div>
    `;
    // attach listeners for option images
    [0,1,2,3].forEach(i=>{
      const f = document.getElementById(`opt-img-${i}`);
      f?.addEventListener('change', ()=>{ const file = f.files[0]; if(file){ pendingUploads.optionImages[i]=file; document.getElementById(`opt-img-name-${i}`).textContent = file.name; } else { delete pendingUploads.optionImages[i]; document.getElementById(`opt-img-name-${i}`).textContent='Belum ada'; } });
      const label = document.querySelector(`label.file-label[data-target="opt-img-${i}"]`);
      label?.addEventListener('click', ()=> f.click());
    });
  }

  function renderEsai(){
    dynamicArea.innerHTML = `
      <div class="section-title">Esai — jawaban & alasan</div>
      <div class="answer-card">
        <label>Variasi jawaban yang diterima (pisahkan dengan <code>||</code>)</label>
        <input id="esai-variations" placeholder="contoh: soekarno || ir. soekarno || ir soekarno">
        <label style="margin-top:10px">Alasan jika jawaban DINYATAKAN BENAR</label>
        <textarea id="esai-reason-correct"></textarea>
        <label style="margin-top:10px">Alasan / feedback jika jawaban SALAH</label>
        <textarea id="esai-reason-wrong"></textarea>
      </div>
    `;
  }

  function renderPencocokan(){
    dynamicArea.innerHTML = `
      <div class="section-title">Pencocokan — tambahkan pasangan</div>
      <div id="pairs-container"></div>
      <div style="margin-top:8px"><button type="button" id="add-pair" class="btn btn-neutral">+ Tambah Pasangan</button></div>
    `;
    setTimeout(()=>{
      const add = document.getElementById('add-pair');
      add.addEventListener('click', ()=>{
        const c = document.getElementById('pairs-container');
        const d = document.createElement('div'); d.className='answer-card';
        d.innerHTML = `<div style="display:flex;gap:8px"><input placeholder="Kiri (mis: A)" class="pair-left"><input placeholder="Kanan (mis: 1)" class="pair-right"></div><textarea class="pair-reason" placeholder="Alasan untuk pasangan ini (opsional)"></textarea>`;
        c.appendChild(d);
      });
    },30);
  }

  function renderSusunKata(){
    dynamicArea.innerHTML = `
      <div class="section-title">Susun Kata jadi Kalimat</div>
      <div class="answer-card">
        <label>Kalimat Benar</label>
        <input id="susun-kalimat" placeholder="Tulis kalimat yang benar">
        <label style="margin-top:8px">Alasan jika BENAR</label>
        <textarea id="susun-reason-true"></textarea>
        <label style="margin-top:8px">Alasan jika SALAH</label>
        <textarea id="susun-reason-false"></textarea>
      </div>
    `;
  }

  function renderMultiBenar(){
    dynamicArea.innerHTML = `
      <div class="section-title">Beberapa Jawaban Benar</div>
      <div class="choices">
        ${[0,1,2,3].map(i=>`
          <div class="answer-card choice-row">
            <div style="width:36px;text-align:center"><input type="checkbox" class="multi-check" data-index="${i}"></div>
            <div style="flex:1">
              <input type="text" class="multi-answer" placeholder="Pilihan ${i+1}">
              <textarea class="multi-reason" placeholder="Alasan jika pilihan ini benar / salah (ringkas)"></textarea>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  function renderBenarSalah(){
    dynamicArea.innerHTML = `
      <div class="section-title">Benar / Salah</div>
      <div class="answer-card">
        <label>Pilih jawaban yang benar</label>
        <div style="display:flex;gap:12px;margin-top:8px"><label><input type="radio" name="bs" value="benar" checked> Benar</label><label><input type="radio" name="bs" value="salah"> Salah</label></div>
        <label style="margin-top:10px">Alasan jika BENAR</label>
        <textarea id="bs-reason-true"></textarea>
        <label style="margin-top:10px">Alasan jika SALAH</label>
        <textarea id="bs-reason-false"></textarea>
      </div>
    `;
  }

  function renderTtsMini(){
    dynamicArea.innerHTML = `
      <div class="section-title">TTS Mini</div>
      <div class="answer-card">
        <label>Jawaban Mendatar</label>
        <input id="tts-mendatar" placeholder="Contoh: BOLA">
        <label style="margin-top:10px">Jawaban Menurun</label>
        <input id="tts-menurun" placeholder="Contoh: KOTAK">
        <label style="margin-top:10px">Alasan / Penjelasan</label>
        <textarea id="tts-reason" placeholder="Alasan umum jika jawaban benar"></textarea>
      </div>
    `;
  }

  function updateGuide(type){
    const guides = {
      pilihan_ganda: "Pilih 2-4 jawaban benar. Bisa lampirkan gambar per pilihan.",
      esai: "Pisahkan variasi jawaban dengan ||. Contoh: Soekarno || Ir. Soekarno.",
      pencocokan: "Buat pasangan antara kolom kiri dan kanan.",
      susun_kata: "Tulis kalimat yang benar; sistem akan mengacak tampilannya.",
      multi_benar: "Siswa bisa memilih lebih dari satu jawaban.",
      benar_salah: "Tentukan Benar atau Salah dan tambahkan penjelasan.",
      tts_mini: "Isi mendatar & menurun. Sistem akan mencari persilangan otomatis."
    };
    document.getElementById('guide-text').textContent = guides[type] || "Pilih tipe soal untuk melihat panduan.";
  }

  function renderDynamic(){
    const t = tipeSoal.value;
    updateGuide(t);
    pendingUploads.optionImages = {};
    if(t==='pilihan_ganda') renderPilihanGanda();
    else if(t==='esai') renderEsai();
    else if(t==='pencocokan') renderPencocokan();
    else if(t==='susun_kata') renderSusunKata();
    else if(t==='multi_benar') renderMultiBenar();
    else if(t==='benar_salah') renderBenarSalah();
    else if(t==='tts_mini') renderTtsMini();
  }

  tipeSoal.addEventListener('change', renderDynamic);
  renderDynamic();

  // ---------- AUTH + PROFILE (minimal check) ----------
  async function checkUserData(user){
    if(!user) return;
    try{
      const profileRef = doc(db,'profiles',user.uid);
      const profileSnap = await getDoc(profileRef);
      if(!profileSnap.exists() || !profileSnap.data().class){
        showFormMessage('err','Atur kelas di profilmu terlebih dahulu');
        btnSave.disabled = true; return;
      }
      userProfile = profileSnap.data(); currentUser = user; btnSave.disabled=false;
    }catch(e){ console.warn("Profile check error:",e); }
  }
  onAuthStateChanged(auth, async (user)=>{ if(user) await checkUserData(user); else { /* redirect to index if desired */ } });

  // ---------- Utility: findIntersection for TTS ----------
  function findIntersection(word1, word2){
    const w1 = word1.toUpperCase(); const w2 = word2.toUpperCase();
    for(let i=0;i<w1.length;i++){ for(let j=0;j<w2.length;j++){ if(w1[i] === w2[j]) return { mendatarIndex: i, menurunIndex: j }; } }
    return null;
  }

  // ---------- FORM SAVE LOGIC ----------
  document.getElementById('question-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!currentUser || !userProfile){ showFormMessage('err','Tidak dapat menyimpan tanpa profile/kelas.'); return; }
    btnSave.disabled=true; btnSave.textContent='Memproses...';
    try{
      // upload pending files (question-level and options) to Cloudinary if cloud name provided
      let uploadedUrls = { questionImage: null, questionAudio: null, optionImages: {} };
      if(pendingUploads.questionImage) uploadedUrls.questionImage = await uploadToCloudinary(pendingUploads.questionImage,'image');
      if(pendingUploads.questionAudio) uploadedUrls.questionAudio = await uploadToCloudinary(pendingUploads.questionAudio,'video');
      for(const idx in pendingUploads.optionImages){
        const file = pendingUploads.optionImages[idx];
        uploadedUrls.optionImages[idx] = await uploadToCloudinary(file,'image');
      }

      const data = {
        untukKelas: userProfile.class || null,
        teksPertanyaan: document.getElementById('pertanyaan-teks').value.trim(),
        kategori: document.getElementById('kategori-pilihan').value || null,
        dibuatOleh: currentUser.uid,
        dibuatPada: Timestamp.now(),
        tipeSoal: tipeSoal.value,
        urlGambar: uploadedUrls.questionImage || uploadedImageUrl || null,
        urlSuara: uploadedUrls.questionAudio || uploadedAudioUrl || null,
        isHarian: !!document.getElementById('is-harian') && document.getElementById('is-harian').checked // optional flag
      };

      const t = tipeSoal.value;
      if(t==='pilihan_ganda'){
        // collect option inputs consistently
        const optionEls = [...dynamicArea.querySelectorAll('.answer-card')];
        const opts = optionEls.map(el => el.querySelector('.jawaban')?.value.trim() || '');
        const reasons = optionEls.map(el => el.querySelector('.jawaban-alasan')?.value.trim() || '');
        // collect checkbox booleans per option (ensure length matches options)
        const correctBools = optionEls.map((el,i) => {
            const cb = el.querySelector('.pg-check');
            return !!(cb && cb.checked);
        });
        const correctCount = correctBools.filter(Boolean).length;
        if(correctCount < 1){ // allow single-correct or multi-correct but at least 1
            throw new Error('Tentukan minimal 1 jawaban benar untuk pilihan ganda.');
        }
        // attach option image urls if uploaded
        const optImages = optionEls.map((el,i)=> uploadedUrls.optionImages[i] || null);
        data.pilihanJawaban = opts;
        data.penjelasanPilihan = reasons;
        data.jawabanBenar = correctBools; // always save as array of booleans to be consistent
        data.pilihanGambar = optImages;
      } else if(t==='multi_benar'){
        const rows = [...dynamicArea.querySelectorAll('.multi-answer')].map((el,i)=>({
            teks: el.value.trim(),
            benar: !!dynamicArea.querySelectorAll('.multi-check')[i].checked,
            alasan: dynamicArea.querySelectorAll('.multi-reason')[i].value.trim()
        }));
        // validate at least one true
        if(rows.filter(r=>r.benar).length < 1) throw new Error('Tentukan minimal 1 jawaban benar untuk soal multi-benarnya.');
        data.pilihan = rows;
      } else if(t==='esai'){
        data.jawabanBenar = document.getElementById('esai-variations').value.trim(); // string with || separator
        data.penjelasanEsai = { benar: document.getElementById('esai-reason-correct').value.trim(), salah: document.getElementById('esai-reason-wrong').value.trim() };
      } else if(t==='pencocokan'){
        const pairs = [...dynamicArea.querySelectorAll('#pairs-container .answer-card')].map(card=>({
            kiri: card.querySelector('.pair-left').value.trim(),
            kanan: card.querySelector('.pair-right').value.trim(),
            alasan: card.querySelector('.pair-reason').value.trim()
        }));
        if(pairs.length < 1) throw new Error('Tambahkan minimal 1 pasangan untuk soal pencocokan.');
        data.pasangan = pairs;
      } else if(t==='susun_kata'){
        data.jawabanBenar = document.getElementById('susun-kalimat').value.trim();
        data.penjelasanSusun = { benar: document.getElementById('susun-reason-true').value.trim(), salah: document.getElementById('susun-reason-false').value.trim() };
      } else if(t==='multi_benar'){
        // handled above
      } else if(t==='benar_salah'){
        data.jawabanBenar = dynamicArea.querySelector('input[name="bs"]:checked').value;
        data.penjelasanBS = { benar: document.getElementById('bs-reason-true').value.trim(), salah: document.getElementById('bs-reason-false').value.trim() };
      } else if(t==='tts_mini'){
        const mendatar = document.getElementById('tts-mendatar').value.trim();
        const menurun = document.getElementById('tts-menurun').value.trim();
        if(!mendatar || !menurun) throw new Error('Jawaban mendatar dan menurun harus diisi.');
        const intersection = findIntersection(mendatar, menurun);
        if(!intersection) throw new Error('Mendatar dan menurun harus memiliki minimal 1 huruf yang sama.');
        data.jawaban = { mendatar, menurun, mendatarIndex: intersection.mendatarIndex, menurunIndex: intersection.menurunIndex };
        data.penjelasanTTS = { semua_benar: document.getElementById('tts-reason').value.trim() };
      }

      // write to firestore
      const batch = writeBatch(db);
      const ref = doc(collection(db,'pertanyaan'));
      batch.set(ref, data);
      await batch.commit();
      showFormMessage('ok','Pertanyaan berhasil disimpan ✅');
      document.getElementById('question-form').reset();
      uploadedImageUrl = null; uploadedAudioUrl = null; pendingUploads = { questionImage:null, questionAudio:null, optionImages:{} };
      document.getElementById('file-image-name').textContent = 'Belum ada file dipilih';
      document.getElementById('file-audio-name').textContent = 'Belum ada file dipilih';
      renderDynamic();
    }catch(err){ console.error(err); showFormMessage('err', err.message || 'Gagal menyimpan soal'); }
    finally{ btnSave.disabled=false; btnSave.textContent='Simpan Pertanyaan'; }
  });\n\n// preview builder
  btnPreview.addEventListener('click', ()=>{
    const q = document.getElementById('pertanyaan-teks').value.trim();
    if(!q){ previewCard.textContent='Tulis pertanyaan dulu untuk melihat pratinjau'; return; }
    const t = tipeSoal.value;
    let html = `<strong style="color:white">${q}</strong><div style="margin-top:8px;font-size:0.95rem;color:var(--muted-light)">Tipe: ${t}</div>`;
    if(uploadedImageUrl) html += `<div style="margin-top:8px"><img src="${uploadedImageUrl}" style="max-width:100%;border-radius:8px"></div>`;
    if(uploadedAudioUrl) html += `<div style="margin-top:8px"><audio controls src="${uploadedAudioUrl}" style="width:100%"></audio></div>`;
    if(t==='pilihan_ganda'){
      const optionEls = [...dynamicArea.querySelectorAll('.answer-card')];
      html += '<div style="margin-top:10px">';
      optionEls.forEach((el,i)=>{
        const teks = el.querySelector('.jawaban')?.value.trim()||`Pilihan ${i+1}`;
        const alasan = el.querySelector('.jawaban-alasan')?.value.trim()||'';
        const benar = !!el.querySelector('.pg-check')?.checked;
        html += `<div style="text-align:left;padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.02)"><strong>${teks}</strong><div class="note">Benar: ${benar}</div><div style="margin-top:6px;color:var(--muted-light)">${alasan||'Belum ada alasan'}</div></div>`;
      });
      html += '</div>';
    }
    previewCard.innerHTML = html;
  });

  document.getElementById('btn-reset').addEventListener('click', ()=>{
    document.getElementById('question-form').reset(); uploadedImageUrl=null; uploadedAudioUrl=null; pendingUploads = { questionImage:null, questionAudio:null, optionImages:{} }; document.getElementById('file-image-name').textContent='Belum ada file dipilih'; document.getElementById('file-audio-name').textContent='Belum ada file dipilih'; renderDynamic();
  });

</script>
</body>
</html>
