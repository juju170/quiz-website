<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil & Pengaturan Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body { 
            font-family: 'Baloo 2', sans-serif; 
            background: linear-gradient(-45deg, #fde68a, #fca5a5, #818cf8, #60a5fa, #f472b6); 
            background-size: 400% 400%; 
            animation: gradient-animation 25s ease infinite; 
            color: #4B5563; 
        }
        .font-heading { font-family: 'Fredoka One', cursive; }

        /* Gaya dari Halaman Profil Lencana */
        .profile-header { background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); border-bottom: 5px solid white; border-radius: 0 0 50% 50% / 0 0 30% 30%; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .badge-card { background-color: rgba(255, 255, 255, 0.7); border-radius: 24px; padding: 1.5rem; text-align: center; border: 3px solid white; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.07); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .badge-card:hover { transform: translateY(-10px) rotate(2deg); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1); }
        .badge-icon-container { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; transition: transform 0.3s ease; }
        .gold { background-color: #FFFBEB; border: 4px solid #FBBF24; color: #FBBF24; }
        .silver { background-color: #F9FAFB; border: 4px solid #D1D5DB; color: #9CA3AF; }
        .bronze { background-color: #FEF2F2; border: 4px solid #F59E0B; color: #D97706; }
        .history-item { background: rgba(255, 255, 255, 0.8); border-radius: 20px; padding: 1.25rem 1.5rem; display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 2px solid white; }
        
        /* Gaya dari Halaman Pemilihan Kelas */
        .selection-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        .input-field {
            width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb;
            border-radius: 12px; transition: all 0.3s ease;
            -webkit-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .btn-save { background: #3b82f6; color: white; font-weight: 700; padding: 12px; border-radius: 12px; transition: background-color 0.3s; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .btn-save:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }

        /* Tombol Beranda */
        .tombol-beranda { position: fixed; bottom: 20px; right: 20px; background-color: #FFC107; color: #333; padding: 12px 20px; border-radius: 50px; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; font-weight: 700; text-decoration: none; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); transition: transform 0.2s ease, box-shadow 0.2s ease; z-index: 1000; }
        .tombol-beranda:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); }
    </style>
</head>
<body class="min-h-screen">

    <!-- KONTEN 1: PEMILIHAN KELAS (Tampil jika kelas belum diatur) -->
    <div id="class-selection-view" class="hidden flex items-center justify-center min-h-screen p-4">
        <main class="selection-card w-full max-w-md p-8 text-center">
            <h1 class="font-heading text-3xl font-bold text-gray-800 mb-2">Selamat Datang!</h1>
            <p class="text-gray-500 mb-6">Pilih dulu kelasmu untuk melanjutkan ke profil.</p>
            
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6 text-left">
                <p class="font-bold">Perhatian!</p>
                <p class="text-sm">Pilihan kelas ini akan terkunci selama **satu tahun ajaran**. Kamu bisa memilih kelas baru saat tahun ajaran berikutnya dimulai.</p>
            </div>

            <div class="mb-6 text-left">
                <label for="class-select" class="font-semibold text-gray-600 block mb-2">Pilih Kelasmu Saat Ini</label>
                <select id="class-select" class="input-field bg-white">
                    <option value="" disabled selected>-- Klik di sini --</option>
                    <option value="Kelas 1">Kelas 1</option>
                    <option value="Kelas 2">Kelas 2</option>
                    <option value="Kelas 3">Kelas 3</option>
                    <option value="Kelas 4">Kelas 4</option>
                    <option value="Kelas 5">Kelas 5</option>
                    <option value="Kelas 6">Kelas 6</option>
                </select>
            </div>

            <button id="save-class-btn" class="btn-save w-full text-lg">Lanjut ke Profil</button>
            <p id="feedback-text" class="text-green-600 font-semibold mt-4 h-5"></p>
        </main>
    </div>

    <!-- KONTEN 2: HALAMAN PROFIL (Tampil jika kelas sudah diatur) -->
    <div id="profile-view" class="hidden">
        <header class="profile-header text-gray-800 text-center pt-12 pb-24 mb-[-100px] relative">
            <div class="relative inline-block">
                <div class="w-32 h-32 rounded-full bg-white/50 p-2 mx-auto ring-4 ring-white">
                     <img src="https://placehold.co/128x128/fca5a5/7c2d12.png?text=A" id="profile-avatar" class="w-full h-full rounded-full object-cover" alt="Avatar Pengguna">
                </div>
                <span class="absolute -bottom-2 -right-2 bg-yellow-300 text-yellow-800 p-3 rounded-full text-3xl shadow-md transform rotate-12">‚≠ê</span>
            </div>
            <h1 id="profile-name" class="font-heading text-4xl md:text-5xl mt-4 drop-shadow-md">Memuat Nama...</h1>
            <p id="profile-class" class="text-lg font-bold opacity-80 mt-1">Memuat Kelas...</p>
        </header>
        <main class="container mx-auto p-4 md:p-8 max-w-3xl relative z-10">
            <section class="bg-white/40 backdrop-blur-sm p-6 md:p-8 rounded-3xl shadow-lg border-4 border-white">
                <h2 class="font-heading text-3xl text-center text-rose-500 mb-6 drop-shadow-sm">üèÜ Lencana Prestasiku üèÜ</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div class="badge-card"><div class="badge-icon-container gold"><img src="https://cdn-icons-png.flaticon.com/512/2583/2583344.png" class="w-12 h-12" alt="Medali Emas"></div><h3 class="text-xl font-extrabold text-gray-800">Lencana Emas</h3><p id="gold-badge-count" class="text-5xl font-black text-amber-500 drop-shadow-md">0</p></div>
                    <div class="badge-card"><div class="badge-icon-container silver"><img src="https://cdn-icons-png.flaticon.com/512/2583/2583343.png" class="w-12 h-12" alt="Medali Perak"></div><h3 class="text-xl font-extrabold text-gray-800">Lencana Perak</h3><p id="silver-badge-count" class="text-5xl font-black text-gray-500 drop-shadow-md">0</p></div>
                    <div class="badge-card"><div class="badge-icon-container bronze"><img src="https://cdn-icons-png.flaticon.com/512/2583/2583342.png" class="w-12 h-12" alt="Medali Perunggu"></div><h3 class="text-xl font-extrabold text-gray-800">Lencana Perunggu</h3><p id="bronze-badge-count" class="text-5xl font-black text-orange-500 drop-shadow-md">0</p></div>
                </div>
            </section>
            <section class="mt-10">
                <h2 class="font-heading text-3xl text-center text-indigo-500 mb-6 drop-shadow-sm">üìú Riwayat Belajarku</h2>
                <div id="quiz-history-list" class="space-y-4">
                    <p id="loading-history" class="text-center text-white font-bold bg-indigo-400 p-4 rounded-xl">Memuat riwayat kuis...</p>
                </div>
            </section>
        </main>
    </div>
    
    <!-- MODAL KONFIRMASI PEMILIHAN KELAS -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
        <h3 class="text-2xl font-bold mb-2 text-gray-800">Apakah Kamu Yakin?</h3>
        <p id="confirmation-text" class="text-gray-600 mb-6">Kamu telah memilih <strong>Kelas X</strong>. Apakah pilihan ini sudah benar sesuai kelasmu saat ini?</p>
        <div class="flex justify-center gap-4">
            <button id="cancel-btn" class="w-full bg-gray-200 hover:bg-gray-300 rounded-lg py-3 font-bold text-gray-700 transition">Batal</button>
            <button id="confirm-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white rounded-lg py-3 font-bold transition">Ya, Saya Yakin</button>
        </div>
      </div>
    </div>

    <a href="index.html" class="tombol-beranda" title="Kembali ke Beranda">
        <span>üè†</span><span>Beranda</span>
    </a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, getDoc, setDoc, collection, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc", authDomain: "forumwidara.firebaseapp.com", projectId: "forumwidara", storageBucket: "forumwidara.appspot.com", messagingSenderId: "216895655168", appId: "1:216895655168:web:59255f600fc3b3b44eb7e5" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const classSelectionView = document.getElementById('class-selection-view');
    const profileView = document.getElementById('profile-view');
    const classSelect = document.getElementById('class-select');
    const saveClassBtn = document.getElementById('save-class-btn');
    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmationText = document.getElementById('confirmation-text');
    const cancelBtn = document.getElementById('cancel-btn');
    const confirmBtn = document.getElementById('confirm-btn');

    // Elemen Profil
    const profileNameEl = document.getElementById('profile-name');
    const profileClassEl = document.getElementById('profile-class');
    const profileAvatarEl = document.getElementById('profile-avatar');
    const goldBadgeEl = document.getElementById('gold-badge-count');
    const silverBadgeEl = document.getElementById('silver-badge-count');
    const bronzeBadgeEl = document.getElementById('bronze-badge-count');
    const historyListEl = document.getElementById('quiz-history-list');

    let currentUserId = null;
    const SCHOOL_YEAR_START_MONTH = 6; // 0=Jan, 6=Juli

    // --- FUNGSI BARU: Menentukan tahun ajaran berdasarkan tanggal ---
    function getSchoolYear(date) {
        const year = date.getFullYear();
        const month = date.getMonth();
        // Jika bulan saat ini sebelum Juli, maka masih masuk tahun ajaran sebelumnya.
        // Contoh: Juni 2025 -> tahun ajaran 2024. Juli 2025 -> tahun ajaran 2025.
        return month < SCHOOL_YEAR_START_MONTH ? year - 1 : year;
    }

    onAuthStateChanged(auth, user => {
        if (user) {
            currentUserId = user.uid;
            checkUserProfile(user.uid);
        } else {
            signInAnonymously(auth).catch(err => console.error("Gagal login anonim:", err));
        }
    });

    async function checkUserProfile(userId) {
        const profileRef = doc(db, 'profiles', userId);
        const docSnap = await getDoc(profileRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            const classSetDate = data.classSetDate?.toDate();
            
            if (data.class && classSetDate) {
                // Logika baru: Cek berdasarkan TAHUN AJARAN (reset setiap bulan Juli)
                const classSetSchoolYear = getSchoolYear(classSetDate);
                const currentSchoolYear = getSchoolYear(new Date());

                if (currentSchoolYear <= classSetSchoolYear) {
                    // Kelas masih valid dalam tahun ajaran ini, tampilkan profil
                    showProfile(userId, data);
                    return;
                }
            }
        }
        showClassSelection();
    }

    function showClassSelection() {
        classSelectionView.classList.remove('hidden');
        profileView.classList.add('hidden');
    }

    function showProfile(userId, profileData) {
        classSelectionView.classList.add('hidden');
        profileView.classList.remove('hidden');
        loadUserData(userId);
        loadBadgeData(userId, profileData);
        loadHistoryData(userId);
    }
    
    saveClassBtn.addEventListener('click', () => {
        const selectedClass = classSelect.value;
        if (!selectedClass) {
            alert("Kamu harus memilih kelas terlebih dahulu!");
            return;
        }
        confirmationText.innerHTML = `Kamu telah memilih <strong>${selectedClass}</strong>. Apakah pilihan ini sudah benar sesuai kelasmu saat ini?`;
        confirmationModal.classList.remove('hidden');
    });

    cancelBtn.addEventListener('click', () => {
        confirmationModal.classList.add('hidden');
    });

    confirmBtn.addEventListener('click', async () => {
        const selectedClass = classSelect.value;
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Menyimpan...';

        try {
            const profileRef = doc(db, 'profiles', currentUserId);
            await setDoc(profileRef, { 
                class: selectedClass,
                classSetDate: new Date()
            }, { merge: true });
            
            checkUserProfile(currentUserId);
            
        } catch (error) {
            console.error("Gagal menyimpan kelas:", error);
            alert("Oops, terjadi kesalahan saat menyimpan kelasmu.");
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Ya, Saya Yakin';
            confirmationModal.classList.add('hidden');
        }
    });

    function loadUserData(userId) {
        const userRef = doc(db, 'users', userId);
        onSnapshot(userRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                const name = data.nama || 'Siswa Hebat';
                profileNameEl.textContent = name;
                const firstLetter = name.charAt(0).toUpperCase();
                profileAvatarEl.src = `https://placehold.co/128x128/fca5a5/7c2d12.png?text=${firstLetter}`;
            }
        });
    }

    function loadBadgeData(userId, profileData) {
        profileClassEl.textContent = profileData.class || 'Kelas belum diatur';
        goldBadgeEl.textContent = profileData.badges?.gold || 0;
        silverBadgeEl.textContent = profileData.badges?.silver || 0;
        bronzeBadgeEl.textContent = profileData.badges?.bronze || 0;
    }

    function loadHistoryData(userId) {
        const resultsRef = collection(db, 'results');
        const q = query(resultsRef, where("userId", "==", userId), orderBy("completedAt", "desc"));
        onSnapshot(q, (querySnap) => {
            historyListEl.innerHTML = '';
            if (querySnap.docs.length === 0) {
                 historyListEl.innerHTML = '<p class="text-center text-white font-bold bg-rose-400 p-4 rounded-xl">Kamu belum mengerjakan kuis apapun.</p>';
                 return;
            }
            querySnap.docs.forEach(doc => {
                const result = doc.data();
                const item = document.createElement('div');
                item.className = 'history-item';
                const date = result.completedAt?.toDate().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) || 'Baru saja';
                let scoreColor = result.score >= 80 ? '#22c55e' : result.score >= 60 ? '#f59e0b' : '#ef4444';
                item.innerHTML = `<div class="flex-grow"><p class="font-bold text-lg text-gray-800">${result.quizTitle}</p><p class="text-sm text-gray-500">${date}</p></div><div class="text-right"><p class="font-extrabold text-2xl" style="color:${scoreColor}">${result.score}</p></div>`;
                historyListEl.appendChild(item);
            });
        });
    }

</script>
</body>
</html>


