<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Ceria Anak Hebat!</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Animasi Gradien Latar Belakang */
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body { 
            font-family: 'Baloo 2', sans-serif; 
            background: linear-gradient(-45deg, #fde68a, #fca5a5, #818cf8, #60a5fa, #f472b6);
            background-size: 400% 400%;
            animation: gradient-animation 25s ease infinite;
            color: #4B5563;
        }
        
        .font-heading { font-family: 'Fredoka One', cursive; }
        
        /* Header Profil dengan Bentuk Awan */
        .profile-header { 
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 5px solid white;
            border-radius: 0 0 50% 50% / 0 0 30% 30%; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        /* Kartu Lencana dengan Efek Hover */
        .badge-card { 
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 24px; 
            padding: 1.5rem; 
            text-align: center; 
            border: 3px solid white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.07); 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
        }
        .badge-card:hover { 
            transform: translateY(-10px) rotate(2deg); 
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1); 
        }
        
        .badge-icon-container { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0 auto 1rem; 
            transition: transform 0.3s ease;
        }
        .badge-card:hover .badge-icon-container {
            transform: scale(1.1) rotate(-5deg);
        }
        
        .gold { background-color: #FFFBEB; border: 4px solid #FBBF24; color: #FBBF24; }
        .silver { background-color: #F9FAFB; border: 4px solid #D1D5DB; color: #9CA3AF; }
        .bronze { background-color: #FEF2F2; border: 4px solid #F59E0B; color: #D97706; }

        /* Item Riwayat dengan Tampilan Ceria */
        .history-item { 
            background: rgba(255, 255, 255, 0.8); 
            border-radius: 20px; 
            padding: 1.25rem 1.5rem; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 1rem; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 2px solid white;
        }
        
        .progress-bar { 
            background-color: rgba(0,0,0,0.1); 
            border-radius: 999px; 
            height: 12px; 
            width: 100px; 
            overflow: hidden; 
            border: 1px solid white;
        }
        .progress-bar-inner { 
            height: 100%; 
            border-radius: 999px; 
        }
        .tombol-beranda {
            position: fixed; /* Membuat posisi tombol tetap saat di-scroll */
            bottom: 20px;
            right: 20px;
            
            background-color: #FFC107; /* Warna kuning amber yang cerah */
            color: #333; /* Warna teks gelap agar mudah dibaca */
            
            padding: 12px 20px; /* Jarak antara teks dan tepi tombol */
            border-radius: 50px; /* Sudut cembung/bulat sempurna (pill shape) */
            
            display: flex; /* Mengaktifkan flexbox untuk alignment */
            align-items: center; /* Menengahkan teks dan ikon secara vertikal */
            gap: 8px; /* Jarak antara emoji dan teks "Beranda" */
            
            font-family: 'Baloo 2', sans-serif; /* Menggunakan font yang sesuai tema */
            font-size: 1.1rem;
            font-weight: 700;
            text-decoration: none; /* Menghilangkan garis bawah pada link */
            
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); /* Efek bayangan halus */
            transition: transform 0.2s ease, box-shadow 0.2s ease; /* Animasi halus */
            z-index: 1000; /* Memastikan tombol selalu di lapisan paling atas */
        }

        .tombol-beranda:hover {
            transform: translateY(-3px); /* Sedikit terangkat saat disentuh */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); /* Bayangan lebih jelas */
        }
    </style>
</head>
<body class="">
        <!-- Header Profil -->
        <header class="profile-header text-gray-800 text-center pt-12 pb-24 mb-[-100px] relative">
            <div class="relative inline-block">
                <div class="w-32 h-32 rounded-full bg-white/50 p-2 mx-auto ring-4 ring-white">
                     <img src="https://placehold.co/128x128/fca5a5/7c2d12.png?text=A" id="profile-avatar" class="w-full h-full rounded-full object-cover" alt="Avatar Pengguna">
                </div>
                <!-- Emoji Ceria -->
                <span class="absolute -bottom-2 -right-2 bg-yellow-300 text-yellow-800 p-3 rounded-full text-3xl shadow-md transform rotate-12">‚≠ê</span>
            </div>
            <h1 id="profile-name" class="font-heading text-4xl md:text-5xl mt-4 drop-shadow-md">Memuat Nama...</h1>
            <p id="profile-email" class="opacity-70 mt-1">Memuat email...</p>
        </header>

        <main class="container mx-auto p-4 md:p-8 max-w-3xl relative z-10">
            <!-- Bagian Lencana Prestasi -->
            <section class="bg-white/40 backdrop-blur-sm p-6 md:p-8 rounded-3xl shadow-lg border-4 border-white">
                <h2 class="font-heading text-3xl text-center text-rose-500 mb-6 drop-shadow-sm">üèÜ Lencana Prestasiku üèÜ</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <!-- Kartu Lencana Emas -->
                    <div class="badge-card">
                        <div class="badge-icon-container gold"><i data-lucide="award" class="w-10 h-10"></i></div>
                        <h3 class="text-xl font-extrabold text-gray-800">Lencana Emas</h3>
                        <p id="gold-badge-count" class="text-5xl font-black text-amber-500 drop-shadow-md">0</p>
                    </div>
                    <!-- Kartu Lencana Perak -->
                    <div class="badge-card">
                        <div class="badge-icon-container silver"><i data-lucide="shield" class="w-10 h-10"></i></div>
                        <h3 class="text-xl font-extrabold text-gray-800">Lencana Perak</h3>
                        <p id="silver-badge-count" class="text-5xl font-black text-gray-500 drop-shadow-md">0</p>
                    </div>
                    <!-- Kartu Lencana Perunggu -->
                    <div class="badge-card">
                        <div class="badge-icon-container bronze"><i data-lucide="medal" class="w-10 h-10"></i></div>
                        <h3 class="text-xl font-extrabold text-gray-800">Lencana Perunggu</h3>
                        <p id="bronze-badge-count" class="text-5xl font-black text-orange-500 drop-shadow-md">0</p>
                    </div>
                </div>
            </section>

            <!-- Bagian Riwayat Kuis -->
            <section class="mt-10">
                <h2 class="font-heading text-3xl text-center text-indigo-500 mb-6 drop-shadow-sm">üìú Riwayat Belajarku</h2>
                <div id="quiz-history-list" class="space-y-4">
                    <p id="loading-history" class="text-center text-white font-bold bg-indigo-400 p-4 rounded-xl">Memuat riwayat kuis...</p>
                </div>
            </section>
        </main>

    <script type="module">
        // Impor fungsi-fungsi Firebase yang dibutuhkan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Konfigurasi Firebase (tetap sama)
        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.appspot.com",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Elemen-elemen Halaman
        const profileNameEl = document.getElementById('profile-name');
        const profileEmailEl = document.getElementById('profile-email');
        const profileAvatarEl = document.getElementById('profile-avatar');
        const goldBadgeEl = document.getElementById('gold-badge-count');
        const silverBadgeEl = document.getElementById('silver-badge-count');
        const bronzeBadgeEl = document.getElementById('bronze-badge-count');
        const historyListEl = document.getElementById('quiz-history-list');

        // Fungsi untuk menampilkan data pengguna (nama, email, avatar)
        function renderUserData(data) {
            const name = data.nama || 'Siswa Hebat';
            profileNameEl.textContent = name;
            profileEmailEl.textContent = data.email || 'email@anak.id';
            // Membuat avatar dari huruf pertama nama
            const firstLetter = name.charAt(0).toUpperCase();
            profileAvatarEl.src = `https://placehold.co/128x128/fca5a5/7c2d12.png?text=${firstLetter}`;
        }
        
        // Fungsi untuk menampilkan data lencana (tidak berubah)
        function renderBadgeData(data) {
            goldBadgeEl.textContent = data.badges?.gold || 0;
            silverBadgeEl.textContent = data.badges?.silver || 0;
            bronzeBadgeEl.textContent = data.badges?.bronze || 0;
        }

        // Fungsi untuk menampilkan riwayat kuis (tidak berubah)
        function renderHistory(docs) {
            historyListEl.innerHTML = '';
            if (docs.length === 0) {
                 historyListEl.innerHTML = '<p class="text-center text-white font-bold bg-rose-400 p-4 rounded-xl">Kamu belum mengerjakan kuis apapun. Yuk, mulai belajar!</p>';
                 return;
            }
            docs.forEach(doc => {
                const result = doc.data();
                const item = document.createElement('div');
                item.className = 'history-item';
                const date = result.completedAt?.toDate().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) || 'Baru saja';
                let scoreColor = result.score >= 80 ? '#22c55e' : result.score >= 60 ? '#f59e0b' : '#ef4444';
                
                item.innerHTML = `
                    <div>
                        <p class="font-bold text-lg text-gray-800">${result.quizTitle}</p>
                        <p class="text-sm text-gray-500">${date}</p>
                    </div>
                    <div class="text-right">
                         <p class="font-extrabold text-lg" style="color:${scoreColor}">Skor: ${result.score}</p>
                         <div class="progress-bar mt-1"><div class="progress-bar-inner" style="width: ${result.score}%; background-color: ${scoreColor};"></div></div>
                    </div>`;
                historyListEl.appendChild(item);
            });
        }

        // --- FUNGSI BARU UNTUK MENDENGARKAN DATA PENGGUNA DARI KOLEKSI 'USERS' ---
        function listenToUserData(userId) {
            const userRef = doc(db, 'users', userId);
            onSnapshot(userRef, (doc) => {
                if (doc.exists()) {
                    renderUserData(doc.data());
                } else {
                    console.log("Data pengguna tidak ditemukan di koleksi 'users'.");
                    renderUserData({ nama: 'Siswa Baru', email: 'tidak diketahui' });
                }
            });
        }
        
        // --- FUNGSI LAMA (MODIFIKASI) UNTUK MENDENGARKAN DATA LENCANA DARI KOLEKSI 'PROFILES' ---
        function listenToProfileBadges(userId) {
            const profileRef = doc(db, 'profiles', userId);
            onSnapshot(profileRef, (doc) => {
                if (doc.exists()) {
                    renderBadgeData(doc.data());
                } else {
                    console.log("Profil lencana belum ada, akan dibuat saat kuis pertama diselesaikan.");
                    renderBadgeData({ badges: { gold: 0, silver: 0, bronze: 0 } });
                }
            });
        }

        // --- FUNGSI LAMA (MODIFIKASI) UNTUK MENDENGARKAN RIWAYAT KUIS ---
        function listenToHistory(userId) {
            const resultsRef = collection(db, 'results');
            const q = query(resultsRef, where("userId", "==", userId), orderBy("completedAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const loadingEl = document.getElementById('loading-history');
                if(loadingEl) loadingEl.style.display = 'none';
                renderHistory(snapshot.docs);
            }, (error) => {
                console.error("Gagal mendengarkan riwayat: ", error);
                historyListEl.innerHTML = '<p class="text-center text-red-500">Gagal memuat riwayat.</p>';
            });
        }

        // --- Pemeriksaan Status Login Pengguna ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Pengguna sudah login
                const uid = user.uid;
                
                // Panggil semua fungsi listener dengan UID pengguna yang sebenarnya
                listenToUserData(uid); // <-- Integrasi baru
                listenToProfileBadges(uid); // <-- Integrasi lama (lencana)
                listenToHistory(uid); // <-- Integrasi lama (riwayat)
                
            } else {
                // Pengguna belum login, arahkan ke halaman login
                console.log("Pengguna belum login, mengalihkan...");
                window.location.href = 'login.html';
            }
        });

        // Inisialisasi ikon saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

    </script>
    <a href="index.html" class="tombol-beranda" title="Kembali ke Beranda">
        <span>üè†</span>
        <span>Beranda</span>
    </a>
</body>
</html>

