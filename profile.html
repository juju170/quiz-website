<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil & Prestasiku!</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f9ff; }
        .font-heading { font-family: 'Fredoka One', cursive; }
        .profile-header { background: linear-gradient(135deg, #60A5FA, #3B82F6); border-radius: 0 0 50% 50% / 0 0 20% 20%; }
        .badge-card { background-color: white; border-radius: 20px; padding: 1.5rem; text-align: center; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.07); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .badge-card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1); }
        .badge-icon-container { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items-center; justify-content: center; margin: 0 auto 1rem; }
        .gold { background-color: #FFFBEB; border: 3px solid #FBBF24; color: #FBBF24; }
        .silver { background-color: #F9FAFB; border: 3px solid #D1D5DB; color: #9CA3AF; }
        .bronze { background-color: #FEF2F2; border: 3px solid #F59E0B; color: #D97706; }
        .history-item { background: white; border-radius: 16px; padding: 1rem 1.5rem; display: flex; align-items-center; justify-content: space-between; margin-bottom: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .progress-bar { background-color: #e5e7eb; border-radius: 999px; height: 10px; width: 100px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background: linear-gradient(90deg, #34D399, #10B981); border-radius: 999px; }
    </style>
</head>
<body class="text-gray-700">
        <header class="profile-header text-white text-center pt-12 pb-24 mb-[-100px] relative">
            <div class="relative inline-block">
                <div class="w-32 h-32 rounded-full bg-white/30 p-2 mx-auto">
                     <svg class="w-full h-full text-white" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <span class="absolute -bottom-2 -right-2 bg-yellow-400 text-yellow-900 p-2 rounded-full text-2xl">ðŸ¤ </span>
            </div>
            <h1 id="profile-name" class="font-heading text-4xl md:text-5xl mt-4">Memuat Nama...</h1>
            <p class="opacity-80">Siswa Kelas 4B</p>
        </header>

        <main class="container mx-auto p-4 md:p-8 max-w-3xl relative z-10">
            <section class="bg-white/70 backdrop-blur-sm p-6 md:p-8 rounded-3xl shadow-lg">
                <h2 class="font-heading text-3xl text-center text-amber-600 mb-6">ðŸ¥‡ Lencana Prestasiku</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div class="badge-card">
                        <div class="badge-icon-container gold"><i data-lucide="award" class="w-10 h-10"></i></div>
                        <h3 class="text-xl font-extrabold text-gray-800">Lencana Emas</h3>
                        <p id="gold-badge-count" class="text-4xl font-black text-amber-500">0</p>
                    </div>
                    <div class="badge-card">
                        <div class="badge-icon-container silver"><i data-lucide="shield" class="w-10 h-10"></i></div>
                        <h3 class="text-xl font-extrabold text-gray-800">Lencana Perak</h3>
                        <p id="silver-badge-count" class="text-4xl font-black text-gray-500">0</p>
                    </div>
                    <div class="badge-card">
                        <div class="badge-icon-container bronze"><i data-lucide="medal" class="w-10 h-10"></i></div>
                        <h3 class="text-xl font-extrabold text-gray-800">Lencana Perunggu</h3>
                        <p id="bronze-badge-count" class="text-4xl font-black text-orange-500">0</p>
                    </div>
                </div>
            </section>

            <section class="mt-10">
                <h2 class="font-heading text-3xl text-center text-blue-600 mb-6">ðŸ“œ Riwayat Kuis</h2>
                <div id="quiz-history-list" class="space-y-4">
                    <p id="loading-history" class="text-center text-gray-500 col-span-full">Memuat riwayat kuis...</p>
                </div>
            </section>
        </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.appspot.com",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Pastikan ID Pengguna ini sama persis dengan yang ada di play.html
        const DUMMY_USER_ID = 'user_abc_123'; 

        const profileNameEl = document.getElementById('profile-name');
        const goldBadgeEl = document.getElementById('gold-badge-count');
        const silverBadgeEl = document.getElementById('silver-badge-count');
        const bronzeBadgeEl = document.getElementById('bronze-badge-count');
        const historyListEl = document.getElementById('quiz-history-list');

        function renderProfile(data) {
            profileNameEl.textContent = data.name || 'Nama Siswa';
            goldBadgeEl.textContent = data.badges?.gold || 0;
            silverBadgeEl.textContent = data.badges?.silver || 0;
            bronzeBadgeEl.textContent = data.badges?.bronze || 0;
        }

        function renderHistory(docs) {
            historyListEl.innerHTML = '';
            if (docs.length === 0) {
                 historyListEl.innerHTML = '<p class="text-center text-gray-500">Belum ada riwayat kuis.</p>';
                 return;
            }
            docs.forEach(doc => {
                const result = doc.data();
                const item = document.createElement('div');
                item.className = 'history-item';
                const date = result.completedAt?.toDate().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) || 'Baru saja';
                let scoreColor = result.score >= 80 ? 'text-green-500' : result.score >= 60 ? 'text-yellow-500' : 'text-red-500';
                item.innerHTML = `
                    <div>
                        <p class="font-bold text-lg text-gray-800">${result.quizTitle}</p>
                        <p class="text-sm text-gray-500">${date}</p>
                    </div>
                    <div class="text-right">
                         <p class="font-extrabold text-lg ${scoreColor}">Skor: ${result.score}</p>
                         <div class="progress-bar mt-1"><div class="progress-bar-inner" style="width: ${result.score}%; background-color: ${scoreColor.replace('text-', '')};"></div></div>
                    </div>`;
                historyListEl.appendChild(item);
            });
        }

        function listenToProfile() {
            const profileRef = doc(db, 'profiles', DUMMY_USER_ID);
            onSnapshot(profileRef, (doc) => {
                if (doc.exists()) {
                    renderProfile(doc.data());
                } else {
                    console.log("Profil belum ada, akan dibuat saat kuis pertama diselesaikan.");
                    renderProfile({ name: 'Siswa Baru', badges: { gold: 0, silver: 0, bronze: 0 } });
                }
            });
        }

        function listenToHistory() {
            const resultsRef = collection(db, 'results');
            // Urutkan riwayat dari yang terbaru
            const q = query(resultsRef, where("userId", "==", DUMMY_USER_ID), orderBy("completedAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                document.getElementById('loading-history').style.display = 'none';
                renderHistory(snapshot.docs);
            }, (error) => {
                console.error("Gagal mendengarkan riwayat: ", error);
                historyListEl.innerHTML = '<p class="text-center text-red-500">Gagal memuat riwayat.</p>';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            listenToProfile();
            listenToHistory();
        });

    </script>
</body>
</html>

