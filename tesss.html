<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cerita Interaktif (Aman)</title>
    <!-- Menggunakan Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .view-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .view-hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
        }
        #app-container.loading {
            display: none;
        }
        #global-loader {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <!-- Loader utama saat autentikasi -->
    <div id="global-loader" class="flex flex-col items-center justify-center">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-600">Menghubungkan ke server...</p>
    </div>

    <!-- Kontainer aplikasi utama, tersembunyi saat loading -->
    <div id="app-container" class="w-full max-w-2xl mx-auto loading">
        <!-- Tombol untuk ganti mode -->
        <div class="flex justify-center mb-4">
            <button id="mode-switcher" class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all">
                Ganti ke Mode Player
            </button>
        </div>

        <!-- Container Utama -->
        <div class="relative">
            <!-- Mode Admin untuk Input Cerita -->
            <div id="admin-view" class="bg-white p-6 md:p-8 rounded-lg shadow-lg view-transition">
                <h1 class="text-2xl font-bold mb-6 text-center">Admin: Buat/Edit Cerita</h1>
                <form id="story-form" class="space-y-4">
                    <div>
                        <label for="node-id" class="block text-sm font-medium text-gray-700">ID Node Cerita</label>
                        <input type="text" id="node-id" placeholder="Contoh: awal, gua-naga, kastil" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="story-text" class="block text-sm font-medium text-gray-700">Teks Cerita</label>
                        <textarea id="story-text" rows="4" placeholder="Tuliskan paragraf cerita di sini..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required></textarea>
                    </div>
                    <div>
                        <label for="image-url" class="block text-sm font-medium text-gray-700">URL Gambar (opsional)</label>
                        <input type="url" id="image-url" placeholder="https://res.cloudinary.com/.../gambar.jpg" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    
                    <div class="border-t pt-4">
                        <h2 class="text-lg font-semibold mb-2">Pilihan 1</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="choice1-label" class="block text-sm font-medium text-gray-700">Teks Tombol</label>
                                <input type="text" id="choice1-label" placeholder="Masuk ke gua" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="choice1-next" class="block text-sm font-medium text-gray-700">ID Node Tujuan</label>
                                <input type="text" id="choice1-next" placeholder="gua-naga" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </div>
                    <div class="border-t pt-4">
                        <h2 class="text-lg font-semibold mb-2">Pilihan 2</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label for="choice2-label" class="block text-sm font-medium text-gray-700">Teks Tombol</label>
                                <input type="text" id="choice2-label" placeholder="Pergi ke kastil" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="choice2-next" class="block text-sm font-medium text-gray-700">ID Node Tujuan</label>
                                <input type="text" id="choice2-next" placeholder="kastil" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Simpan Node
                    </button>
                </form>
                 <p id="admin-message" class="mt-4 text-center text-green-600 font-medium"></p>
            </div>

            <!-- Mode Player untuk Memainkan Cerita -->
            <div id="player-view" class="bg-white p-6 md:p-8 rounded-lg shadow-lg text-center view-transition view-hidden w-full">
                <div id="story-container">
                    <img id="story-image" src="" alt="Gambar Cerita" class="max-w-full h-auto max-h-80 mx-auto rounded-lg mb-4 shadow-md hidden">
                    <p id="story-content" class="text-gray-700 text-lg leading-relaxed mb-6 whitespace-pre-wrap">Memuat cerita...</p>
                    <div id="choices-container" class="flex flex-col md:flex-row justify-center gap-4"></div>
                    <p id="story-end" class="text-xl font-bold text-gray-500 mt-6 hidden">~ Cerita Selesai ~</p>
                </div>
                 <div id="loading-indicator" class="text-center p-8">
                    <p class="text-gray-500">Memuat cerita...</p>
                 </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import fungsi yang dibutuhkan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // --- PERUBAHAN: Import modul Auth ---
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // =================================================================================
        // TODO: GANTI DENGAN KONFIGURASI FIREBASE ANDA
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
    authDomain: "forumwidara.firebaseapp.com",
    projectId: "forumwidara",
    storageBucket: "forumwidara.firebasestorage.app",
    messagingSenderId: "216895655168",
    appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };
        // =================================================================================

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        // --- PERUBAHAN: Inisialisasi Auth ---
        const auth = getAuth(app);
        
        const globalLoader = document.getElementById('global-loader');
        const appContainer = document.getElementById('app-container');

        /**
         * Fungsi utama yang akan dijalankan SETELAH autentikasi berhasil
         */
        function initializeAppLogic() {
            // Sembunyikan loader utama dan tampilkan aplikasi
            globalLoader.style.display = 'none';
            appContainer.classList.remove('loading');

            // === VARIABEL & ELEMENT DOM ===
            let currentMode = 'admin';
            const modeSwitcher = document.getElementById('mode-switcher');
            const adminView = document.getElementById('admin-view');
            const playerView = document.getElementById('player-view');
            
            const storyForm = document.getElementById('story-form');
            const adminMessage = document.getElementById('admin-message');

            const storyImage = document.getElementById('story-image');
            const storyContent = document.getElementById('story-content');
            const choicesContainer = document.getElementById('choices-container');
            const storyEnd = document.getElementById('story-end');
            const loadingIndicator = document.getElementById('loading-indicator');
            const storyContainer = document.getElementById('story-container');

            // === FUNGSI-FUNGSI ===
            function toggleMode() {
                if (currentMode === 'admin') {
                    currentMode = 'player';
                    modeSwitcher.textContent = 'Ganti ke Mode Admin';
                    adminView.classList.add('view-hidden');
                    playerView.classList.remove('view-hidden');
                    loadStoryNode('node1');
                } else {
                    currentMode = 'admin';
                    modeSwitcher.textContent = 'Ganti ke Mode Player';
                    playerView.classList.add('view-hidden');
                    adminView.classList.remove('view-hidden');
                }
            }
            
            async function saveStoryNode(event) {
                event.preventDefault();
                const nodeId = document.getElementById('node-id').value.trim();
                if (!nodeId) {
                    alert('ID Node Cerita tidak boleh kosong.');
                    return;
                }
                const storyData = {
                    text: document.getElementById('story-text').value.trim(),
                    image: document.getElementById('image-url').value.trim(),
                    choices: {}
                };
                const choice1Label = document.getElementById('choice1-label').value.trim();
                const choice1Next = document.getElementById('choice1-next').value.trim();
                const choice2Label = document.getElementById('choice2-label').value.trim();
                const choice2Next = document.getElementById('choice2-next').value.trim();
                if (choice1Label && choice1Next) storyData.choices.a = { label: choice1Label, next: choice1Next };
                if (choice2Label && choice2Next) storyData.choices.b = { label: choice2Label, next: choice2Next };
                if (Object.keys(storyData.choices).length === 0) delete storyData.choices;

                try {
                    await set(ref(database, 'story/' + nodeId), storyData);
                    adminMessage.textContent = `Node "${nodeId}" berhasil disimpan!`;
                    storyForm.reset();
                    setTimeout(() => { adminMessage.textContent = ''; }, 3000);
                } catch (error) {
                    console.error("Gagal menyimpan data:", error);
                    adminMessage.textContent = 'Gagal menyimpan data. Cek konsol.';
                    adminMessage.classList.replace('text-green-600', 'text-red-600');
                }
            }

            async function loadStoryNode(nodeId) {
                loadingIndicator.style.display = 'block';
                storyContainer.style.display = 'none';
                storyEnd.classList.add('hidden');
                
                const nodeRef = ref(database, 'story/' + nodeId);
                
                try {
                    const snapshot = await get(nodeRef);
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        if (data.image) {
                            storyImage.src = data.image;
                            storyImage.classList.remove('hidden');
                        } else {
                            storyImage.classList.add('hidden');
                        }
                        storyContent.textContent = data.text;
                        choicesContainer.innerHTML = '';
                        if (data.choices) {
                            for (const key in data.choices) {
                                const choice = data.choices[key];
                                const button = document.createElement('button');
                                button.textContent = choice.label;
                                button.className = "w-full md:w-auto flex-grow px-4 py-3 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform transform hover:scale-105";
                                button.onclick = () => loadStoryNode(choice.next);
                                choicesContainer.appendChild(button);
                            }
                        } else {
                            storyEnd.classList.remove('hidden');
                        }
                    } else {
                        storyContent.textContent = `Error: Alur cerita dengan ID "${nodeId}" tidak ditemukan.`;
                        choicesContainer.innerHTML = '';
                        storyEnd.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Gagal memuat data:", error);
                    storyContent.textContent = "Gagal memuat cerita. Periksa koneksi atau aturan keamanan Firebase.";
                } finally {
                    loadingIndicator.style.display = 'none';
                    storyContainer.style.display = 'block';
                }
            }

            // === EVENT LISTENERS ===
            modeSwitcher.addEventListener('click', toggleMode);
            storyForm.addEventListener('submit', saveStoryNode);

            // Inisialisasi awal
            adminView.classList.remove('view-hidden');
            playerView.classList.add('view-hidden');
        }

        // --- PERUBAHAN: Proses Autentikasi Anonim ---
        // Gunakan IIFE (Immediately Invoked Function Expression) async
        (async () => {
            try {
                // Coba login secara anonim
                await signInAnonymously(auth);
                console.log("Pengguna berhasil login secara anonim:", auth.currentUser.uid);
                // Jika berhasil, jalankan logika aplikasi utama
                initializeAppLogic();
            } catch (error) {
                console.error("Gagal melakukan autentikasi anonim:", error);
                // Jika gagal, tampilkan pesan error permanen
                globalLoader.innerHTML = `<p class="text-red-600 font-semibold text-center">Gagal terhubung ke server.<br>Pastikan Autentikasi Anonim sudah diaktifkan di Firebase Console.</p>`;
            }
        })();

    </script>
</body>
</html>

