<!DOCTYPE html><html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayo Baca Cerita Ceria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #fefce8; /* yellow-50 */
        }
        #story-view { display: none; }
        .option-button {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .option-button:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6"><div class="max-w-3xl mx-auto">
    <!-- Tampilan Daftar Cerita -->
    <div id="story-list-view">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
             <h1 class="text-3xl sm:text-4xl font-bold text-yellow-800 flex items-center gap-3">
                <i class="fas fa-book-sparkles text-orange-500"></i>
                Pilih Petualanganmu
            </h1>
             <a href="dash-story.html" class="w-full sm:w-auto text-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full">
                <i class="fas fa-arrow-left mr-2"></i>Kembali
            </a>
        </div>
        <div id="story-list-container" class="space-y-4">
            <p class="text-center text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat daftar cerita...</p>
        </div>
    </div>

    <!-- Tampilan Cerita Individual -->
    <div id="story-view">
        <div class="bg-white/80 backdrop-blur-sm p-5 sm:p-8 rounded-3xl shadow-2xl border-4 border-white">
            <img id="story-image" src="" alt="Gambar Cerita" class="w-full h-48 sm:h-64 object-cover rounded-2xl mb-6 bg-gray-200 shadow-lg">
            <h2 id="story-node-title" class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2"></h2>
            <p id="story-author" class="text-sm text-gray-500 mb-4"></p>
            <p id="story-node-text" class="text-gray-700 text-lg leading-relaxed mb-8"></p>
            <div id="story-options" class="flex flex-col gap-3">
                <!-- Opsi akan ditambahkan di sini -->
            </div>
            <button id="back-to-list-btn" class="mt-8 w-full sm:w-auto text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full">
                <i class="fas fa-list-ul mr-2"></i>Kembali ke Daftar Cerita
            </button>
        </div>
    </div>
</div>

<script type="module">
    // --- KONFIGURASI WAJIB DIISI ---
    const firebaseConfig = { apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
    authDomain: "forumwidara.firebaseapp.com",
    projectId: "forumwidara",
    storageBucket: "forumwidara.firebasestorage.app",
    messagingSenderId: "216895655168",
    appId: "1:216895655168:web:59255f600fc3b3b44eb7e5" };
    // --------------------------------

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const storyListView = document.getElementById('story-list-view');
    const storyView = document.getElementById('story-view');
    const storyListContainer = document.getElementById('story-list-container');
    const storyImage = document.getElementById('story-image');
    const storyNodeTitle = document.getElementById('story-node-title');
    const storyNodeText = document.getElementById('story-node-text');
    const storyAuthor = document.getElementById('story-author');
    const storyOptions = document.getElementById('story-options');
    const backToListBtn = document.getElementById('back-to-list-btn');

    let currentStoryData = null;

    function renderNode(nodeId) {
        if (!currentStoryData || !currentStoryData.nodes[nodeId]) {
            storyNodeTitle.textContent = "Akhir Cerita";
            storyNodeText.textContent = "Petualanganmu telah berakhir di sini. Sampai jumpa di cerita lainnya!";
            storyImage.src = 'https://placehold.co/600x400/a7f3d0/166534?text=Tamat!';
            storyOptions.innerHTML = '';
            return;
        }

        const node = currentStoryData.nodes[nodeId];
        storyNodeTitle.textContent = node.title;
        storyNodeText.innerHTML = node.text.replace(/\n/g, '<br>');
        storyImage.src = node.imageUrl || 'https://placehold.co/600x400/e2e8f0/adb5bd?text=...';
        
        storyOptions.innerHTML = ''; 
        if (node.options && node.options.length > 0) {
            const colors = ['bg-sky-500', 'bg-emerald-500', 'bg-amber-500', 'bg-rose-500'];
            node.options.forEach((option, index) => {
                const color = colors[index % colors.length];
                const button = document.createElement('button');
                button.innerHTML = `<i class="fas fa-arrow-right mr-3"></i> ${option.text}`;
                button.className = `option-button w-full text-left ${color} text-white font-semibold py-3 px-5 rounded-xl text-lg`;
                button.onclick = () => renderNode(option.targetNodeId);
                storyOptions.appendChild(button);
            });
        } else {
            const endText = document.createElement('p');
            endText.innerHTML = '<i class="fas fa-flag-checkered mr-2"></i> -- Tamat --';
            endText.className = "text-center font-bold text-gray-500 mt-4 text-lg";
            storyOptions.appendChild(endText);
        }
    }

    async function loadStory(storyId) {
        const docRef = doc(db, "ceritaBercabang", storyId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            currentStoryData = docSnap.data();
            storyListView.style.display = 'none';
            storyView.style.display = 'block';
            renderNode(currentStoryData.startNodeId);

            // Ambil nama pembuat cerita
            storyAuthor.textContent = "";
            if (currentStoryData.createdBy) {
                const userRef = doc(db, "users", currentStoryData.createdBy);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    storyAuthor.textContent = `Dibuat oleh: ${userData.nama || "Pengguna Tanpa Nama"}`;
                } else {
                    storyAuthor.textContent = "Dibuat oleh: (User tidak ditemukan)";
                }
            }
        } else {
            alert("Cerita tidak ditemukan!");
        }
    }
    
    async function displayStoryList() {
        const querySnapshot = await getDocs(collection(db, "ceritaBercabang"));
        storyListContainer.innerHTML = '';
        if (querySnapshot.empty) {
            storyListContainer.innerHTML = '<p class="text-center bg-white p-4 rounded-xl shadow">Yah, belum ada cerita yang dibuat. Ayo buat yang pertama!</p>';
            return;
        }

        const icons = ['fa-dragon', 'fa-castle', 'fa-hat-wizard', 'fa-rocket', 'fa-ghost'];
        let iconIndex = 0;

        querySnapshot.forEach((doc) => {
            const story = doc.data();
            const storyCard = document.createElement('div');
            storyCard.className = 'bg-white p-5 rounded-2xl shadow-lg cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all flex items-center gap-4';
            storyCard.innerHTML = `
                <i class="fas ${icons[iconIndex % icons.length]} text-3xl text-white p-4 rounded-full bg-gradient-to-br from-purple-400 to-indigo-500"></i>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">${story.title}</h3>
                    <p class="text-sm text-gray-500">Ketuk untuk memulai petualangan!</p>
                </div>`;
            storyCard.onclick = () => loadStory(doc.id);
            storyListContainer.appendChild(storyCard);
            iconIndex++;
        });
    }

    backToListBtn.addEventListener('click', () => {
        storyView.style.display = 'none';
        storyListView.style.display = 'block';
        currentStoryData = null;
    });

    displayStoryList();
</script></body>
</html>
