<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Kelola Tantangan Mingguan - Komunitas Ceria 2SD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Baloo 2', sans-serif; margin: 0; background-color: #f4f6f8; color: #333; padding-bottom: 100px; }
        .container { max-width: 1000px; margin: 30px auto; padding: 20px; }
        .page-header h1 { font-size: 2.5rem; margin: 0; color: #4a5568; text-align: center; }
        .admin-container { display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; margin-top: 30px; }
        .form-section, .list-section { background-color: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; border-bottom: 3px solid #e2e8f0; padding-bottom: 10px; color: #2d3748; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 700; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #cbd5e0; box-sizing: border-box; font-size: 1rem; }
        .btn-submit { width: 100%; padding: 15px; border: none; background-color: #673ab7; color: white; font-size: 1.2rem; font-weight: 800; border-radius: 10px; cursor: pointer; border-bottom: 4px solid #512da8; }
        #tantangan-list { display: flex; flex-direction: column; gap: 15px; }
        .tantangan-card { display: flex; align-items: center; gap: 20px; background-color: #f7fafc; padding: 15px; border-radius: 10px; border: 2px solid #e2e8f0; justify-content: space-between; }
        .tantangan-card.active { border-left: 5px solid #48bb78; }
        .btn-deactivate { padding: 8px 12px; border: none; background-color: #f56565; color: white; font-weight: 700; border-radius: 8px; cursor: pointer; }
        .message { text-align: center; padding: 12px; border-radius: 8px; font-weight: 700; margin-top: 20px; display: none; }
        .message.success { background-color: #c6f6d5; color: #2f855a; }
        .message.error { background-color: #fed7d7; color: #c53030; }
        .tombol-beranda { position: fixed; bottom: 20px; right: 20px; background-color: #FFC107; color: #333; padding: 12px 20px; border-radius: 50px; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; font-weight: 700; text-decoration: none; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); z-index: 1000; }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header"><h1>Kelola Tantangan Mingguan üèÜ</h1></header>
        <div class="admin-container">
            <section class="form-section">
                <h2>Buat Tantangan Baru</h2>
                <form id="tantangan-form">
                    <div class="input-group">
                        <label for="tantangan-tema">Tema Tantangan</label>
                        <input type="text" id="tantangan-tema" placeholder="Contoh: Petualangan Angka" required>
                    </div>
                    <div class="input-group">
                        <label for="tantangan-kategori">Kategori Soal Tantangan</label>
                        <select id="tantangan-kategori" required>
                             <option value="">-- Pilih Kategori --</option>
                            <option value="matematika">Matematika</option>
                            <option value="bahasa_indonesia">Bahasa Indonesia</option>
                            <option value="bahasa_inggris">Bahasa Inggris</option>
                            <option value="ipa">Ilmu Pengetahuan Alam</option>
                             <option value="ips">Ilmu Sosial</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="lencana-hadiah">Pilih Lencana Hadiah</label>
                        <select id="lencana-hadiah" required></select>
                    </div>
                    <div class="input-group">
                        <label for="syarat-skor">Syarat Skor Minimum Lulus (%)</label>
                        <input type="number" id="syarat-skor" min="1" max="100" placeholder="Contoh: 80" required>
                    </div>
                    <button type="submit" class="btn-submit">Jadikan Tantangan Aktif</button>
                    <div id="message-box" class="message"></div>
                </form>
            </section>
            <section class="list-section">
                <h2>Riwayat Tantangan</h2>
                <div id="tantangan-list"><p>Memuat riwayat...</p></div>
            </section>
        </div>
    </div>
    <a href="index.html" class="tombol-beranda"><span>üè†</span><span>Beranda</span></a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.firebasestorage.app",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function loadLencanaDropdown() {
            const lencanaDropdown = document.getElementById('lencana-hadiah');
            const q = query(collection(db, "lencana"));
            const snapshot = await getDocs(q);
            lencanaDropdown.innerHTML = '<option value="">-- Pilih Lencana --</option>';
            snapshot.forEach(doc => {
                lencanaDropdown.innerHTML += `<option value="${doc.id}">${doc.data().nama}</option>`;
            });
        }

        async function loadTantangan() {
            const list = document.getElementById('tantangan-list');
            const q = query(collection(db, "tantanganMingguan"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            list.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const card = document.createElement('div');
                card.className = `tantangan-card ${data.aktif ? 'active' : ''}`;
                card.innerHTML = `
                    <div>
                        <h3>${data.tema}</h3>
                        <p>Kategori: ${data.kategori} | Status: ${data.aktif ? 'Aktif' : 'Selesai'}</p>
                    </div>
                    ${data.aktif ? `<button class="btn-deactivate" data-id="${doc.id}">Nonaktifkan</button>` : ''}
                `;
                list.appendChild(card);
            });
            document.querySelectorAll('.btn-deactivate').forEach(btn => btn.onclick = async e => {
                await updateDoc(doc(db, "tantanganMingguan", e.target.dataset.id), { aktif: false });
                loadTantangan();
            });
        }

        document.getElementById('tantangan-form').addEventListener('submit', async e => {
            e.preventDefault();
            try {
                const q = query(collection(db, "tantanganMingguan"), where("aktif", "==", true));
                const active = await getDocs(q);
                for (const docSnap of active.docs) {
                    await updateDoc(doc(db, "tantanganMingguan", docSnap.id), { aktif: false });
                }
                await addDoc(collection(db, "tantanganMingguan"), {
                    tema: document.getElementById('tantangan-tema').value,
                    kategori: document.getElementById('tantangan-kategori').value,
                    lencanaId: document.getElementById('lencana-hadiah').value,
                    syaratSkor: parseInt(document.getElementById('syarat-skor').value),
                    aktif: true,
                    createdAt: serverTimestamp()
                });
                showMessage('success', 'Tantangan baru berhasil diaktifkan!');
                e.target.reset();
                loadTantangan();
            } catch (error) {
                showMessage('error', 'Gagal menyimpan tantangan.');
            }
        });

        function showMessage(type, text) {
            const msgBox = document.getElementById('message-box');
            msgBox.className = `message ${type}`;
            msgBox.textContent = text;
            msgBox.style.display = 'block';
            setTimeout(() => msgBox.style.display = 'none', 4000);
        }

        loadLencanaDropdown();
        loadTantangan();
    </script>
</body>
</html>


