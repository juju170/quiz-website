<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Soal Kuis</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Poppins & Baloo 2 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F0F9FF;
        }
        .form-container {
            background: white;
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 2px solid #E0E7FF;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #D1D5DB;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #60A5FA;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
        }
        .label-text {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .btn-simpan {
            background: linear-gradient(135deg, #34D399, #10B981);
            color: white;
            font-weight: 700;
            padding: 16px;
            border-radius: 9999px;
            width: 100%;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4);
        }
        .btn-simpan:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 211, 153, 0.5);
        }
        /* Sembunyikan fieldset secara default */
        .question-type-fields {
            display: none;
        }
        .tombol-beranda {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #FFC107;
            color: #333;
            padding: 12px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Baloo 2', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 1000;
        }
        .tombol-beranda:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <header class="text-center mb-10">
            <h1 id="quiz-title-header" class="text-4xl md:text-5xl font-bold text-blue-600">Memuat Kuis... üöÄ</h1>
            <p class="text-gray-500 mt-2">Isi formulir di bawah untuk menambahkan soal baru ke dalam paket kuis ini.</p>
        </header>

        <main id="form-kuis" class="form-container mb-12">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Detail Soal Baru</h2>
            <form id="quizCreatorForm">
                <div class="input-group">
                    <label for="pertanyaan" class="label-text"><i data-lucide="help-circle"></i>Teks Pertanyaan / Instruksi</label>
                    <textarea id="pertanyaan" rows="3" class="input-field" placeholder="Tuliskan pertanyaan atau instruksi pengerjaan soal..."></textarea>
                </div>
                
                <div class="input-group">
                    <label for="tipe-soal" class="label-text"><i data-lucide="list-checks"></i>Tipe Soal</label>
                    <select id="tipe-soal" class="input-field bg-white">
                        <option value="pilihan-ganda">1. Pilihan Ganda</option>
                        <option value="esai">2. Esai</option>
                        <option value="susun-huruf">3. Susun Huruf</option>
                        <option value="pencocokkan">4. Pencocokkan</option>
                        <option value="benar-salah">5. Benar atau Salah</option>
                        <option value="susun-kalimat">6. Susun Kata Jadi Kalimat</option>
                        <option value="tts-mini">7. Teka-Teki Silang Mini</option>
                    </select>
                </div>

                <!-- === FORM SPESIFIK UNTUK SETIAP TIPE SOAL === -->
                <fieldset id="fields-pilihan-ganda" class="question-type-fields space-y-4">
                    <label class="label-text"><i data-lucide="list"></i>Opsi Jawaban & Penjelasan</label>
                    <div id="pg-options-container" class="space-y-4"></div>
                    <button type="button" id="add-pg-option-btn" class="text-sm text-blue-600 font-semibold flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4"></i>Tambah Opsi</button>
                </fieldset>
                <fieldset id="fields-esai" class="question-type-fields">
                     <div class="input-group">
                        <label for="esai-answer" class="label-text"><i data-lucide="key-round"></i>Kunci Jawaban Esai</label>
                        <textarea id="esai-answer" rows="3" class="input-field" placeholder="Tuliskan acuan jawaban benar untuk esai..."></textarea>
                    </div>
                </fieldset>
                <fieldset id="fields-susun-huruf" class="question-type-fields space-y-4">
                     <div class="input-group">
                        <label for="susun-huruf-answer" class="label-text"><i data-lucide="key-round"></i>Jawaban (Kata yang Benar)</label>
                        <input type="text" id="susun-huruf-answer" class="input-field" placeholder="Contoh: INDONESIA">
                    </div>
                    <div class="input-group">
                        <label for="susun-huruf-decoys" class="label-text"><i data-lucide="shuffle"></i>Huruf Pengecoh</label>
                        <input type="text" id="susun-huruf-decoys" class="input-field" placeholder="Ketik beberapa huruf tanpa spasi (Contoh: XYZ)">
                    </div>
                </fieldset>
                <fieldset id="fields-pencocokkan" class="question-type-fields space-y-4">
                    <label class="label-text"><i data-lucide="link-2"></i>Pasangan untuk Dicocokkan</label>
                    <div id="matching-pairs-container" class="space-y-3"></div>
                    <button type="button" id="add-matching-pair-btn" class="text-sm text-blue-600 font-semibold flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4"></i>Tambah Pasangan</button>
                </fieldset>
                <fieldset id="fields-benar-salah" class="question-type-fields space-y-4">
                    <label class="label-text"><i data-lucide="check-circle-2"></i>Pilih Jawaban yang Benar</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 p-3 border-2 border-gray-200 rounded-lg has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                            <input type="radio" name="bs-answer" value="Benar" class="h-4 w-4 text-blue-600">
                            <span>Benar</span>
                        </label>
                        <label class="flex items-center gap-2 p-3 border-2 border-gray-200 rounded-lg has-[:checked]:border-pink-500 has-[:checked]:bg-pink-50">
                            <input type="radio" name="bs-answer" value="Salah" class="h-4 w-4 text-pink-600">
                            <span>Salah</span>
                        </label>
                    </div>
                </fieldset>
                <fieldset id="fields-susun-kalimat" class="question-type-fields space-y-4">
                    <label class="label-text"><i data-lucide="key-round"></i>Kalimat Jawaban yang Benar</label>
                    <div id="sk-answers-container" class="space-y-3"></div>
                    <button type="button" id="add-sk-answer-btn" class="text-sm text-blue-600 font-semibold flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4"></i>Tambah Alternatif Jawaban Benar</button>
                </fieldset>
                <fieldset id="fields-tts-mini" class="question-type-fields grid md:grid-cols-2 gap-6">
                     <div class="input-group">
                        <label for="tts-mendatar" class="label-text"><i data-lucide="arrow-right"></i>Jawaban Mendatar</label>
                        <input type="text" id="tts-mendatar" class="input-field" placeholder="Contoh: APEL">
                    </div>
                     <div class="input-group">
                        <label for="tts-menurun" class="label-text"><i data-lucide="arrow-down"></i>Jawaban Menurun</label>
                        <input type="text" id="tts-menurun" class="input-field" placeholder="Contoh: EMBUN">
                    </div>
                </fieldset>
                
                <div class="mt-8">
                    <button type="submit" class="btn-simpan flex items-center justify-center gap-2">
                        <i data-lucide="plus-circle"></i>
                        Tambahkan Soal ke Paket
                    </button>
                </div>
            </form>
        </main>
    </div>

    <a href="paket-kuis.html" class="tombol-beranda" title="Kembali ke Manajemen Paket Kuis">
        <span>üè†</span>
        <span>Manajemen Kuis</span>
    </a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.appspot.com",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- AMBIL ID KUIS DARI URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const quizId = urlParams.get('quizId');
        let quizTitle = '';

        // --- ELEMEN DOM ---
        const form = document.getElementById('quizCreatorForm');
        const tipeSoalSelect = document.getElementById('tipe-soal');
        const quizTitleHeader = document.getElementById('quiz-title-header');
        const pgContainer = document.getElementById('pg-options-container');
        const matchingContainer = document.getElementById('matching-pairs-container');
        const skContainer = document.getElementById('sk-answers-container');
        
        if (!quizId) {
            alert("Paket kuis tidak ditemukan! Anda akan diarahkan kembali.");
            window.location.href = 'paket-kuis.html';
        }

        // --- FUNGSI-FUNGSI ---

        async function fetchQuizData() {
            const quizDocRef = doc(db, 'quizzes', quizId);
            try {
                const docSnap = await getDoc(quizDocRef);
                if (docSnap.exists()) {
                    quizTitle = docSnap.data().title;
                    quizTitleHeader.textContent = `üìù Kelola Soal: ${quizTitle}`;
                } else {
                    quizTitleHeader.textContent = "Paket Kuis Tidak Ditemukan";
                    form.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching quiz data: ", error);
                quizTitleHeader.textContent = "Gagal Memuat Kuis";
            }
        }
        
        function updateFormUI() {
            document.querySelectorAll('.question-type-fields').forEach(field => field.style.display = 'none');
            const activeFieldset = document.getElementById(`fields-${tipeSoalSelect.value}`);
            if (activeFieldset) {
                activeFieldset.style.display = 'block';
            }
        }

        let pgOptionCount = 0;
        function addPgOption(isCorrect = false) {
            if (pgOptionCount >= 5) return;
            pgOptionCount++;
            const div = document.createElement('div');
            div.className = 'p-3 border rounded-lg';
            div.innerHTML = `<div class="flex items-center gap-3 mb-2"><input type="radio" name="pg-correct-option" value="${pgOptionCount}" class="h-5 w-5 text-blue-600" ${isCorrect ? 'checked' : ''}><input type="text" class="input-field" name="pg-option-text" placeholder="Teks Opsi ${pgOptionCount}"><button type="button" class="remove-pg-option text-red-500 hover:text-red-700 font-bold text-2xl">&times;</button></div><textarea name="pg-option-explanation" class="input-field text-sm mt-2" rows="1" placeholder="Penjelasan untuk opsi ini"></textarea>`;
            pgContainer.appendChild(div);
            div.querySelector('.remove-pg-option').addEventListener('click', () => { div.remove(); pgOptionCount--; if (pgContainer.querySelectorAll('div').length === 1) pgContainer.querySelector('input[type="radio"]').checked = true; });
        }

        let matchingPairCount = 0;
        function addMatchingPair() {
            matchingPairCount++;
            const div = document.createElement('div');
            div.className = 'flex items-center gap-3';
            div.innerHTML = `<input type="text" class="input-field" name="matching-prompt" placeholder="Item Kiri ${matchingPairCount}"><span>=</span><input type="text" class="input-field" name="matching-match" placeholder="Item Kanan ${matchingPairCount}"><button type="button" class="remove-matching-pair text-red-500 hover:text-red-700 font-bold text-2xl">&times;</button>`;
            matchingContainer.appendChild(div);
            div.querySelector('.remove-matching-pair').addEventListener('click', () => { div.remove(); matchingPairCount--; });
        }

        let skAnswerCount = 0;
        function addSkAnswer() {
            skAnswerCount++;
            const div = document.createElement('div');
            div.className = 'flex items-center gap-3';
            div.innerHTML = `<input type="text" class="input-field" name="sk-answer" placeholder="Alternatif jawaban benar ${skAnswerCount}"><button type="button" class="remove-sk-answer text-red-500 hover:text-red-700 font-bold text-2xl">&times;</button>`;
            skContainer.appendChild(div);
            div.querySelector('.remove-sk-answer').addEventListener('click', () => { div.remove(); skAnswerCount--; });
        }
        
        async function saveQuestion(e) {
            e.preventDefault();
            const questionText = document.getElementById('pertanyaan').value.trim();
            const type = tipeSoalSelect.value;
            if (!questionText) {
                alert('Teks Pertanyaan/Instruksi wajib diisi!');
                return;
            }
            let questionData = { question: questionText, type: type };
            try {
                // (Logika switch case tidak diubah, sudah benar)
                switch (type) {
                    case 'pilihan-ganda':
                        const options = [];
                        const optionElements = pgContainer.querySelectorAll('div.p-3');
                        const correctRadio = pgContainer.querySelector('input[name="pg-correct-option"]:checked');
                        if (!correctRadio) throw new Error('Pilih salah satu jawaban yang benar!');
                        const correctValue = correctRadio.value;
                        optionElements.forEach((opt) => {
                            const radio = opt.querySelector('input[type="radio"]');
                            const textInput = opt.querySelector('input[name="pg-option-text"]');
                            const explanationInput = opt.querySelector('textarea[name="pg-option-explanation"]');
                            if (textInput.value.trim()) {
                                options.push({
                                    text: textInput.value.trim(),
                                    isCorrect: radio.value === correctValue,
                                    explanation: explanationInput.value.trim() || ''
                                });
                            }
                        });
                        if (options.length < 2) throw new Error('Pilihan ganda harus memiliki minimal 2 opsi.');
                        questionData.options = options;
                        break;
                    case 'esai':
                        const esaiAnswer = document.getElementById('esai-answer').value.trim();
                        if (!esaiAnswer) throw new Error('Kunci jawaban esai tidak boleh kosong.');
                        questionData.answer = esaiAnswer;
                        break;
                    case 'susun-huruf':
                        const answer = document.getElementById('susun-huruf-answer').value.trim().toUpperCase();
                        if (!answer) throw new Error('Jawaban susun huruf tidak boleh kosong.');
                        const decoysRaw = document.getElementById('susun-huruf-decoys').value.trim().toUpperCase();
                        questionData.answer = answer;
                        questionData.decoys = [...new Set(decoysRaw.split(''))];
                        break;
                    case 'pencocokkan':
                        const pairs = [];
                        const pairElements = matchingContainer.querySelectorAll('div.flex');
                        pairElements.forEach(pair => {
                            const prompt = pair.querySelector('input[name="matching-prompt"]').value.trim();
                            const match = pair.querySelector('input[name="matching-match"]').value.trim();
                            if (prompt && match) pairs.push({ prompt, match });
                        });
                        if (pairs.length < 2) throw new Error('Tipe Pencocokkan butuh minimal 2 pasang.');
                        questionData.matchingPairs = pairs;
                        break;
                    case 'benar-salah':
                        const bsAnswer = document.querySelector('input[name="bs-answer"]:checked');
                        if (!bsAnswer) throw new Error('Pilih jawaban Benar atau Salah!');
                        questionData.answer = bsAnswer.value === 'Benar';
                        break;
                    case 'susun-kalimat':
                        const correctAnswers = Array.from(skContainer.querySelectorAll('input[name="sk-answer"]'))
                                                    .map(input => input.value.trim())
                                                    .filter(Boolean);
                        if (correctAnswers.length === 0) throw new Error('Isi setidaknya satu kalimat jawaban!');
                        questionData.correctAnswers = correctAnswers;
                        questionData.words = correctAnswers[0].split(' ');
                        break;
                    case 'tts-mini':
                        const horizontal = document.getElementById('tts-mendatar').value.trim().toUpperCase();
                        const vertical = document.getElementById('tts-menurun').value.trim().toUpperCase();
                        if (!horizontal || !vertical) throw new Error('Isi jawaban mendatar dan menurun!');
                        if (![...horizontal].some(char => vertical.includes(char))) throw new Error('Jawaban harus memiliki huruf perpotongan.');
                        questionData.crossword = { horizontal, vertical };
                        break;
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
                return;
            }
            try {
                const questionsSubcollectionRef = collection(db, 'quizzes', quizId, 'questions');
                await addDoc(questionsSubcollectionRef, questionData);
                alert(`Soal berhasil ditambahkan ke paket kuis "${quizTitle}"!`);
                form.reset();
                pgContainer.innerHTML = ''; pgOptionCount = 0; addPgOption(true); addPgOption();
                matchingContainer.innerHTML = ''; matchingPairCount = 0; addMatchingPair(); addMatchingPair();
                skContainer.innerHTML = ''; skAnswerCount = 0; addSkAnswer();
                updateFormUI();
            } catch (error) {
                console.error("Error saving question: ", error);
                alert('Gagal menyimpan soal.');
            }
        }
        
        // --- INISIALISASI & EVENT LISTENERS ---

        // Listener untuk mengubah tampilan form berdasarkan tipe soal
        tipeSoalSelect.addEventListener('change', updateFormUI);
        
        // Listener untuk tombol submit
        form.addEventListener('submit', saveQuestion);
        
        // Listeners untuk tombol tambah/kurang dinamis
        document.getElementById('add-pg-option-btn').addEventListener('click', () => addPgOption());
        document.getElementById('add-matching-pair-btn').addEventListener('click', addMatchingPair);
        document.getElementById('add-sk-answer-btn').addEventListener('click', addSkAnswer);
            
        // Jalankan saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            fetchQuizData();
            lucide.createIcons();
            
            // Siapkan form dinamis dengan nilai default
            addPgOption(true); 
            addPgOption();
            addMatchingPair(); 
            addMatchingPair();
            addSkAnswer();
            
            // Tampilkan form yang benar saat pertama kali halaman dimuat
            updateFormUI();
        });
    </script>
</body>
</html>


