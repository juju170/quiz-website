<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kreator Cerita Ceria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #ecfdf5; /* green-50 */
        }
        .node-card { 
            transition: all 0.3s ease; 
            border-left-width: 8px;
        }
        /* Custom file input style */
        .custom-file-input::-webkit-file-upload-button { visibility: hidden; }
        .custom-file-input::before {
            content: 'Pilih Gambar';
            display: inline-block;
            background: #e0e7ff; /* indigo-100 */
            color: #3730a3; /* indigo-800 */
            border-radius: 9999px;
            padding: 8px 16px;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .custom-file-input:hover::before { background-color: #c7d2fe; }
    </style>
</head>
<body class="p-4 sm:p-6">

    <div class="max-w-4xl mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-green-700 flex items-center gap-3">
                <i class="fas fa-magic-wand-sparkles text-yellow-500"></i>
                Ayo Rangkai Ceritamu!
            </h1>
            <a href="dash-story.html" class="w-full sm:w-auto text-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full">
                <i class="fas fa-arrow-left mr-2"></i>Kembali
            </a>
        </div>
        
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8 border-t-8 border-yellow-300">
            <label for="story-title" class="text-xl font-semibold text-gray-700">Judul Utama Cerita</label>
            <input type="text" id="story-title" class="mt-2 w-full p-3 border-2 border-gray-200 rounded-lg text-lg focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400" placeholder="Petualangan Kue Pelangi">
        </div>

        <div id="nodes-container" class="space-y-6">
            <!-- Node cerita akan ditambahkan di sini -->
        </div>

        <div class="mt-8 flex flex-col sm:flex-row gap-4">
            <button id="add-node-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">
                <i class="fas fa-plus-circle mr-2"></i> Tambah Bagian Baru
            </button>
            <button id="save-story-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">
                <i class="fas fa-save mr-2"></i> Simpan Cerita
            </button>
        </div>
        <div id="status-message" class="mt-4 text-center font-semibold text-lg p-3 rounded-lg"></div>
    </div>

<script type="module">
    // --- KONFIGURASI WAJIB DIISI ---
    // SANGAT PENTING: Jangan masukkan kunci API langsung di sini.
    // Ganti dengan konfigurasi Anda.
    const firebaseConfig = { 
        apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
    authDomain: "forumwidara.firebaseapp.com",
    projectId: "forumwidara",
    storageBucket: "forumwidara.firebasestorage.app",
    messagingSenderId: "216895655168",
    appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
    };
    const cloudinaryCloudName = "dgqg7w1p3";
    const cloudinaryUploadPreset = "Unsigned_demo";
    // --------------------------------

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const nodesContainer = document.getElementById('nodes-container');
    const addNodeBtn = document.getElementById('add-node-btn');
    const saveStoryBtn = document.getElementById('save-story-btn');
    const storyTitleInput = document.getElementById('story-title');
    const statusMessage = document.getElementById('status-message');

    let storyData = { title: "", startNodeId: "start", nodes: {} };
    const createNodeId = () => `node-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    function renderEditor() {
        nodesContainer.innerHTML = ''; 
        const nodeIds = Object.keys(storyData.nodes);

        for (const nodeId of nodeIds) {
            const node = storyData.nodes[nodeId];
            const isStartNode = nodeId === storyData.startNodeId;
            
            const nodeElement = document.createElement('div');
            nodeElement.id = `editor-${nodeId}`;
            nodeElement.className = 'node-card bg-white p-5 rounded-2xl shadow-lg border-l-8';
            nodeElement.style.borderColor = isStartNode ? '#60a5fa' : '#d1d5db';

            let optionsDropdownHTML = `<option value="">-- Pilih Tujuan --</option>`;
            nodeIds.forEach(id => {
                if (id !== nodeId) {
                    optionsDropdownHTML += `<option value="${id}">${storyData.nodes[id].title || id}</option>`;
                }
            });

            let optionsHTML = node.options.map((option, index) => `
                <div class="flex flex-col sm:flex-row gap-2 items-center mt-2 border-t pt-3">
                    <input type="text" value="${option.text}" oninput="updateOptionText('${nodeId}', ${index}, this.value)" class="w-full sm:flex-1 p-2 border rounded-lg" placeholder="Teks Pilihan (Contoh: Lari ke kiri)">
                    <select onchange="updateOptionTarget('${nodeId}', ${index}, this.value)" class="w-full sm:w-auto p-2 border rounded-lg bg-white">
                        ${optionsDropdownHTML.replace(`value="${option.targetNodeId}"`, `value="${option.targetNodeId}" selected`)}
                    </select>
                    <button onclick="removeOption('${nodeId}', ${index})" class="w-full sm:w-auto bg-red-400 text-white px-3 py-2 rounded-lg hover:bg-red-500"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');

            nodeElement.innerHTML = `
                <div class="flex justify-between items-start gap-2">
                    <div>
                        <input type="text" value="${node.title}" oninput="updateNodeTitle('${nodeId}', this.value)" class="text-xl font-bold w-full p-1 -ml-1 rounded focus:bg-gray-100" placeholder="Judul Bagian Cerita">
                        ${isStartNode ? '<span class="text-xs font-bold text-blue-500 flex items-center gap-1"><i class="fas fa-star"></i> Titik Awal</span>' : ''}
                    </div>
                    <div class="flex-shrink-0 flex gap-2">
                        ${!isStartNode ? `<button onclick="setStartNode('${nodeId}')" title="Jadikan Titik Awal" class="text-sm bg-blue-100 text-blue-700 font-semibold py-1 px-2 rounded-full hover:bg-blue-200"><i class="fas fa-star"></i></button>` : ''}
                        <button onclick="removeNode('${nodeId}')" title="Hapus Bagian Ini" class="bg-red-400 hover:bg-red-500 text-white font-bold py-1 px-3 rounded-full">&times;</button>
                    </div>
                </div>
                <div class="mt-4 space-y-4">
                    <textarea oninput="updateNodeText('${nodeId}', this.value)" class="w-full p-2 border rounded-lg h-24" placeholder="Tulis ceritanya di sini...">${node.text}</textarea>
                    <div class="bg-gray-50 p-3 rounded-lg flex flex-col sm:flex-row items-center gap-4">
                        <input type="file" accept="image/*" onchange="previewImage('${nodeId}', this.files[0])" class="flex-1 text-sm custom-file-input">
                        <img id="preview-${nodeId}" src="${node.imageUrl || 'https://placehold.co/100x100/e2e8f0/adb5bd?text=Pilih'}" class="w-24 h-24 object-cover rounded-lg bg-gray-200 border-2 border-white shadow-sm">
                    </div>
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold flex items-center gap-2"><i class="fas fa-code-branch text-gray-500"></i> Pilihan Cabang:</h4>
                    <div id="options-for-${nodeId}">${optionsHTML}</div>
                    <button onclick="addOption('${nodeId}')" class="mt-3 text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-full">
                        <i class="fas fa-plus"></i> Tambah Pilihan
                    </button>
                </div>
            `;
            nodesContainer.appendChild(nodeElement);
        }
    }
    
    window.addNode=()=>{const o=createNodeId();storyData.nodes[o]={title:"",text:"",imageUrl:"",imageFile:null,options:[]},renderEditor()};window.removeNode=o=>{if(Object.keys(storyData.nodes).length<=1)return void alert("Harus ada minimal satu bagian cerita.");if(o===storyData.startNodeId)return void alert("Tidak bisa menghapus bagian awal cerita. Jadikan bagian lain sebagai awal terlebih dahulu.");delete storyData.nodes[o],Object.values(storyData.nodes).forEach(t=>{t.options=t.options.filter(t=>t.targetNodeId!==o)}),renderEditor()};window.setStartNode=o=>{storyData.startNodeId=o,renderEditor()};window.updateNodeTitle=(o,t)=>{storyData.nodes[o].title=t,renderEditor()};window.updateNodeText=(o,t)=>{storyData.nodes[o].text=t};window.previewImage=(o,t)=>{if(!t)return;storyData.nodes[o].imageFile=t;const e=document.getElementById(`preview-${o}`);e.src=URL.createObjectURL(t),storyData.nodes[o].imageUrl=e.src};window.addOption=o=>{storyData.nodes[o].options.push({text:"",targetNodeId:""}),renderEditor()};window.removeOption=(o,t)=>{storyData.nodes[o].options.splice(t,1),renderEditor()};window.updateOptionText=(o,t,e)=>{storyData.nodes[o].options[t].text=e};window.updateOptionTarget=(o,t,e)=>{storyData.nodes[o].options[t].targetNodeId=e};addNodeBtn.addEventListener("click",window.addNode);saveStoryBtn.addEventListener("click",async()=>{if(storyData.title=storyTitleInput.value.trim(),!storyData.title)return void alert("Judul utama cerita tidak boleh kosong!");saveStoryBtn.disabled=!0,saveStoryBtn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...',statusMessage.textContent="Mengunggah gambar dan data...",statusMessage.className="mt-4 text-center font-semibold text-lg p-3 rounded-lg bg-blue-100 text-blue-700";try{const o=Object.entries(storyData.nodes).filter(([o,t])=>t.imageFile).map(async([o,t])=>{const e=new FormData;e.append("file",t.imageFile),e.append("upload_preset",cloudinaryUploadPreset);const d=await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryCloudName}/image/upload`,{method:"POST",body:e}),n=await d.json();if(!d.ok)throw new Error(n.error.message);storyData.nodes[o].imageUrl=n.secure_url,delete storyData.nodes[o].imageFile});await Promise.all(o);const t=JSON.parse(JSON.stringify(storyData));Object.values(t.nodes).forEach(o=>delete o.imageFile),await addDoc(collection(db,"ceritaBercabang"),t),statusMessage.textContent="Hore! Cerita berhasil disimpan!",statusMessage.className="mt-4 text-center font-semibold text-lg p-3 rounded-lg bg-green-100 text-green-700",setTimeout(()=>{window.location.href="view-story.html"},2e3)}catch(o){console.error("Gagal menyimpan cerita: ",o),statusMessage.textContent=`Waduh, ada error: ${o.message}`,statusMessage.className="mt-4 text-center font-semibold text-lg p-3 rounded-lg bg-red-100 text-red-700"}finally{saveStoryBtn.disabled=!1,saveStoryBtn.innerHTML='<i class="fas fa-save mr-2"></i> Simpan Cerita'}});const startNodeId=storyData.startNodeId;storyData.nodes[startNodeId]={title:"Awal Cerita",text:"",imageUrl:"",imageFile:null,options:[]},renderEditor();

</script>
</body>
</html>

