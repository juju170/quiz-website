<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengerjaan Kuis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f8ff;
            --container-bg: #ffffff;
            --primary-blue: #5c9ced;
            --text-color: #4c4c4c;
            --shadow-color: rgba(92, 156, 237, 0.2);
            --green: #4CAF50;
            --red: #f44336;
            --orange: #ff9800;
        }

        body {
            font-family: 'Baloo 2', cursive;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 8px 25px var(--shadow-color);
        }
        
        h1, h2 {
            text-align: center;
            color: var(--primary-blue);
        }

        /* Tampilan Pengerjaan Kuis */
        #quiz-player-container { display: none; } /* Initially hidden */
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        #timer {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--orange);
        }
        #question-container {
            padding: 20px;
            background-color: #fafcff;
            border-radius: 15px;
            min-height: 200px;
        }
        .question-text { font-size: 1.2em; margin-bottom: 20px; }
        .options-container label {
            display: block;
            background-color: #f1f5f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .options-container label:hover { background-color: #e2e8f0; }
        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        /* Tampilan Hasil */
        #results-container {
            display: none;
            text-align: center;
        }
        .medal { font-size: 5em; }
        .score { font-size: 2em; margin: 10px 0; }

        /* Fallback message */
        #error-container {
            text-align: center;
            padding: 40px;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Tampilan 1: Pengerjaan Kuis (akan ditampilkan oleh JS) -->
        <div id="quiz-player-container">
            <div class="quiz-header">
                <h2 id="quiz-title-player">Memuat Kuis...</h2>
                <div id="timer">00:00</div>
            </div>
            <div id="question-container">
                <!-- Soal akan dirender oleh JavaScript di sini -->
            </div>
            <div class="quiz-navigation">
                <button id="prev-btn" class="btn">Sebelumnya</button>
                <button id="next-btn" class="btn">Berikutnya</button>
                <button id="finish-btn" class="btn" style="background-color: var(--orange);">Selesai</button>
            </div>
        </div>

        <!-- Tampilan 2: Hasil Kuis -->
        <div id="results-container">
            <h1>Hasil Kuis</h1>
            <div id="medal-display" class="medal"></div>
            <p id="score-display" class="score"></p>
            <p id="feedback-display"></p>
            <button onclick="window.location.href='daftar-tantangan.html'" class="btn">Kembali ke Daftar Tantangan</button>
        </div>

        <!-- Tampilan 3: Error atau Loading -->
        <div id="error-container">
            <h1>Memuat...</h1>
            <p>Harap tunggu sebentar.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.appspot.com",
            messagingSenderId: "216895655168",
            appId: "1:216895655168:web:59255f600fc3b3b44eb7e5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State Global
        let currentQuizData = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval;
        const currentUserId = "user_demo_123"; // Simulasi ID pengguna

        // Elemen DOM
        const playerContainer = document.getElementById('quiz-player-container');
        const resultsContainer = document.getElementById('results-container');
        const errorContainer = document.getElementById('error-container');
        const questionContainer = document.getElementById('question-container');

        // Fungsi untuk memulai sebuah kuis
        async function startQuiz(quizId) {
            try {
                const docRef = doc(db, "kuis", quizId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    currentQuizData = docSnap.data();
                    userAnswers = new Array(currentQuizData.questions.length).fill(null);
                    currentQuestionIndex = 0;
                    
                    errorContainer.style.display = 'none';
                    playerContainer.style.display = 'block';
                    
                    document.getElementById('quiz-title-player').textContent = currentQuizData.title;
                    renderQuestion();
                    startTimer(currentQuizData.timerInMinutes);
                } else {
                    showError("Oops! Kuis tidak ditemukan. Mungkin sudah dihapus.");
                }
            } catch (error) {
                console.error("Error starting quiz:", error);
                showError("Terjadi kesalahan saat memuat kuis.");
            }
        }
        
        function showError(message) {
            playerContainer.style.display = 'none';
            resultsContainer.style.display = 'none';
            errorContainer.innerHTML = `<h1>Error</h1><p>${message}</p><a href="daftar-tantangan.html">Kembali</a>`;
            errorContainer.style.display = 'block';
        }

        // --- (Salin semua fungsi lain dari main-kuis.html yang lama ke sini) ---
        // renderQuestion, updateNavButtons, saveAnswer, startTimer, finishQuiz, showResults, awardBadge

        function renderQuestion() {
            const question = currentQuizData.questions[currentQuestionIndex];
            let html = `<div class="question-text">${currentQuestionIndex + 1}. ${question.questionText}</div>`;
            html += `<div class="options-container">`;

            if (question.type === 'pilihan-ganda') {
                question.options.forEach((opt, index) => {
                    const isChecked = userAnswers[currentQuestionIndex] === index ? 'checked' : '';
                    html += `<label><input type="radio" name="option" value="${index}" ${isChecked}> ${opt.text}</label>`;
                });
            } else if (question.type === 'esai') {
                const answer = userAnswers[currentQuestionIndex] || '';
                html += `<textarea rows="5" style="width: 100%;" placeholder="Ketik jawabanmu...">${answer}</textarea>`;
            }
            // Tambahkan render untuk tipe soal lain jika ada

            html += `</div>`;
            questionContainer.innerHTML = html;
            updateNavButtons();
        }

        function updateNavButtons() {
            document.getElementById('prev-btn').style.visibility = currentQuestionIndex === 0 ? 'hidden' : 'visible';
            document.getElementById('next-btn').style.visibility = currentQuestionIndex === currentQuizData.questions.length - 1 ? 'hidden' : 'visible';
        }

        function saveAnswer() {
            const question = currentQuizData.questions[currentQuestionIndex];
            if (question.type === 'pilihan-ganda') {
                const selected = document.querySelector('input[name="option"]:checked');
                if (selected) userAnswers[currentQuestionIndex] = parseInt(selected.value, 10);
            } else if (question.type === 'esai') {
                const textarea = questionContainer.querySelector('textarea');
                if (textarea) userAnswers[currentQuestionIndex] = textarea.value;
            }
        }
        
        function startTimer(minutes) {
            let seconds = minutes * 60;
            const timerEl = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const min = Math.floor(seconds / 60);
                const sec = seconds % 60;
                timerEl.textContent = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                seconds--;
                if (seconds < 0) {
                    clearInterval(timerInterval);
                    alert("Waktu habis!");
                    finishQuiz();
                }
            }, 1000);
        }

        async function finishQuiz() {
            clearInterval(timerInterval);
            saveAnswer(); 
            
            let score = 0;
            const scorableQuestions = currentQuizData.questions.filter(q => q.type === 'pilihan-ganda');
            scorableQuestions.forEach((q, index) => {
                const originalIndex = currentQuizData.questions.indexOf(q);
                if (q.options) {
                    const correctOptionIndex = q.options.findIndex(opt => opt.isCorrect);
                    if (userAnswers[originalIndex] === correctOptionIndex) {
                        score++;
                    }
                }
            });

            const finalScore = scorableQuestions.length > 0 ? (score / scorableQuestions.length) * 100 : 0;
            
            await showResults(finalScore);
        }

        async function showResults(score) {
            playerContainer.style.display = 'none';
            resultsContainer.style.display = 'block';

            const thresholds = currentQuizData.scoreThresholds;
            let medal = 'ðŸ‘Ž';
            let feedback = "Coba lagi, ya! Semangat!";
            let isEligibleForBadge = (score >= thresholds.bronze);

            if (score >= thresholds.gold) {
                medal = 'ðŸ¥‡';
                feedback = "Luar biasa! Kamu mendapatkan medali emas!";
            } else if (score >= thresholds.silver) {
                medal = 'ðŸ¥ˆ';
                feedback = "Hebat! Kamu mendapatkan medali perak!";
            } else if (score >= thresholds.bronze) {
                medal = 'ðŸ¥‰';
                feedback = "Bagus! Kamu mendapatkan medali perunggu!";
            }

            document.getElementById('medal-display').textContent = medal;
            document.getElementById('score-display').textContent = `Skor Kamu: ${Math.round(score)}%`;
            document.getElementById('feedback-display').textContent = feedback;

            if (isEligibleForBadge && currentQuizData.badgeToAwardId) {
                await awardBadge(currentUserId, currentQuizData.badgeToAwardId);
                document.getElementById('feedback-display').textContent += "\nSelamat! Lencana baru telah ditambahkan ke profilmu!";
            }
        }

        async function awardBadge(userId, badgeId) {
           try {
                const badgeRef = doc(db, "badges", badgeId);
                const badgeSnap = await getDoc(badgeRef);

                if (!badgeSnap.exists()) { console.error("Lencana tidak ditemukan:", badgeId); return; }
                
                const badgeData = badgeSnap.data();
                await addDoc(collection(db, "user_badges"), {
                    userId: userId,
                    badgeId: badgeId,
                    name: badgeData.name,
                    imageUrl: badgeData.imageUrl,
                    awardedAt: serverTimestamp()
                });
                console.log("Lencana berhasil diberikan:", userId);
            } catch (error) {
                console.error("Gagal memberikan lencana:", error);
            }
        }
        
        // --- LOGIKA UTAMA SAAT HALAMAN DIMUAT ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const quizIdFromUrl = urlParams.get('quizId');

            if (quizIdFromUrl) {
                startQuiz(quizIdFromUrl);
            } else {
                showError("Tidak ada tantangan yang dipilih. Silakan kembali ke halaman daftar tantangan.");
            }
        });
        
        // Event Listeners Navigasi Kuis
        document.getElementById('next-btn').addEventListener('click', () => {
            saveAnswer();
            if (currentQuestionIndex < currentQuizData.questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        });

        document.getElementById('prev-btn').addEventListener('click', () => {
            saveAnswer();
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        });
        
        document.getElementById('finish-btn').addEventListener('click', finishQuiz);

    </script>
</body>
</html>

